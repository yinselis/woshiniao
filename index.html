<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>AI OS V29 - IndexedDB Upgrade</title>
<!-- å¼•å…¥ Dexie.js ç”¨äºæ•°æ®åº“ç®¡ç† -->
<script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Zeyada&family=Noto+Serif+SC:wght@500;700&family=Long+Cang&family=Liu+Jian+Mao+Cao&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
<style>
/* === æ–°å¢ï¼šè‡ªå®šä¹‰å£çº¸é¢„è§ˆ === */
    .wp-preview {
        width: 100%; height: 150px; 
        border-radius: 12px; 
        border: 2px dashed #ccc; 
        display: flex; align-items: center; justify-content: center;
        background-size: cover; background-position: center;
        margin-bottom: 10px; color: #999;
    }

    /* === æ–°å¢ï¼šæ¼‚æµç“¶ (Drift Bottle) === */
    .bottle-sea {
        width: 100%; height: 100%;
        background: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%);
        position: relative; overflow: hidden;
    }
    .bottle-wave {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
        background: rgba(255,255,255,0.3);
        border-radius: 50% 50% 0 0 / 100% 100% 0 0;
        transform: scaleX(1.5);
    }
    .bottle-item {
        width: 60px; height: 60px;
        position: absolute;
        font-size: 40px;
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
        cursor: pointer;
        animation: bob 3s infinite ease-in-out;
        display: flex; flex-direction: column; align-items: center;
    }
    .bottle-name { font-size: 10px; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 6px; border-radius: 10px; margin-top: -5px; white-space: nowrap; }
    @keyframes bob { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
    
    .char-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .char-option { padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
    .char-option.selected { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }
    
    /* === åŸºç¡€å˜é‡ === */
    :root {
        --bg-color: #fdfbf7;
        --bg-image: linear-gradient(180deg, #fdfbf7 0%, #fff8e1 100%);
        --text-color: #594a2a;
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: rgba(255, 255, 255, 0.6);
        --icon-bg: rgba(255, 255, 255, 0.8);
        --icon-border: rgba(255, 255, 255, 0.6);
        --icon-color: #333;
        --accent-color: #eebb4d;
        --accent-text: #fff;
        --card-bg: rgba(255,255,255,0.8);
        --shadow: 0 8px 20px rgba(238, 187, 77, 0.1);
        --input-bg: rgba(255,255,255,0.8);
        --input-border: rgba(0,0,0,0.1);
        --sticky-color: #fff740;
        --dot-active: #eebb4d;
        --dot-inactive: #e0e0e0;
        --modal-radius: 24px;
        --paper-texture: #fffdf0;
        --scrap-border: 2px solid #4a4a4a;
        --vinyl-inner: #222;
        --btn-danger: #ff3b30;
    }
   
       /* === RPG & On This Day æ–°å¢æ ·å¼ === */
    .xp-toast { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #ffd700; padding: 8px 16px; border-radius: 20px; font-weight: bold; z-index: 3000; pointer-events: none; animation: floatUp 1.5s forwards; font-size: 14px; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 10px); } 20% { opacity: 1; transform: translate(-50%, 0); } 80% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
    
    .otd-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: left; border: 1px solid rgba(0,0,0,0.05); position: relative; overflow: hidden; }
    .otd-ribbon { position: absolute; top: 15px; right: -30px; background: #ff5e78; color: #fff; width: 100px; text-align: center; transform: rotate(45deg); font-size: 10px; padding: 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .otd-date { font-size: 32px; font-weight: bold; color: var(--accent-color); font-family: 'Noto Serif SC', serif; line-height: 1; margin-bottom: 5px; }
    .otd-year-tag { display: inline-block; background: #f0f0f0; color: #555; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 15px; }
    .otd-content { font-size: 15px; line-height: 1.6; color: #444; max-height: 150px; overflow-y: auto; font-style: italic; }
    
        /* RPG ç­‰çº§èƒ¶å›Šæ ·å¼ (æ”¾åœ¨é¦–é¡µå°é¢å›¾ä¸Š) */
    .rpg-pill { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,0.25); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .rpg-bar-bg { width: 40px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px; overflow: hidden; }
    .rpg-bar-fill { height: 100%; background: #ffd700; width: 0%; transition: width 0.5s; }
    
        /* === æ–°å¢åŠŸèƒ½æ ·å¼ (V30) === */
    /* ç”µå­æœ¨é±¼ */
    .wooden-fish-widget { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .wooden-fish-icon { font-size: 60px; transition: transform 0.1s; cursor: pointer; user-select: none; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
    .wooden-fish-icon:active { transform: scale(0.95) translateY(2px); }
    .merit-popup { position: absolute; font-family: 'Ma Shan Zheng'; color: var(--accent-color); font-size: 20px; font-weight: bold; pointer-events: none; animation: floatUp 1s ease-out forwards; top: 40%; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }
    
        /* å¿ƒæƒ…åƒç´ å¢™ */
    .pixel-wall-container { width: 100%; height: 100%; padding: 10px; display: flex; flex-direction: column; }
    .pixel-grid { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 3px; flex: 1; overflow-x: auto; padding-bottom: 5px; }
    .pixel-cell { width: 12px; height: 12px; background: rgba(0,0,0,0.05); border-radius: 2px; }
    .pixel-legend { display: flex; gap: 10px; font-size: 10px; margin-top: 5px; opacity: 0.7; justify-content: flex-end; }
    
    /* === ä¸»é¢˜å®šä¹‰ === */
    /* === æ–°å¢ï¼šiOS ç£¨ç ‚ç»ç’ƒ (äº®è‰²) === */
    body.theme-ios-light {
        /* ä½¿ç”¨ä¸€å¼  iOS é£æ ¼çš„é«˜æ–¯æ¨¡ç³Šå£çº¸ä½œä¸ºé»˜è®¤ */
        --bg-color: #f2f2f7;
        --bg-image: url('https://images.unsplash.com/photo-1621768216002-5ac171876625?q=80&w=2074&auto=format&fit=crop'); 
        --text-color: #000000;
        --glass-bg: rgba(255, 255, 255, 0.45); /* æåº¦é€šé€çš„ç™½ */
        --glass-border: rgba(255, 255, 255, 0.5);
        --card-bg: rgba(255, 255, 255, 0.55);
        --icon-bg: rgba(255, 255, 255, 0.6);
        --accent-color: #007aff; /* iOS Blue */
        --accent-text: #fff;
        --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); /* ç»ç’ƒæ‹Ÿæ€é˜´å½± */
        --modal-radius: 32px;
        --icon-border: rgba(255,255,255,0.2);
    }
    /* å¢å¼º iOS ä¸»é¢˜ä¸‹çš„æ¯›ç»ç’ƒæ•ˆæœ */
    body.theme-ios-light .glass, 
    body.theme-ios-light .mix-app-wide, 
    body.theme-ios-light .modal-card,
    body.theme-ios-light .status-bar,
    body.theme-ios-light .header {
        backdrop-filter: blur(25px) saturate(180%);
        -webkit-backdrop-filter: blur(25px) saturate(180%);
    }

    /* === æ–°å¢ï¼šiOS ç£¨ç ‚ç»ç’ƒ (æ·±è‰²) === */
    body.theme-ios-dark {
        --bg-color: #000000;
        --bg-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop');
        --text-color: #ffffff;
        --glass-bg: rgba(30, 30, 30, 0.5); /* é€šé€çš„é»‘ */
        --glass-border: rgba(255, 255, 255, 0.15);
        --card-bg: rgba(40, 40, 40, 0.6);
        --icon-bg: rgba(50, 50, 50, 0.5);
        --accent-color: #0a84ff;
        --accent-text: #fff;
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        --modal-radius: 32px;
        --icon-border: rgba(255,255,255,0.1);
        --input-bg: rgba(0,0,0,0.3);
    }
    body.theme-ios-dark .glass, 
    body.theme-ios-dark .mix-app-wide, 
    body.theme-ios-dark .modal-card,
    body.theme-ios-dark .header {
        backdrop-filter: blur(25px) saturate(180%);
        -webkit-backdrop-filter: blur(25px) saturate(180%);
        color: white;
    }

    /* === æ–°å¢ï¼šè‡ªå®šä¹‰ä¸»é¢˜ (é€»è¾‘ç”±JSæ§åˆ¶) === */
    body.theme-custom {
        --bg-color: #333;
        --bg-image: none; /* å°†ç”± JS åŠ¨æ€æ³¨å…¥ */
        --glass-bg: rgba(255,255,255, 0.7);
        --backdrop: blur(20px);
    }

    /* è‡ªå®šä¹‰å›¾æ ‡çš„æ ·å¼ */
    .custom-app-icon-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 16px; /* å›¾æ ‡åœ†è§’ */
    }
    body.theme-strawberry { --bg-color: #fff0f5; --bg-image: linear-gradient(180deg, #fff0f5 0%, #ffe4e1 100%); --accent-color: #ff5e78; --sticky-color: #ffcdd2; --shadow: 0 8px 20px rgba(255, 94, 120, 0.15); }
    body.theme-matcha { --bg-color: #f1f8e9; --bg-image: linear-gradient(180deg, #f1f8e9 0%, #dcedc8 100%); --accent-color: #7cb342; --sticky-color: #f0f4c3; --shadow: 0 8px 20px rgba(124, 179, 66, 0.15); }
    body.theme-ocean { --bg-color: #e3f2fd; --bg-image: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%); --accent-color: #42a5f5; --sticky-color: #b3e5fc; --shadow: 0 8px 20px rgba(66, 165, 245, 0.15); }
    body.theme-night { --bg-color: #121212; --bg-image: none; --text-color: #c9d1d9; --card-bg: #1e1e1e; --input-bg: #2c2c2e; --accent-color: #d4a746; --glass-bg: rgba(30,30,30,0.8); --glass-border: rgba(255,255,255,0.08); --paper-texture: #1e1e1e; --scrap-border: 2px solid #555; --icon-bg: #252525; --icon-border: rgba(255,255,255,0.1); --icon-color: #e0e0e0; --shadow: 0 10px 30px rgba(0,0,0,0.5); --sticky-color: #2c2c2e; --vinyl-inner: #111; --modal-radius: 24px; --btn-danger: #cf6679; }
    
    body.theme-apple { 
        --bg-color: #fbfbfd; 
        --bg-image: radial-gradient(circle at top left, #fff0f0 0%, #fbfbfd 60%);
        --text-color: #1d1d1f;
        --accent-color: #ff3b30;
        --card-bg: #ffffff;
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        --icon-bg: #ffffff;
        --icon-border: rgba(0,0,0,0.1);
        --sticky-color: #fff;
        --scrap-border: 2px dashed #ff3b30;
        --input-bg: #f5f5f7;
        --modal-radius: 18px;
    }
    body.theme-apple .mix-app-wide, body.theme-apple .scrapbook-card { border-style: dashed !important; border-width: 2px !important; }
    
    body.theme-pure {
        --bg-color: #ffffff;
        --bg-image: none;
        --text-color: #000000;
        --accent-color: #333333;
        --card-bg: #ffffff;
        --glass-bg: rgba(255,255,255,1);
        --glass-border: #eeeeee;
        --shadow: 0 2px 8px rgba(0,0,0,0.03);
        --icon-bg: #f5f5f5;
        --icon-border: transparent;
        --input-bg: #fafafa;
        --sticky-color: #f5f5f5;
    }

    /* é€šç”¨æ ·å¼ */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: var(--bg-color); background-image: var(--bg-image); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--text-color); display: flex; justify-content: center; transition: background 0.5s, color 0.3s; }
    #phone-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; z-index: 1; }
    @media (min-width: 500px) { body { align-items: center; background: #222; } #phone-container { width: 390px; height: 844px; background: var(--bg-color); background-image: var(--bg-image); border-radius: 45px; box-shadow: 0 0 0 10px #111, 0 30px 80px rgba(0,0,0,0.6); } }
    
.glass { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: var(--shadow); }
.status-bar { height: 48px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 25px 8px; font-weight: 600; font-size: 15px; z-index: 100; pointer-events: none; }
/* === æ‰¾åˆ°åŸæ¥çš„ .scroll-wrapper æ›¿æ¢ä¸ºè¿™ä¸ª === */
.scroll-wrapper {
    flex: 1;
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¿ç•™ mandatoryï¼Œä½†é…åˆä¸‹é¢çš„ always ä½¿ç”¨ */
    scroll-snap-type: x mandatory; 
    scrollbar-width: none;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å¹³æ»‘æ»šåŠ¨å±æ€§ */
    scroll-behavior: smooth; 
    /* iOS æƒ¯æ€§æ»šåŠ¨ä¼˜åŒ– */
    -webkit-overflow-scrolling: touch; 
    /* æ€§èƒ½ä¼˜åŒ–ï¼šé˜²æ­¢æ»‘åŠ¨æ—¶é‡ç»˜å¯¼è‡´çš„é—ªçƒ */
    will-change: scroll-position; 
}

/* === æ‰¾åˆ°åŸæ¥çš„ .page æ›¿æ¢ä¸ºè¿™ä¸ª === */
.page {
    min-width: 100%;
    height: 100%;
    padding: 10px 20px 80px 20px;
    overflow-y: auto;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå¯¹é½æ–¹å¼ä¸å˜ */
    scroll-snap-align: start; 
    /* ğŸ’¥ é‡ç‚¹ä¿®æ”¹ï¼šå¼ºåˆ¶æ¯æ¬¡åªæ»‘ä¸€é¡µï¼Œè§£å†³â€œå¤ªå¿«â€çš„é—®é¢˜ */
    scroll-snap-stop: always; 
    display: flex;
    flex-direction: column;
    gap: 12px;
    /* æ€§èƒ½ä¼˜åŒ–ï¼šè®©é¡µé¢å†…å®¹å±‚çº§ç‹¬ç«‹ï¼Œå‡å°‘æ¸²æŸ“é—ªçƒ */
    transform: translateZ(0); 
    backface-visibility: hidden;
}


/* è‰ºæœ¯æ··æ’å¸ƒå±€ */
.mix-grid { display: flex; flex-wrap: wrap; gap: 12px; width: 100%; align-content: flex-start; padding-top: 10px; }
.mix-app, .mix-app-wide, .widget-photo, .widget-countdown, .box-widget, .scrapbook-card, .widget-large { transition: transform 0.2s; position: relative; }
.mix-grid > *:nth-child(2n) { transform: rotate(1deg); }
.mix-grid > *:nth-child(3n) { transform: rotate(-1.5deg); }
.mix-grid > *:nth-child(4n) { transform: rotate(0.5deg); }
.mix-grid > *:nth-child(5n) { transform: rotate(-1deg); }
.mix-app:active, .mix-app-wide:active, .widget-photo:active { transform: scale(0.96) rotate(0deg) !important; }

.mix-app { width: calc(25% - 9px); display: flex; flex-direction: column; align-items: center; cursor: pointer; margin-bottom: 5px; }
.mix-app-wide { width: calc(50% - 6px); display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--glass-bg); border-radius: 20px 24px 18px 22px; padding: 10px; border: 1px solid var(--glass-border); box-shadow: var(--shadow); cursor: pointer; height: 70px; }
.icon-box { width: 58px; height: 58px; border-radius: 18px; background: var(--icon-bg); border: 1px solid var(--icon-border); color: var(--icon-color); display: flex; justify-content: center; align-items: center; font-size: 26px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); transition: 0.2s; position: relative; overflow: hidden; }
.icon-box:active { transform: scale(0.92); }
.app-name { font-size: 11px; margin-top: 6px; font-weight: 500; opacity: 0.9; text-align: center; }

/* ç»„ä»¶æ ·å¼ */
.widget-photo { width: 100%; height: 190px; border-radius: 28px 24px 28px 28px; position: relative; overflow: hidden; background-size: cover; background-position: center; transition: 0.3s; box-shadow: var(--shadow); margin-bottom: 5px; }
.his-status-pill { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.5); color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 11px; backdrop-filter: blur(4px); }
.widget-countdown { width: calc(50% - 6px); height: 110px; border-radius: 24px 20px 24px 22px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; background: var(--glass-bg); border: 1px solid var(--glass-border); box-shadow: var(--shadow); }
.cd-days { font-size: 32px; font-weight: bold; color: var(--accent-color); line-height: 1; margin-bottom: 2px; }
.scrapbook-card { width: 100%; background: var(--paper-texture); border: var(--scrap-border); border-radius: 4px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); position: relative; font-family: 'Ma Shan Zheng', cursive; margin-bottom: 5px; }
.tape { position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(-1deg); width: 60px; height: 20px; background: rgba(255,255,255,0.4); border-left: 1px dashed rgba(0,0,0,0.1); border-right: 1px dashed rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 5; pointer-events: none; backdrop-filter: blur(2px); }
.doodle-widget { height: 160px; z-index: 1; }
.doodle-canvas { width: 100%; height: 100%; touch-action: none; cursor: crosshair; background-image: radial-gradient(rgba(0,0,0,0.1) 1px, transparent 1px); background-size: 20px 20px; z-index: 2; }
.doodle-tools { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 5px; z-index: 10; }
.box-widget { flex: 1; border-radius: 20px 22px 20px 24px; background: var(--glass-bg); border: 1px solid var(--glass-border); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; box-shadow: var(--shadow); cursor: pointer; overflow: hidden; height: 120px; }
.divination-box { background: #333; color: #f0c268; border: 2px solid #f0c268; }
.widget-large { width: calc(50% - 6px); height: 160px; border-radius: 20px 22px 18px 20px; background: var(--paper-texture); border: 1px solid rgba(0,0,0,0.1); padding: 12px; display: flex; flex-direction: column; box-shadow: var(--shadow); overflow: hidden; margin-bottom: 5px; }
.mood-box-inner { flex: 1; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); height: 85px; width: 100%; }
.todo-list-bento { flex: 1; overflow-y: auto; font-size: 12px; margin-top: 5px; }
.todo-item-desk { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; color: var(--text-color); }
.fridge-container { position: relative; margin-top: 10px; padding: 0 5px; width: 100%; flex-shrink: 0; }
.fridge-memo { width: 100%; min-height: 100px; background: var(--sticky-color); border-radius: 4px; padding: 20px; font-family: 'Ma Shan Zheng', cursive; font-size: 20px; color: #555; border: none; box-shadow: 2px 4px 10px rgba(0,0,0,0.1); resize: none; line-height: 1.6; }
.fridge-pin { width: 14px; height: 14px; background: #ff5e78; border-radius: 50%; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }

/* Views & Modals */
.view-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; display: none; flex-direction: column; animation: appOpen 0.3s; }
.view-overlay.active { display: flex; }
@keyframes appOpen { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.header { height: 52px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 18px; font-weight: 600; flex-shrink: 0; background: var(--glass-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); color: var(--text-color); }
.btn-icon { background: none; border: none; font-size: 22px; color: var(--text-color); padding: 10px; cursor: pointer; }
.modal { position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 2000; animation: fadeIn 0.2s; }
.modal-card { width: 75%; background: rgba(255,255,255,0.95); backdrop-filter: blur(25px); padding: 25px; border-radius: var(--modal-radius); box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 80%; overflow-y: auto; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; gap: 15px; color: #333; }
body.theme-night .modal-card { background: #2c2c2e; color: #fff; border: 1px solid #444; }
.setting-input { width: 100%; background: var(--input-bg); border: none; color: var(--text-color); padding: 12px; border-radius: 10px; font-size: 14px; outline: none; transition: 0.2s; text-align: left; }
select.setting-input { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px auto; padding-right: 30px; }
.btn-group { display: flex; gap: 10px; margin-top: 5px; }
.btn-normal { flex:1; padding: 12px; border-radius: 12px; border: none; font-size: 15px; cursor: pointer; background: var(--accent-color); color: var(--accent-text); font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; }
.btn-secondary { background: #e5e5ea; color: #000; box-shadow: none; }
.btn-danger { background: var(--btn-danger); color: #fff; }
.btn-small { padding: 6px 12px; font-size: 12px; border-radius: 8px; border: none; cursor: pointer; background: var(--glass-bg); border: 1px solid var(--glass-border); margin-top: 5px; }
    
        /* Module Specific */
    .journal-shelf { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
    .journal-book { aspect-ratio: 3/4; background: #fff; border-radius: 8px 12px 12px 8px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; border-left: 10px solid var(--accent-color); overflow: hidden; transition: 0.2s; color: #333; }
    .journal-wrapper { flex: 1; position: relative; overflow: hidden; background-color: #fff; background-size: cover; }
    .journal-drawer-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: var(--glass-bg); backdrop-filter: blur(30px); border-radius: 30px 30px 0 0; z-index: 500; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
    .journal-drawer-overlay.active { transform: translateY(0); }
    .drawer-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .drawer-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px; }
    .drawer-tab { padding: 8px 16px; border-radius: 20px; background: rgba(0,0,0,0.05); font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .drawer-tab.active { background: var(--accent-color); color: #fff; }
    .drawer-content { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .asset-item { aspect-ratio: 1; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; background: #fff; cursor: pointer; font-size: 12px; text-align: center; overflow: hidden; }
    .asset-item:active { transform: scale(0.9); }
    .draggable-item { position: absolute; cursor: move; user-select: none; display: inline-block; padding: 5px; border: 1px dashed transparent; transition: border 0.2s; }
    .draggable-item.active { border: 1px dashed var(--accent-color); z-index: 1000; }
    .draggable-item img { display: block; width: 100%; height: auto; pointer-events: none; }
    .text-box-content { min-width: 100px; min-height: 40px; color: #333; font-size: 16px; line-height: 1.5; outline: none; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 4px; cursor: text; }
    .drag-handle { position: absolute; top: -25px; left: 0; width: 30px; height: 20px; background: var(--accent-color); color: #fff; border-radius: 4px 4px 0 0; display: none; align-items: center; justify-content: center; font-size: 12px; cursor: move; z-index: 1001; }
    .draggable-item.active .drag-handle { display: flex; }
    .delete-btn { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background: #ff3b30; color: #fff; border-radius: 50%; text-align: center; line-height: 22px; font-size: 14px; cursor: pointer; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; }
    .draggable-item.active .delete-btn { display: block; }
    .ai-sticky-note { position: absolute; width: 160px; min-height: 80px; background: #fff740; padding: 15px; font-family: 'Ma Shan Zheng', cursive; font-size: 18px; color: #333; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); transform: rotate(-2deg); z-index: 50; border-radius: 2px; }
    
        /* å†›ä»¤çŠ¶ */
    .pledge-scroll { background: linear-gradient(to right, #fdfbf7, #f4e4bc, #fdfbf7); padding: 30px; border-top: 15px solid #5d4037; border-bottom: 15px solid #5d4037; box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative; font-family: 'Ma Shan Zheng', cursive; text-align: center; margin-bottom: 20px; }
    .pledge-text { font-size: 20px; line-height: 1.8; color: #3e2723; margin: 10px 0; }
    .pledge-stamp { position: absolute; bottom: 20px; right: 20px; border: 3px solid #d32f2f; color: #d32f2f; font-weight: bold; padding: 5px 10px; transform: rotate(-15deg); font-size: 24px; opacity: 0.8; }
    
    .stamp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: #fff; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    .stamp-cell { aspect-ratio: 1; border: 2px dashed #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px; position: relative; }
    .stamp-mark { animation: stampAnim 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes stampAnim { 0% { transform: scale(3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    .capsule-lock { font-size: 30px; filter: grayscale(1); opacity: 0.5; }
    .capsule-unlock { filter: none; opacity: 1; }
    
    .meal-ai-tools { display: flex; gap: 10px; margin-bottom: 15px; }
    .meal-ai-btn { flex: 1; background: var(--glass-bg); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .period-log-item { background: var(--card-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .period-header-card { background: #fff0f5; padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; border: 2px solid #ffcdd2; color: #333; }
    .pagination-dots { height: 30px; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--dot-inactive); transition: 0.3s; }
    .dot.active { background: var(--dot-active); width: 20px; border-radius: 4px; }
    #overlay-seek { position: fixed; inset: 0; background: #000; color: #fff; z-index: 2500; display: none; align-items: center; justify-content: center; padding: 40px; text-align: center; flex-direction: column; animation: fadeIn 0.5s; }
    #seek-text { font-size: 24px; font-weight: bold; line-height: 1.6; margin-bottom: 30px; font-family: 'Noto Serif SC', serif; }
    
    #modal-letter-read .modal-card { background: #fffaf0; border: 2px solid #eee; color: #444; width: 90%; max-width: 450px; height: 85%; max-height: 85vh; padding: 30px 20px; }
    
    /* æ—¥è®°æ ·å¼ (MindLog Pro) */
    .diary-container { padding: 15px; overflow-y: auto; padding-bottom: 100px; }
    .diary-card { background: var(--card-bg); border-radius: 16px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.4); overflow: hidden; transition: all 0.3s ease; }
    .diary-card.open { border-color: var(--accent-color); transform: translateY(-2px); }
    .diary-header-row { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: rgba(255,255,255,0.01); }
    .diary-header-row:active { background: rgba(0,0,0,0.03); }
    .d-meta { display: flex; align-items: center; gap: 10px; overflow: hidden; }
    .d-time { font-weight: bold; color: var(--accent-color); font-size: 14px; background: rgba(238, 187, 77, 0.1); padding: 4px 8px; border-radius: 8px; }
    .d-preview { font-size: 14px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
    .d-arrow { font-size: 12px; opacity: 0.4; transition: transform 0.3s; }
    .diary-card.open .d-arrow { transform: rotate(180deg); }
    .diary-body { display: none; padding: 0 16px 16px 16px; border-top: 1px dashed rgba(0,0,0,0.05); animation: slideDown 0.2s ease-out; }
    .diary-card.open .diary-body { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .d-content-text { font-size: 15px; line-height: 1.6; margin: 15px 0; white-space: pre-wrap; color: var(--text-color); }
    .d-image { width: 100%; border-radius: 12px; margin-bottom: 10px; display: block; }
    .ai-section { background: rgba(238, 187, 77, 0.08); border-radius: 12px; padding: 12px; margin-top: 10px; border-left: 3px solid var(--accent-color); }
    .comment-bubble { font-size: 13px; margin-bottom: 6px; line-height: 1.4; display: flex; gap: 6px; }
    .comment-role { font-weight: bold; flex-shrink: 0; }
    .role-ai { color: var(--accent-color); }
    .role-user { color: var(--text-color); opacity: 0.8; }
    .d-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); }

/* === åŠŸå¾·å•†åº— & ç‰¹æ•ˆæ ·å¼ === */

/* å•†åº—å¼¹çª—å†…çš„ç½‘æ ¼ */
.shop-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    padding: 10px;
}

/* å•†å“å¡ç‰‡ */
.shop-item {
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    transition: 0.2s;
    cursor: pointer;
}
.shop-item.active { border: 2px solid var(--accent-color); background: rgba(238, 187, 77, 0.1); }
.shop-item:active { transform: scale(0.95); }

/* å•†å“å›¾æ ‡ */
.shop-icon { font-size: 32px; margin-bottom: 5px; }
.shop-name { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: var(--text-color); }
.shop-price { font-size: 12px; padding: 4px 8px; border-radius: 10px; background: #eee; color: #555; }
.shop-price.can-buy { background: var(--accent-color); color: #fff; }
.shop-price.owned { background: transparent; border: 1px solid #ccc; color: #888; }

/* å…¨å±€èƒŒæ™¯ç‰¹æ•ˆå±‚ (æ”¾åœ¨æœ€åº•å±‚) */
#effect-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* ç¡®ä¿ä¸æŒ¡ä½ç‚¹å‡» */
    z-index: 0; /* åœ¨èƒŒæ™¯å›¾ä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
    opacity: 0.6;
}

/* å•†åº—æŒ‰é’® (æ‚¬æµ®åœ¨æœ¨é±¼å¡ç‰‡å³ä¸Šè§’) */
.shop-btn-float {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    background: rgba(255,255,255,0.5);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(0,0,0,0.1);
    transition: 0.2s;
}
.shop-btn-float:active { transform: scale(0.9); background: #fff; }
    /* === æ–°å¢ï¼šä½œå¼ŠæŒ‰é’® (æ”¾åœ¨å·¦ä¸Šè§’) === */
    .cheat-btn-float {
        position: absolute;
        top: 10px;
        left: 10px; /* æ”¾åœ¨å·¦è¾¹ï¼Œå’Œå³è¾¹çš„å•†åº—æŒ‰é’®å¯¹ç§° */
        font-size: 20px;
        cursor: pointer;
        background: rgba(255,255,255,0.5);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(0,0,0,0.1);
        transition: 0.2s;
        z-index: 10;
    }
    /* ç‚¹å‡»æ—¶å˜çº¢ï¼Œæ˜¾ç¤ºä¸€ç§å±é™©æ„Ÿ */
    .cheat-btn-float:active { 
        transform: scale(0.9); 
        background: #ff3b30; 
        color: #fff; 
    }

/* === ğŸŒŠ æ¼‚æµç“¶èƒŒæ™¯ (å¤§æµ·çš®è‚¤) === */
    .bg-sea-day { background: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%); }
    .bg-sea-night { background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%); } /* æ·±é‚ƒé»‘å¤œ */
    .bg-sea-sunset { background: linear-gradient(180deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); } /* æµªæ¼«ç²‰ç´« */
    .bg-sea-galaxy { background: radial-gradient(circle at center, #2b1055 0%, #7597de 100%); } /* æ¢¦å¹»æ˜Ÿç©º */

    /* === ğŸ“œ ä¿¡çº¸çš®è‚¤ (å¼¹çª—æ ·å¼) === */
    
    /* é€šç”¨ç»“æ„ */
    .bottle-modal-base {
        width: 88%; height: auto; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;
        transition: all 0.3s;
    }

    /* 1. å¤é£å·è½´ (é»˜è®¤) */
    .skin-scroll {
        background: linear-gradient(to bottom, #fdfbf7, #f4e4bc, #fdfbf7);
        border-top: 15px solid #5d4037; border-bottom: 15px solid #5d4037;
        border-left: 1px solid #d7ccc8; border-right: 1px solid #d7ccc8;
        border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        color: #3e2723;
    }
    .skin-scroll .content-area { background-image: radial-gradient(#8d6e63 0.5px, transparent 0.5px); background-size: 20px 20px; }
    .skin-scroll .my-note { background: rgba(255,255,255,0.5); border-left: 4px solid #8d6e63; color: #5d4037; }
    .skin-scroll .btn-action { background: #5d4037; color: #fffecb; border: 1px solid #3e2723; }

    /* 2. å°‘å¥³ç”œå¿ƒ (ç²‰è‰²) */
    .skin-pink {
        background: #fff0f5;
        border: 6px dashed #ff80ab;
        border-radius: 24px;
        box-shadow: 0 10px 30px rgba(255, 128, 171, 0.3);
        color: #880e4f;
    }
    .skin-pink .content-area { background-image: linear-gradient(0deg, transparent 19px, #ffcdd2 20px); background-size: 100% 20px; } /* ä¿¡çº¸æ¨ªçº¿ */
    .skin-pink .my-note { background: #ffcdd2; border-radius: 12px; color: #880e4f; }
    .skin-pink .btn-action { background: #ff80ab; color: #fff; border: none; border-radius: 20px; box-shadow: 0 4px 10px rgba(255, 128, 171, 0.4); }

    /* 3. æš—å¤œéœ“è™¹ (æ·±è‰²) */
    .skin-dark {
        background: #212121;
        border: 2px solid #00e676;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 230, 118, 0.2);
        color: #e0e0e0;
    }
    .skin-dark .content-area { background: #212121; }
    .skin-dark .my-note { background: #333; border-left: 4px solid #00e676; color: #00e676; }
    .skin-dark .btn-action { background: transparent; color: #00e676; border: 1px solid #00e676; text-shadow: 0 0 5px #00e676; }

    /* 4. æç®€ç™½ (ç°ä»£) */
    .skin-simple {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        color: #333;
    }
    .skin-simple .content-area { background: #fff; }
    .skin-simple .my-note { background: #f5f5f7; border-radius: 8px; color: #666; }
    .skin-simple .btn-action { background: #007aff; color: #fff; border: none; border-radius: 8px; }

    /* è®¾ç½®é€‰é¡¹å¡æ ·å¼ */
    .skin-option { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .skin-option.active { border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.1); }

    /* === ä½“é‡ç®¡ç†æ ·å¼ === */
        /* === ä¿®å¤å¸ƒå±€é”™ä½å’Œåˆ—è¡¨æ ·å¼ === */
    
    /* 1. ä¿®å¤â€œä»Šå¤©è¿åŠ¨äº†å—â€æ–‡å­—ä¸å¤é€‰æ¡†å‚ç›´å±…ä¸­å¯¹é½ */
    .exercise-check-row {
        display: flex;          /* å¯ç”¨å¼¹æ€§å¸ƒå±€ */
        align-items: center;    /* ã€å…³é”®ã€‘å‚ç›´å±…ä¸­ï¼Œè§£å†³æ–‡å­—åé«˜é—®é¢˜ */
        gap: 8px;               /* æ§ä»¶å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
        margin-top: 15px;       /* ä¸Šæ–¹ç•™ç‚¹ç©ºéš™ */
        margin-bottom: 10px;
    }

    /* 2. ä¿®å¤å†å²è®°å½•åˆ—è¡¨æ’ç‰ˆï¼ˆè®©åˆ é™¤æŒ‰é’®å¥½ç‚¹ï¼Œä¸”å¸ƒå±€æ•´é½ï¼‰ */
    /* ä¿®å¤å†å²è®°å½•åˆ—è¡¨æ’ç‰ˆ */
    .w-history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: rgba(255,255,255,0.5);
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        
        /* === å…³é”®ä¿®æ­£ï¼šè¿™ä¸¤è¡Œå¿…é¡»åœ¨èŠ±æ‹¬å·é‡Œé¢ === */
        position: relative; 
        z-index: 20; 
    }
    
        /* å¢åŠ åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»åŒºåŸŸï¼Œé˜²æ­¢ç‚¹ä¸åˆ° */
    .w-history-item .delete-btn {
        padding: 10px;
        margin-right: -10px; /* è§†è§‰ä¿®æ­£ */
    }
    
   /* æ‰¾åˆ°è¿™ä¸ªç±»ï¼ŒåŠ å…¥ overflow: hidden */
.weight-chart-box {
    width: 100%; 
    height: 200px;
    background: #fff; 
    border-radius: 16px;
    margin-bottom: 15px; 
    padding: 10px;
    box-shadow: var(--shadow);
    position: relative;
    z-index: 1;
    
    /* ğŸ‘‡ æ–°å¢è¿™ä¸€è¡Œï¼šå¼ºåˆ¶å‰ªè£æº¢å‡ºå†…å®¹ ğŸ‘‡ */
    overflow: hidden; 
}

    .weight-canvas { 
        width: 100%; height: 100%; 
        pointer-events: none; /* ã€å…³é”®ã€‘è®©é¼ æ ‡ç‚¹å‡»èƒ½â€œç©¿é€â€å›¾è¡¨ï¼Œé˜²æ­¢é®æŒ¡è¾“å…¥æ¡† */
    }
    .weight-input-card {
        background: var(--card-bg); padding: 15px; border-radius: 16px;
        margin-bottom: 15px; border: 1px solid var(--glass-border);
        position: relative; 
        z-index: 10; /* ã€å…³é”®ã€‘è®©è¾“å…¥æ¡†å±‚çº§å˜é«˜ï¼Œæµ®åœ¨æœ€ä¸Šé¢ */
    }
        
            /* === â¤ï¸ æ–°å¢ï¼šäº²æ˜µ (Touch) APP æ ·å¼ === */
    .touch-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        /* å‘¼å¸ç¯èƒŒæ™¯åŠ¨ç”» */
        background: radial-gradient(circle at center, #ffcdd2 0%, #fff0f5 70%);
        animation: breath-bg 4s infinite ease-in-out;
        position: relative;
        overflow: hidden;
    }

    @keyframes breath-bg {
        0% { box-shadow: inset 0 0 50px #ff80ab; background-size: 100% 100%; }
        50% { box-shadow: inset 0 0 100px #ff4081; background-size: 120% 120%; }
        100% { box-shadow: inset 0 0 50px #ff80ab; background-size: 100% 100%; }
    }

    .heart-beat-icon {
        font-size: 80px;
        margin: 20px 0;
        filter: drop-shadow(0 0 20px rgba(255, 64, 129, 0.6));
        animation: heartbeat 1.5s infinite;
        cursor: pointer;
    }

    @keyframes heartbeat {
        0% { transform: scale(1); }
        15% { transform: scale(1.3); }
        30% { transform: scale(1); }
        45% { transform: scale(1.15); }
        60% { transform: scale(1); }
    }
    
        .touch-btn {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 16px;
        font-size: 16px;
        font-weight: bold;
        color: #880e4f;
        backdrop-filter: blur(5px);
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(255, 64, 129, 0.15);
    }
    .touch-btn:active { transform: scale(0.95); background: #fff; }

    .touch-response-area {
        margin-top: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        border: 2px dashed #ff80ab;
        width: 100%;
        flex: 1;
        overflow-y: auto;
        font-family: 'Ma Shan Zheng', cursive; /* ä½¿ç”¨æ‰‹å†™å­—ä½“å¢åŠ äº²å¯†æ„Ÿ */
        font-size: 18px;
        line-height: 1.8;
        color: #880e4f;
        display: none; /* é»˜è®¤éšè— */
        animation: fadeIn 1s;
    }
    
        /* === â¤ï¸ äº²æ˜µ V2.0 æ ·å¼ === */
    
    /* 1. ç»“æœå¤§å¼¹çª—ï¼šåƒä¸€å¼ ç²¾è‡´çš„å¡ç‰‡ */
    .touch-card-content {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: 22px;
        line-height: 1.8;
        color: #880e4f;
        text-align: left;
        white-space: pre-wrap;
        padding: 10px;
        min-height: 150px;
    }
    
    /* 2. æ”¶è—åˆ—è¡¨ï¼šæŒ‰æ—¥æœŸåˆ†ç»„ */
    .touch-date-header {
        font-size: 14px;
        font-weight: bold;
        color: #ec407a;
        margin: 20px 0 10px 5px;
        opacity: 0.8;
        border-bottom: 1px dashed #ffcdd2;
        padding-bottom: 5px;
    }
    
    .touch-history-item {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        position: relative;
        transition: 0.2s;
    }
    .touch-history-item:active { transform: scale(0.98); background: #fff; }
    
    .t-action-tag {
        display: inline-block;
        background: #fce4ec;
        color: #c2185b;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        margin-bottom: 8px;
    }
    
    .t-role-name {
        font-weight: bold;
        color: #880e4f;
        font-size: 14px;
        margin-right: 5px;
    }
    
    /* === ğŸŒ¡ï¸ æš§æ˜§å‡æ¸©è¿›åº¦æ¡ === */
.heat-box { width: 100%; margin-bottom: 15px; padding: 0 5px; }
.heat-header { display: flex; justify-content: space-between; font-size: 12px; color: #880e4f; margin-bottom: 5px; font-weight: bold; }
.heat-track { width: 100%; height: 10px; background: rgba(255,255,255,0.5); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,128,171,0.3); }
.heat-fill { height: 100%; background: linear-gradient(90deg, #ff80ab, #f50057); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(245, 0, 87, 0.4); }
/* æ»¡å€¼æ—¶çš„ç‰¹æ•ˆåŠ¨ç”» */
.heat-full { animation: pulse-red 1s infinite; }
@keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(245, 0, 87, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 0, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 0, 87, 0); } }

/* === V34: åç‰‡å°ç»„ä»¶æ ·å¼ === */
.card-widget-container {
    width: 100%;
    aspect-ratio: 16 / 10; /* æ¥è¿‘å¡ç‰‡çš„æ¯”ä¾‹ */
    perspective: 1000px; /* 3D ç¿»è½¬çš„æ™¯æ·± */
    cursor: pointer;
    margin-top: 20px;
}
.card-flipper {
    width: 100%;
    height: 100%;
    position: relative;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}
.card-widget-container.is-flipped .card-flipper {
    transform: rotateY(180deg);
}
.card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden; /* Safari å…¼å®¹ */
    backface-visibility: hidden; /* ç¿»è½¬åèƒŒé¢ä¸å¯è§ */
    border-radius: 24px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    background-size: cover;
    background-position: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* é»˜è®¤å­—ä½“ */
    color: var(--text-color);
}
.card-front {
    background-color: var(--card-bg);
    border: 1px solid var(--glass-border);
}
.card-back {
    background-color: var(--card-bg);
    border: 1px solid var(--glass-border);
    transform: rotateY(180deg);
}
.card-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #eee;
    background-size: cover;
    background-position: center;
    border: 3px solid rgba(120,120,120,0.2);
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.card-name {
    font-size: 22px;
    font-weight: bold;
    margin: 0;
}
.card-bio {
    font-size: 14px;
    margin: 5px 0 0 0;
    opacity: 0.8;
}
.card-edit-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 18px;
    background: rgba(255,255,255,0.2);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
    transition: 0.2s;
    z-index: 10;
}
.card-edit-btn:active {
    transform: scale(0.9) rotate(45deg);
}
</style>
</head>
<body class="theme-day">

<div id="phone-container">
    <div class="status-bar">
        <span id="clock-time">09:43</span>
        <div style="display:flex; align-items:center; gap:6px;"><span id="battery-text">43%</span><div style="width:26px; height:13px; border:1.5px solid currentColor; border-radius:4px; padding:1px;"><div id="battery-fill" style="height:100%; background:currentColor; width:43%;"></div></div></div>
    </div>

    <!-- Scroll Wrapper -->
    <div class="scroll-wrapper" id="scroll-container">

        
        <!-- === Page 1 (è‰ºæœ¯ä¹±åº) === -->
        <div class="page" id="page-1">
            <div class="mix-grid">
                <!-- å°é¢å›¾ (ç‚¹å‡»å¯è®¾ç½®) -->
                <div class="widget-photo" id="widget-photo" onclick="openPhotoSettings()">
                    <div class="his-status-pill" id="his-status-display">ğŸš— å›å®¶è·¯ä¸Š</div>
                    <div class="rpg-pill" onclick="event.stopPropagation(); alert('å½“å‰ç­‰çº§ä¸ç»éªŒå€¼')">
    <span id="rpg-lv">Lv.1</span>
    <div class="rpg-bar-bg"><div id="rpg-bar" class="rpg-bar-fill"></div></div>
</div>
                    <span class="photo-placeholder" style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center; color:#999; text-shadow:0 1px 2px rgba(0,0,0,0.5);">ç‚¹å‡»è®¾ç½®å›¾ç‰‡</span>
                </div>
                <!-- å€’è®¡æ—¶ -->
                <div class="widget-countdown" style="flex:1;" onclick="editCountdown()">
                    <div class="cd-days" id="cd-num">3</div>
                    <div class="cd-label" id="cd-text" style="font-size:10px; opacity:0.7;">è·ç¦»è§é¢</div>
                    <div style="font-size:16px; margin-top:2px;">ğŸ—“ï¸</div>
                </div>
                <!-- æ—¥è®° MindLog -->
                <div class="mix-app" onclick="openView('view-diary')">
                    <div class="icon-box" style="background:var(--card-bg);"><span style="font-size:24px;">ğŸ“–</span></div>
                    <span class="app-name">MindLog</span>
                </div>
                <!-- ä¹–å®å® -->
                <div class="mix-app-wide" onclick="openView('view-stamp')" style="background:#fff0f5; border-color:#ffcdd2; width:100%;">
                    <span style="font-size:24px;">ğŸ’®</span> <span style="font-size:14px; font-weight:600; color:#d81b60;">ä¹–å®å®é›†ç« </span>
                    <span style="font-size:10px; opacity:0.6; margin-left:auto;">åšä¸ªå¥½å­©å­</span>
                </div>
                <!-- è®¾ç½® -->
                <div class="mix-app" onclick="openView('view-settings')" style="margin-left:auto;">
                    <div class="icon-box"><span style="font-size:20px;">âš™ï¸</span></div>
                    <span class="app-name">è®¾ç½®</span>
                </div>
            </div>
        </div>

        <!-- === Page 2 (è‰ºæœ¯ä¹±åº) === -->
        <div class="page" id="page-2">
             <div class="mix-grid">
                <!-- æ¶‚é¸¦ -->
                <div class="scrapbook-card doodle-widget" id="doodle-card">
                    <div class="tape"></div>
                    <canvas id="doodle-canvas" class="doodle-canvas"></canvas>
                    <div class="doodle-tools"><div onclick="clearDoodle()" style="font-size:12px; background:rgba(255,255,255,0.8); padding:4px 8px; border-radius:6px; cursor:pointer;">ğŸ§¹</div></div>
                </div>
                <!-- æ‰‹è´¦ -->
                <div class="mix-app-wide" onclick="openView('view-journal')" style="width: calc(50% - 6px); background:#fff9c4; border-color:#fff59d;">
                    <span style="font-size:20px;">ğŸ“’</span> <span style="font-size:13px; font-weight:600;">æ‰‹è´¦</span>
                </div>
                <!-- å‘½è¿æ‰­è›‹ -->
                <div class="box-widget" style="width: calc(50% - 6px); height:120px;" onclick="openView('view-gacha')">
                    <div style="font-size:28px; margin-bottom:5px;">ğŸ²</div>
                    <div style="font-size:12px; text-align:center; opacity:0.8;">å‘½è¿æ‰­è›‹</div>
                </div>
                <!-- ç»æœŸ -->
                <div class="scrapbook-card" onclick="openView('view-period')" style="width: calc(50% - 6px); height:120px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#fff0f5; cursor:pointer; border:2px solid #ffcdd2;">
                    <div style="font-size:24px;">ğŸ©¸</div><div id="period-status-widget" style="font-size:12px; margin-top:5px; font-weight:bold; text-align:center; color:#333;">--</div>
                </div>
                <!-- è§’è‰² -->
                <div class="mix-app" onclick="openView('view-contacts')"><div class="icon-box"><span style="font-size:24px;">ğŸ‘¥</span></div><span class="app-name">è§’è‰²</span></div>
             </div>
        </div>
        
                <!-- === Page 3 (è‰ºæœ¯ä¹±åº) === -->
        <div class="page" id="page-3">
            <div class="mix-grid">
                <!-- Mood -->
                <div class="mood-box-inner">
                    <div style="font-size:12px; font-weight:bold; opacity:0.6;">MOOD</div>
                    <div style="display:flex; gap:15px;">
                        <div class="mood-btn" onclick="setMood('happy')" id="mood-happy" style="font-size:28px; opacity:0.4; cursor:pointer;">ğŸ˜„</div>
                        <div class="mood-btn" onclick="setMood('calm')" id="mood-calm" style="font-size:28px; opacity:0.4; cursor:pointer;">â˜•</div>
                        <div class="mood-btn" onclick="setMood('tired')" id="mood-tired" style="font-size:28px; opacity:0.4; cursor:pointer;">ğŸ˜«</div>
                    </div>
                </div>
                <!-- Todo -->
                <div class="widget-large" style="width:100%; height:auto; min-height:140px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.05); padding-bottom:8px; margin-bottom:5px;">
                        <span style="font-weight:bold; font-size:14px; color:var(--text-color);">å¾…åŠæ¸…å•</span>
                        <span style="font-size:18px; cursor:pointer; color:var(--accent-color);" onclick="openCustomPrompt('æ·»åŠ å¾…åŠ', (v)=>{addTodo(v)})">+</span>
                    </div>
                    <div class="todo-list-bento" id="todo-list-desktop"></div>
                </div>
                <!-- é¥®é£Ÿ -->
                <div class="mix-app-wide" onclick="openView('view-meals')" style="width: 100%;"><span style="font-size:20px;">ğŸ±</span> <span style="font-size:13px; font-weight:600;">å¥½å¥½åƒé¥­</span></div>
                <!-- è§£å¿§ -->
                <div class="mix-app" onclick="seekGuidance()"><div class="icon-box" style="background:#ff9a9e; color:#fff;"><span style="font-size:22px;">ğŸ’—</span></div><span class="app-name">è§£å¿§</span></div>
                <!-- é‡‘åº“ -->
                <div class="mix-app" onclick="openView('view-vault')"><div class="icon-box" style="background:#333; color:#f0c268;"><span style="font-size:22px;">ğŸ”’</span></div><span class="app-name">é‡‘åº“</span></div>
                <!-- æ¯æ—¥ä¸€å¦ -->
                <div class="box-widget divination-box" style="width: calc(50% - 6px); height:70px; flex-direction:row; gap:15px;" onclick="drawDivination()">
                    <div class="divination-sticks" style="font-size:24px;">ğŸ</div><div id="divination-text" style="font-size:14px; font-weight:bold;">æ¯æ—¥ä¸€å¦</div>
                </div>
            </div>
        </div>

        <!-- === Page 4 (è‰ºæœ¯ä¹±åº) === -->
        <div class="page" id="page-4">
            <div class="mix-grid">
                <!-- å†›ä»¤çŠ¶ -->
                <div class="mix-app-wide" style="width:100%; background: #5d4037; color:#fffecb; border-color:#8d6e63;" onclick="openView('view-pledge')">
                     <span style="font-size:24px;">ğŸ“œ</span> <span style="font-size:16px; font-family:'Ma Shan Zheng';">å†›ä»¤çŠ¶</span>
                     <span style="font-size:10px; opacity:0.7; margin-left:auto;">ä¸¥å®ˆå†›çºª</span>
                </div>
                <!-- æ¢¦å¢ƒ -->
                <div class="mix-app" onclick="openView('view-dream')"><div class="icon-box" style="background:#311b92; color:#b388ff;"><span style="font-size:22px;">ğŸŒ™</span></div><span class="app-name">è§£æ¢¦</span></div>
                <!-- æ…¢é€’ -->
                <div class="mix-app" onclick="openView('view-capsule')"><div class="icon-box" style="background:#546e7a; color:#cfd8dc;"><span style="font-size:22px;">ğŸ“®</span></div><span class="app-name">æ…¢é€’</span></div>
                <!-- è¯·ç¤ºå• -->
                <div class="mix-app-wide" onclick="openView('view-permission')" style="background:#e3f2fd; border-color:#bbdefb; width: calc(50% - 6px);">
                    <span style="font-size:24px;">ğŸ“</span> <span style="font-size:14px; font-weight:600; color:#1565c0;">è¯·ç¤ºå•</span>
                </div>
                <!-- è¯´æ˜ä¹¦ -->
                <div class="mix-app" onclick="openView('view-manual')"><div class="icon-box" style="background:var(--card-bg); border:1px solid var(--text-color);"><span style="font-size:22px;">ğŸ“˜</span></div><span class="app-name">è¯´æ˜</span></div>
                <!-- æ—¶å…‰ä¿¡ç®± -->
                <div class="mix-app-wide" onclick="openView('view-letters')" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-color:#ffcc80; width:100%;">
                    <div style="display:flex; justify-content:center; align-items:center; gap:10px; width:100%;">
                        <span style="font-size:16px; font-weight:bold; color:#e65100;">æ—¶å…‰ä¿¡ç®±</span><span style="font-size:24px;">ğŸ“¬</span>
                    </div>
               </div>
               <!-- å†°ç®±è´´ -->
                <div class="fridge-container">
                    <div class="fridge-pin"></div>
                    <textarea id="fridge-memo" class="fridge-memo" placeholder="å†°ç®±ä¸Šçš„ç•™è¨€..." oninput="saveFridgeMemo()"></textarea>
                </div>
            </div>
        </div>
    
            <!-- === Page 5 (æ–°å¢åŠŸèƒ½) === -->
        <div class="page" id="page-5">
            <div class="mix-grid">
                <!-- ç”µå­æœ¨é±¼ -->
                <div class="mix-app-wide" style="width:100%; height:140px; background:var(--paper-texture); border:2px solid #5d4037;" onclick="knockWoodenFish(event)">
                    <div class="wooden-fish-widget">
                        <div class="shop-btn-float" onclick="event.stopPropagation(); openShop()">ğŸ›ï¸</div>
                        <div class="cheat-btn-float" onclick="event.stopPropagation(); attemptCheat()">ğŸ˜ˆ</div>
                        
                        <div class="wooden-fish-icon" id="fish-icon-display">ğŸ¡</div>
                        <div style="margin-top:10px; font-family:'Ma Shan Zheng'; color:#5d4037;">ç”µå­æœ¨é±¼</div>
                        <div id="merit-count" style="font-size:12px; opacity:0.6; margin-top:5px;">åŠŸå¾·: 0</div>
                    </div>
                </div>


                <!-- å¿ƒæƒ…åƒç´ å¢™ -->
                <div class="widget-large" style="width:100%; height:200px; background:#fff;">
                    <div style="font-size:14px; font-weight:bold; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>Mood Pixels</span>
                        <span style="font-size:10px; opacity:0.5;">Year View</span>
                    </div>
                    <div class="pixel-wall-container">
                        <div class="pixel-grid" id="pixel-grid"></div>
                        <div class="pixel-legend">
                            <span>ğŸ˜„ å¼€å¿ƒ</span> <span>â˜• å¹³é™</span> <span>ğŸ˜« ç–²æƒ«</span>
                        </div>
                    </div>
                </div>
                
                        <!-- è‡ªå®šä¹‰å£çº¸å…¥å£ -->
<div class="mix-app" onclick="$('modal-theme-wp').style.display='flex'">
    <div class="icon-box" style="background:#fff;"><span style="font-size:24px;">ğŸ–¼ï¸</span></div>
    <span class="app-name">å£çº¸</span>
</div>

<!-- æ¼‚æµç“¶å…¥å£ -->
<div class="mix-app" onclick="openDriftBottle()">
    <div class="icon-box" style="background:#81d4fa; color:#fff;"><span style="font-size:24px;">ğŸ¾</span></div>
    <span class="app-name">æ¼‚æµç“¶</span>
</div>
<!-- æŒ‡ä»¤é›†å…¥å£ -->
<div class="mix-app" onclick="openView('view-commands')">
    <div class="icon-box" style="background:#212121; color:#00e676; border:1px solid #333;">
        <span style="font-size:22px;">ğŸ’»</span>
    </div>
    <span class="app-name">æŒ‡ä»¤é›†</span>
</div>

<!-- äº²æ˜µå…¥å£ -->
<div class="mix-app" onclick="openView('view-touch')">
    <div class="icon-box" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #fff; border: 1px solid #ff80ab;">
        <span style="font-size: 24px;">ğŸ’“</span>
    </div>
    <span class="app-name">äº²æ˜µ</span>
</div>

<!-- ä½“é‡ç®¡ç†å…¥å£ -->
<!-- åŠ äº†ä¸€ä¸ª setTimeout ç¡®ä¿ç•Œé¢æ‰“å¼€åå†æ¸²æŸ“å›¾è¡¨ï¼Œé˜²æ­¢å›¾è¡¨å˜å½¢ -->
<div class="mix-app" onclick="openView('view-weight'); setTimeout(renderWeightApp, 100);">
    <div class="icon-box" style="background:#e0f2f1; color:#009688;">
        <span style="font-size:24px;">ğŸ’ª</span>
    </div>
    <span class="app-name">çŠ¶æ€</span>
</div>
            </div>
        </div>
<!-- === Page 6 (åç‰‡å°ç»„ä»¶) === -->
        <div class="page" id="page-6">
            <div class="mix-grid" id="page-6-grid">
                <!-- åç‰‡å°ç»„ä»¶ -->
                <div class="card-widget-container" onclick="flipCard()">
                    <div class="card-flipper" id="card-flipper">
                        <!-- æ­£é¢ -->
                        <div class="card-face card-front" id="card-front">
                            <div class="card-avatar" id="card-avatar-front"></div>
                            <h3 class="card-name" id="card-name-front">ä½ çš„åå­—</h3>
                            <p class="card-bio" id="card-bio-front">@è‡ªå®šä¹‰ãƒ»ç‚¹å‡»ç¿»è½¬</p>
                            <div class="card-edit-btn" onclick="event.stopPropagation(); openCardSettings('front')">âš™ï¸</div>
                        </div>
                        <!-- èƒŒé¢ -->
                        <div class="card-face card-back" id="card-back">
                             <div class="card-avatar" id="card-avatar-back"></div>
                            <h3 class="card-name" id="card-name-back">Ta çš„åå­—</h3>
                            <p class="card-bio" id="card-bio-back">ä¸€å¥å–œæ¬¢çš„è¯</p>
                            <div class="card-edit-btn" onclick="event.stopPropagation(); openCardSettings('back')">âš™ï¸</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
            <div class="pagination-dots">
    <div class="dot active" id="dot-1"></div>
    <div class="dot" id="dot-2"></div>
    <div class="dot" id="dot-3"></div>
    <div class="dot" id="dot-4"></div>
    <div class="dot" id="dot-5"></div>
    <div class="dot" id="dot-6"></div> <!-- âœ… æ–°å¢è¿™ä¸€è¡Œ -->
</div>
        
                <!-- === Modals === -->
                    <div id="modal-otd" class="modal">
        <div class="modal-card" style="background: #fffaf0;">
            <div class="otd-card">
                <div class="otd-ribbon">æ—¶å…‰æœº</div>
                <div class="otd-date" id="otd-date-display">--</div>
                <div class="otd-year-tag" id="otd-year-display">--</div>
                <div class="otd-content" id="otd-content-display">...</div>
            </div>
            <div style="margin-top:20px; font-size:13px; opacity:0.7;">
                ç°åœ¨çš„ä½ ï¼Œæƒ³å¯¹é‚£æ—¶çš„è‡ªå·±è¯´ä»€ä¹ˆï¼Ÿ
            </div>
            <button class="btn-normal" onclick="$('modal-otd').style.display='none'">æ”¶åˆ°äº†</button>
        </div>
    </div>
                    <!-- === æ–°å¢ï¼šå¼•ç”¨åŠŸèƒ½å¼¹çª— (å«æ—¥è®°é€‰æ‹©) === -->
    <div id="modal-reference" class="modal" style="z-index: 3000;">
        <div class="modal-card" style="max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <h3>å¼•ç”¨è®°å½•</h3>
            
            <!-- é€‰é¡¹æŒ‰é’®åŒº -->
            <div id="ref-buttons" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%;">
                <button class="btn-normal" onclick="insertReference('meals')">ğŸ± ä»Šæ—¥é¥®é£Ÿ</button>
                <button class="btn-normal" onclick="insertReference('period')">ğŸ©¸ ç»æœŸçŠ¶æ€</button>
                <button class="btn-normal" onclick="insertReference('todo')">ğŸ“ å¾…åŠäº‹é¡¹</button>
                <button class="btn-normal" onclick="insertReference('pledge')">ğŸ“œ å†›ä»¤çŠ¶</button>
                <button class="btn-normal" style="grid-column: span 2; background:#e3f2fd; color:#1565c0;" onclick="showDiaryPicker()">ğŸ“” å¼•ç”¨å¾€æœŸæ—¥è®°</button>
            </div>

            <!-- æ—¥è®°é€‰æ‹©åˆ—è¡¨ (é»˜è®¤éšè—) -->
            <div id="ref-diary-picker" style="display:none; flex:1; overflow-y:auto; width:100%; text-align:left; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <div style="font-size:12px; opacity:0.6; margin-bottom:5px;">ç‚¹å‡»é€‰æ‹©ä¸€æ¡æ—¥è®°æ’å…¥ï¼š</div>
                <div id="ref-diary-list"></div>
            </div>

            <div class="btn-group" style="margin-top:15px; width:100%;">
                <button id="btn-ref-back" class="btn-normal btn-secondary" style="display:none;" onclick="hideDiaryPicker()">â¬…ï¸ è¿”å›</button>
                <button class="btn-normal btn-secondary" onclick="$('modal-reference').style.display='none'; hideDiaryPicker();">å…³é—­</button>
            </div>
        </div>
    </div>
    <div id="modal-prompt" class="modal">
        <div class="modal-card">
            <h3 id="prompt-title" style="margin:0; font-size:16px;">è¾“å…¥</h3>
            <input id="prompt-input" class="setting-input" type="text" autofocus>
            <div class="btn-group"><button class="btn-normal btn-secondary" onclick="closeCustomPrompt()">å–æ¶ˆ</button><button class="btn-normal" id="prompt-confirm-btn">ç¡®å®š</button></div>
        </div>
    </div>
    
    <div id="modal-role-select" class="modal">
        <div class="modal-card">
            <h3>é€‰æ‹©å›å¤çš„è§’è‰²</h3>
            <select id="role-select-input" class="setting-input"></select>
            <div class="btn-group">
                <button class="btn-normal btn-secondary" onclick="$('modal-role-select').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-normal" id="role-select-confirm">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="modal-alert" class="modal"><div class="modal-card"><h3 style="margin:0; font-size:16px;">æç¤º</h3><div id="alert-msg" style="font-size:14px; line-height:1.5;"></div><button class="btn-normal" onclick="document.getElementById('modal-alert').style.display='none'">çŸ¥é“äº†</button></div></div>
    <div id="modal-letter-read" class="modal"><div class="modal-card" style="text-align:left;"><div style="text-align:center; font-size:24px; margin-bottom:10px;">ğŸ’Œ</div><div id="read-content" style="font-family:'Ma Shan Zheng'; white-space:pre-wrap; font-size:18px; line-height:1.8; overflow-y:auto; flex:1;"></div><button class="btn-normal" onclick="$('modal-letter-read').style.display='none'" style="margin-top:15px; flex-shrink:0; height: 50px; flex-grow: 0;">æ”¶èµ·</button></div></div>
    
            <div id="modal-photo" class="modal">
        <div class="modal-card">
            <h3>è®¾ç½®å°é¢å›¾</h3>
            <input id="photo-url-input" class="setting-input" placeholder="å›¾ç‰‡é“¾æ¥ (URL) æˆ–é€‰æ‹©æ–‡ä»¶">
            <div style="margin:5px 0; font-size:12px; opacity:0.6;">- æˆ– -</div>
            <input type="file" id="bg-upload" class="setting-input" accept="image/*">
            <div class="btn-group">
                <button class="btn-normal btn-secondary" onclick="$('modal-photo').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-normal" onclick="savePhotoSetting()">ç¡®å®š</button>
            </div>
            <!-- æ–°å¢çš„æ¸…é™¤æŒ‰é’® -->
            <button class="btn-normal btn-danger" style="margin-top:10px;" onclick="clearPhotoSetting()">æ¸…é™¤å›¾ç‰‡</button>
        </div>
    </div>
    <div id="modal-countdown" class="modal"><div class="modal-card"><h3>å€’è®¡æ—¶/çºªå¿µæ—¥</h3><input id="cd-input-text" class="setting-input" placeholder="äº‹é¡¹åç§°"><input id="cd-input-date" type="date" class="setting-input"><div class="btn-group"><button class="btn-normal btn-secondary" onclick="$('modal-countdown').style.display='none'">å–æ¶ˆ</button><button class="btn-normal" onclick="saveCountdown()">ä¿å­˜</button></div></div></div>
    <div id="modal-contact" class="modal"><div class="modal-card"><h3>ç¼–è¾‘è§’è‰²</h3><input type="hidden" id="c-id"><input id="c-name" class="setting-input" placeholder="åå­—"><textarea id="c-prompt" class="setting-input" placeholder="äººè®¾" rows="3"></textarea><div class="btn-group"><button class="btn-normal btn-secondary" onclick="$('modal-contact').style.display='none'">å–æ¶ˆ</button><button class="btn-normal" onclick="saveContact()">ä¿å­˜</button></div><button class="btn-normal btn-danger" style="margin-top:10px;" onclick="deleteContact()">åˆ é™¤è§’è‰²</button></div></div>
    <div id="modal-period-add" class="modal"><div class="modal-card"><h3>è®°å½•ç»æœŸ</h3><label style="font-size:12px;display:block;text-align:left;">å¼€å§‹æ—¥æœŸ</label><input id="p-log-start" type="date" class="setting-input"><label style="font-size:12px;display:block;text-align:left;">ç»“æŸæ—¥æœŸ (å¯é€‰)</label><input id="p-log-end" type="date" class="setting-input"><div class="btn-group"><button class="btn-normal btn-secondary" onclick="$('modal-period-add').style.display='none'">å–æ¶ˆ</button><button class="btn-normal" onclick="savePeriodLog()">ä¿å­˜</button></div></div></div>
    
    <!-- === â¤ï¸ å¼¹çª—1ï¼šå¿ƒåŠ¨æ—¶åˆ» (æ˜¾ç¤ºç»“æœ) === -->
<div id="modal-touch-result" class="modal">
    <div class="modal-card" style="background: linear-gradient(180deg, #fff0f5 0%, #fff 100%); border: 2px solid #ff80ab; max-height: 80vh;">
        <div style="text-align: center; font-size: 40px; margin-bottom: 10px;">ğŸ’“</div>
        
                <!-- è¿™æ˜¯ä¸€ä¸ªå¯æ»‘åŠ¨çš„åŒºåŸŸ -->
        <div id="touch-display-text" class="touch-card-content" style="overflow-y: auto; flex: 1;">
            <!-- AIå›å¤çš„å†…å®¹ä¼šåœ¨è¿™é‡Œ -->
        </div>

        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn-normal btn-secondary" onclick="$('modal-touch-result').style.display='none'">å…³é—­</button>
            <button class="btn-normal" onclick="saveCurrentTouch()">â¤ï¸ æ”¶è—è¿™ä»½æ‚¸åŠ¨</button>
        </div>
    </div>
</div>

<!-- === â¤ï¸ å¼¹çª—2ï¼šå›å¿†å½• (æ”¶è—åˆ—è¡¨) === -->
<div id="modal-touch-collection" class="modal">
    <div class="modal-card" style="background: #fff; height: 80vh; display: flex; flex-direction: column;">
        <h3 style="color: #880e4f; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0;">ç”œèœœå›å¿†å½•</h3>
        
        <!-- è¿™é‡Œæ˜¯æŒ‰æ—¥æœŸåˆ†ç±»çš„åˆ—è¡¨ -->
        <div id="touch-collection-list" style="flex: 1; overflow-y: auto; text-align: left; padding-right: 5px;"></div>
        
                <button class="btn-normal btn-secondary" style="margin-top: 15px; flex-shrink: 0; height: 50px; flex: none;" onclick="$('modal-touch-collection').style.display='none'">å…³é—­</button>
    </div>
</div>

<!-- === æ–°å¢ï¼šåç‰‡è®¾ç½®å¼¹çª— === -->
    <div id="modal-card-settings" class="modal">
        <div class="modal-card">
            <h3 id="card-settings-title">ç¼–è¾‘åç‰‡</h3>
            <input type="hidden" id="card-edit-side"> <!-- å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ˜¯ front è¿˜æ˜¯ back -->
            
            <label>åå­—</label>
            <input id="card-set-name" class="setting-input" placeholder="æ˜¾ç¤ºçš„åå­—">
            
            <label>ç®€ä»‹/ç­¾å</label>
            <textarea id="card-set-bio" class="setting-input" rows="2" placeholder="æ˜¾ç¤ºåœ¨åå­—ä¸‹æ–¹çš„ä¸€è¡Œè¯"></textarea>
            
            <label>å¤´åƒ</label>
            <input id="card-set-avatar-url" class="setting-input" placeholder="å›¾ç‰‡é“¾æ¥ (URL)">
            <div style="font-size:12px; opacity:0.6; margin:5px 0;">- æˆ– -</div>
            <input type="file" id="card-set-avatar-file" class="setting-input" accept="image/*">

            <label>è‡ªå®šä¹‰å­—ä½“ (TTF/WOFFé“¾æ¥)</label>
            <input id="card-set-font-url" class="setting-input" placeholder="è¾“å…¥ .ttf æˆ– .woff å­—ä½“é“¾æ¥">

            <div class="btn-group">
                <button class="btn-normal btn-secondary" onclick="$('modal-card-settings').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-normal" onclick="saveCardSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>
        <!-- Apps Views -->
    
    <!-- æ‰‹è´¦ -->
    <div id="view-journal" class="view-overlay"><div class="header"><button class="btn-icon btn-back" onclick="closeView('view-journal')">âœ•</button> <span>æˆ‘çš„æ‰‹è´¦</span> <button class="btn-icon btn-add" onclick="createNewJournal()">+</button></div><div id="journal-shelf" class="journal-shelf"></div>
        <div id="journal-editor-view" style="position:absolute; inset:0; background:var(--bg-color); z-index:10; display:none; flex-direction:column;">
            <div class="header" style="background:var(--glass-bg);">
                <button class="btn-icon btn-back" onclick="closeJournalEditor()">â†</button> 
                <span id="editor-title" onclick="renameJournal()" style="cursor:pointer; border-bottom:1px dashed #999;">æ–°é¡µé¢</span> 
                <div style="display:flex; gap:5px;"><button class="btn-icon" style="font-size:18px;" onclick="openJournalAIReply()">âœ¨</button><button class="btn-icon" onclick="saveJournalPage()">ğŸ’¾</button></div>
            </div>
            <div id="journal-wrapper" class="journal-wrapper" onclick="deselectAllDraggables(event)">
                <div id="journal-layer-sticker" style="position:absolute; inset:0; z-index:20; overflow:hidden;"></div>
            </div>
            <div class="header" style="justify-content:space-around; background:var(--glass-bg); height:60px; border-top:1px solid rgba(0,0,0,0.1); font-size:12px;">
                <button class="btn-normal" style="background:transparent; color:var(--text-color); box-shadow:none;" onclick="addTextBox()">T æ–‡æœ¬</button>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="color" id="j-color-text" onchange="changeTextColor(this.value)" title="æ–‡æœ¬é¢œè‰²">
                    <input type="color" id="j-color-bg" onchange="changeBgColor(this.value)" title="èƒŒæ™¯é¢œè‰²">
                </div>
                <button class="btn-normal" onclick="toggleDrawer()">ğŸ¨ ç´ æç®±</button>
            </div>
            <div id="journal-drawer" class="journal-drawer-overlay">
                <div class="drawer-header">
                     <div class="drawer-tabs">
                        <div class="drawer-tab active" onclick="switchDrawerTab('stickers')">è´´çº¸</div>
                        <div class="drawer-tab" onclick="switchDrawerTab('papers')">çº¸å¼ </div>
                        <div class="drawer-tab" onclick="switchDrawerTab('fonts')">å­—ä½“</div>
                        <div class="drawer-tab" onclick="switchDrawerTab('custom')">è‡ªå®šä¹‰</div>
                    </div>
                    <button class="btn-secondary" style="padding:5px 10px; border-radius:10px; border:none;" onclick="toggleDrawer()">â–¼ æ”¶èµ·</button>
                </div>
                <div id="drawer-content" class="drawer-content"></div>
                <div id="drawer-custom-tool" style="padding:15px; border-top:1px dashed #ccc; display:none; flex-direction:column; gap:10px;">
                    <input id="custom-url" class="setting-input" placeholder="è¾“å…¥ URL (å›¾ç‰‡æˆ–å­—ä½“TTF)">
                    <div style="display:flex; gap:10px;">
                        <button class="btn-normal" onclick="addCustomAsset('image')">åŠ ä¸ºè´´çº¸</button>
                        <button class="btn-normal" onclick="addCustomAsset('font')">åŠ ä¸ºå­—ä½“</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
            <!-- å†›ä»¤çŠ¶ -->
    <div id="view-pledge" class="view-overlay"><div class="header"><button class="btn-icon" onclick="closeView('view-pledge')">âœ•</button> å†›ä»¤çŠ¶</div><div style="padding:20px; overflow-y:auto;">
        <div id="pledge-content-area"></div>
        <div style="margin-top:20px; text-align:center;">
            <button class="btn-normal" onclick="createNewPledge()">âœ‹ ç«‹ä¸‹å†›ä»¤çŠ¶</button>
        </div>
    </div></div>

    <!-- ä¹–å®å®é›†ç«  -->
    <div id="view-stamp" class="view-overlay"><div class="header"><button class="btn-icon" onclick="closeView('view-stamp')">âœ•</button> ä¹–å®å®é›†ç« </div><div style="padding:20px; display:flex; flex-direction:column; align-items:center;">
        <div class="stamp-grid" id="stamp-grid"></div>
        <div style="margin-top:20px; font-size:14px; opacity:0.7;">é›†æ»¡ 10 ä¸ªç« å¬å”¤å¥–åŠ±</div>
        <div style="margin-top:20px; width:100%; display:flex; gap:10px;">
            <button class="btn-normal" onclick="addStamp()">â• ç›–ç«  (å•ª!)</button>
            <button class="btn-normal btn-secondary" id="btn-redeem" style="display:none;" onclick="redeemStampReward()">ğŸ å…‘æ¢å…ç½ªé‡‘ç‰Œ</button>
        </div>
        <div id="stamp-reward-display" style="margin-top:20px; padding:15px; background:#fff8e1; border:2px dashed #ffb74d; border-radius:10px; display:none; font-family:'Ma Shan Zheng'; font-size:18px; width:100%; max-height:400px; overflow-y:auto;"></div>
    </div></div>

    <!-- è¯·ç¤ºå• -->
    <div id="view-permission" class="view-overlay"><div class="header"><button class="btn-icon" onclick="closeView('view-permission')">âœ•</button> è¯·ç¤ºå•</div><div style="padding:20px;">
        <div style="background:var(--card-bg); padding:20px; border-radius:20px; box-shadow:var(--shadow);">
            <label>å®¡æ‰¹å®˜ (Dom)</label><select id="perm-role" class="setting-input"></select>
            <label style="margin-top:10px; display:block;">ç”³è¯·äº‹é¡¹</label><textarea id="perm-content" class="setting-input" rows="3" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å–å¥¶èŒ¶..."></textarea>
            <button class="btn-normal" style="margin-top:15px;" onclick="submitPermission()">ğŸ“© æäº¤ç”³è¯·</button>
        </div>
        <div id="perm-result" style="margin-top:20px; display:none; padding:20px; border-radius:15px; text-align:center;"></div>
    </div></div>
    
        <!-- æ¢¦å¢ƒè§£æ -->
    <div id="view-dream" class="view-overlay">
    <div class="header"><button class="btn-icon" onclick="closeView('view-dream')">âœ•</button> æ¢¦å¢ƒè§£ææ‰€</div>
    <div style="padding:20px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:15px;"> 
        <textarea id="dream-input" class="setting-input" rows="5" placeholder="è®°å½•ä¸‹ä½ çš„æ¢¦å¢ƒ..."></textarea>
        <div style="display:flex; gap:10px;">
            <select id="dream-role" class="setting-input" style="flex:1; margin:0;"></select>
            <button class="btn-normal" style="width:auto;" onclick="interpretDream()">ğŸ”® è§£æ¢¦</button>
        </div>
        <div id="dream-result" style="font-family:'Ma Shan Zheng'; font-size:16px; line-height:1.6; color:#4a148c; padding-top:10px; border-top:1px dashed rgba(0,0,0,0.1);"></div>
    </div>
</div>

    <!-- å‘½è¿æ‰­è›‹ -->
    <div id="view-gacha" class="view-overlay"><div class="header"><button class="btn-icon" onclick="closeView('view-gacha')">âœ•</button> å‘½è¿æ‰­è›‹æœº</div><div style="padding:20px; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
        <div style="font-size:80px; margin-bottom:20px;" id="gacha-icon">ğŸ²</div>
        <div id="gacha-text" style="font-size:24px; font-weight:bold; margin-bottom:30px; text-align:center; min-height:60px;">ä¸çŸ¥é“å¹²ä»€ä¹ˆï¼Ÿ<br>æ‰­ä¸€ä¸‹ï¼</div>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-normal" onclick="spinGacha('food')">ğŸ± åƒä»€ä¹ˆ</button>
            <button class="btn-normal" onclick="spinGacha('act')">ğŸ® ç©ä»€ä¹ˆ</button>
        </div>
        <div style="font-size:12px; opacity:0.6; margin-top:20px;">* å« "Ask AI" å½©è›‹</div>
    </div></div>

    <!-- æ—¶å…‰æ…¢é€’ -->
    <div id="view-capsule" class="view-overlay"><div class="header"><button class="btn-icon" onclick="closeView('view-capsule')">âœ•</button> æ—¶å…‰æ…¢é€’</div><div style="padding:20px;">
        <div style="background:var(--card-bg); padding:15px; border-radius:15px; margin-bottom:20px;">
            <textarea id="cap-msg" class="setting-input" rows="3" placeholder="å†™ç»™æœªæ¥çš„è¯..."></textarea>
            <label style="font-size:12px;">è§£å°æ—¶é—´</label>
            <input id="cap-date" type="datetime-local" class="setting-input">
            <button class="btn-normal" style="margin-top:10px;" onclick="sealCapsule()">ğŸ”’ å°å­˜èƒ¶å›Š</button>
        </div>
        <div id="capsule-list"></div>
    </div></div>
    
        <!-- ç»æœŸåŠ©æ‰‹ -->
    <div id="view-period" class="view-overlay"><div class="header"><button class="btn-icon btn-back" onclick="closeView('view-period')">âœ•</button> <span>ç»æœŸåŠ©æ‰‹</span> <button class="btn-icon btn-add" onclick="addNewPeriodLog()">+</button></div><div style="padding:20px; overflow-y:auto;"><div class="period-header-card"><div style="font-size:14px; opacity:0.7;">å½“å‰çŠ¶æ€</div><div id="p-app-status" style="font-size:24px; font-weight:bold; margin:10px 0; color:#d32f2f;">--</div></div><div style="font-size:16px; font-weight:bold; margin-bottom:10px;">å†å²è®°å½•</div><div id="period-history-list"></div></div></div>
    
    <!-- é¥®é£Ÿ -->
    <div id="view-meals" class="view-overlay"><div class="header"><button class="btn-icon btn-close" onclick="closeView('view-meals')">âœ•</button> <span>å¥½å¥½åƒé¥­</span> <div style="width:40px"></div></div><div class="meal-app-container" style="padding:15px; overflow-y:auto;"><div class="meal-ai-tools"><button class="meal-ai-btn" onclick="askMealAI('recommend')">ğŸ‘¨â€ğŸ³ æ¨èé£Ÿè°±</button><button class="meal-ai-btn" onclick="askMealAI('critique_all')">ğŸ¥— ç‚¹è¯„å…¨å¤©</button><button class="meal-ai-btn" onclick="askMealAI('exchange')">ğŸ¥˜ äº¤æ¢é£Ÿè°±</button></div><div id="meal-ai-response" style="display:none; background:#fffbf0; padding:15px; border-radius:12px; margin-bottom:15px; border:1px dashed #eebb4d; color:#594a2a; font-size:14px; line-height:1.6;"></div><div id="meal-cards-area"></div></div></div>
    
    <!-- MindLog Pro (å·²ä¿®æ”¹ä¸Šä¼ é€»è¾‘) -->
    <div id="view-diary" class="view-overlay">
        <div class="header"><button class="btn-icon btn-close" onclick="closeView('view-diary')">âœ•</button> <span>MindLog Pro</span> <div style="width:40px"></div></div>
        <div class="diary-container">
            <div style="background:var(--card-bg); border-radius:24px; padding:20px; margin-bottom:20px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.4);">
                <div style="font-size:16px; font-weight:bold; margin-bottom:15px; color:var(--accent-color);">âœ¨ ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <input type="date" id="ml-date" style="border:none; background:transparent; font-weight:bold; color:var(--text-color); font-size:16px;">
                    <button class="btn-small" style="padding:6px 10px;" onclick="mlInsertTime()">â±ï¸ æ’å…¥æ—¶é—´</button><button class="btn-small" style="padding:6px 10px; margin-left:5px; background:#e0f7fa; color:#006064; border:1px solid #b2ebf2;" onclick="$('modal-reference').style.display='flex'">ğŸ“ å¼•ç”¨</button>
                </div>
                <textarea id="ml-input" style="width:100%; background:var(--input-bg); border:1px solid var(--input-border); padding:15px; border-radius:16px; font-size:15px; min-height:100px; color:var(--text-color);" placeholder="è®°å½•ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…..."></textarea>
                <!-- æ–°å¢æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ -->
                <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                    <label style="font-size:12px; color:var(--text-color);">æ’å…¥å›¾ç‰‡ (è‡ªåŠ¨å­˜å…¥æ•°æ®åº“):</label>
                    <input type="file" id="ml-file-upload" class="setting-input" accept="image/*" style="font-size:12px; padding:8px;">
                </div>
                <!-- å…¼å®¹æ—§çš„ URL è¾“å…¥ -->
                <input id="ml-img-url" class="setting-input" style="margin-top:5px; font-size:12px; display:none;" placeholder="æˆ–è€…è¾“å…¥å›¾ç‰‡ URL">
                <div style="display:flex; gap:10px; margin-top:10px;"><button class="btn-normal" onclick="mlSave()">ğŸ’¾ ä¿å­˜æ—¥è®°</button></div>
            </div>
            <div id="ml-list"></div>
        </div>
    </div>
    
            <!-- é€šè®¯å½• -->
    <div id="view-contacts" class="view-overlay"><div class="header"><button class="btn-icon btn-close" onclick="closeView('view-contacts')">âœ•</button> <span>é€šè®¯å½•</span><button class="btn-icon btn-add" onclick="editContact(null)">+</button></div><div id="contact-list" style="padding:15px;"></div></div>
    
    <!-- æ—¶å…‰ä¿¡ç®± -->
    <div id="view-letters" class="view-overlay"><div class="header"><button class="btn-icon btn-close" onclick="closeView('view-letters')">âœ•</button> <span>æ—¶å…‰ä¿¡ç®±</span> <div style="width:40px"></div></div><div style="padding:15px; overflow-y:auto;"><div style="background:var(--card-bg); padding:15px; border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow);"><select id="letter-role-select" class="setting-input"></select><button class="btn-normal" style="margin-top:10px;" onclick="generateLetter()">æŸ¥æ”¶æ–°ä¿¡ä»¶ (æ¶ˆè€—API)</button><div id="letter-result" style="display:none; margin-top:15px; background:var(--input-bg); padding:15px; border-radius:12px;"><div id="letter-content" style="font-family:'Ma Shan Zheng'; white-space:pre-wrap; font-size:16px; line-height:1.6; color:var(--text-color);"></div><button class="btn-normal" style="margin-top:10px;" onclick="saveLetter()">ğŸ“¥ å­˜å…¥ä¿¡ç®±</button></div></div><h4 style="margin:10px 0; opacity:0.7;">å·²æ”¶ä¿¡ä»¶</h4><div id="mailbox-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div></div></div>
    
    <!-- é‡‘åº“ -->
    <div id="view-vault" class="view-overlay"><div class="header"><button class="btn-icon btn-close" onclick="closeView('view-vault')">âœ•</button> <span>ç§å¯†é‡‘åº“</span> <div>ğŸ”’</div></div><div style="padding:15px; overflow-y:auto;" id="vault-content"></div></div>
    
        <!-- ä½“æ€ç®¡ç† (Weight Tracker) -->
    <div id="view-weight" class="view-overlay">
        <div class="header">
            <button class="btn-icon btn-close" onclick="closeView('view-weight')">âœ•</button> 
            <span>ä½“æ€ç®¡ç†</span> 
            <button class="btn-icon" onclick="renderWeightApp()">ğŸ”„</button>
        </div>
        <div style="padding:20px; overflow-y:auto; padding-bottom:80px;">
            
            <!-- æ›²çº¿å›¾åŒºåŸŸ -->
            <div class="weight-chart-box">
                <canvas id="weight-canvas"></canvas>
                <div style="position:absolute; top:10px; left:10px; font-size:10px; opacity:0.5;">è¿‘7æ¬¡è®°å½•</div>
            </div>
            
           
    
                        <!-- å½•å…¥åŒºåŸŸ -->
            <div class="weight-input-card">
                <h4 style="margin-top:0;">ä»Šæ—¥è®°å½•</h4>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:12px;">æ—¥æœŸ</label>
                        <input type="date" id="w-date" class="setting-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:12px;">ä½“é‡ (kg)</label>
                        <input type="number" id="w-num" class="setting-input" step="0.1" placeholder="0.0">
                    </div>
                </div>

                <div class="exercise-check-row">
                    <input type="checkbox" id="w-ex-check" style="width:20px; height:20px;" onchange="$('w-ex-desc').style.display = this.checked ? 'block' : 'none'">
                    <span style="font-weight:bold;">ä»Šå¤©è¿åŠ¨äº†å—ï¼Ÿ</span>
                </div>
                <input id="w-ex-desc" class="setting-input" placeholder="åšäº†ä»€ä¹ˆè¿åŠ¨ï¼Ÿ(å¦‚: è·‘æ­¥3km)" style="display:none; margin-bottom:10px;">

                <button class="btn-normal" onclick="saveWeightLog()">ğŸ“ è®°å½•ä¸€ä¸‹</button>
            </div>
            
                        <!-- å†å²åˆ—è¡¨ -->
            <h4 style="margin:10px 0; opacity:0.7;">å†å²è®°å½•</h4>
            <div id="weight-history-list" style="background:var(--card-bg); border-radius:12px;"></div>
        </div>
    </div>
    
        <!-- äº²æ˜µ (Touch) -->
    <div id="view-touch" class="view-overlay">
        <div class="header">
            <button class="btn-icon btn-close" onclick="closeView('view-touch')">âœ•</button> 
            <span>äº²æ˜µÂ·å¿ƒåŠ¨</span> 
            <button class="btn-icon" onclick="renderTouchCollection()">ğŸ“–</button>
        </div>
        <div class="touch-container">
            <!-- è§’è‰²é€‰æ‹© -->
            <div style="background: rgba(255,255,255,0.6); padding: 10px; border-radius: 12px; margin-bottom: 20px; width: 100%; display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; color: #880e4f;">å¯¹è±¡:</span>
                <select id="touch-role-select" class="setting-input" style="flex: 1; margin: 0; background: transparent; border: none;"></select>
            </div>

    <!-- ğŸ”¥ğŸ”¥ 2. æ–°å¢ï¼šæš§æ˜§å‡æ¸©è¿›åº¦æ¡ ğŸ”¥ğŸ”¥ -->
    <div class="heat-box">
        <div class="heat-header">
            <span>ğŸŒ¡ï¸ æš§æ˜§å‡æ¸©</span>
            <span id="heat-text">0%</span>
        </div>
        <div class="heat-track"><div id="heat-bar" class="heat-fill"></div></div>
    </div>
    
            <!-- å¿ƒè·³å›¾æ ‡ -->
            <div class="heart-beat-icon" onclick="sendTouchAction('å¿ƒè·³')">ğŸ’“</div>
            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 30px; color: #880e4f; text-align: center;">è§¦ç¢°å±å¹•ï¼Œä¼ é€’ä½ çš„å¿ƒæ„</div>

            <!-- åŠ¨ä½œæŒ‰é’®ç½‘æ ¼ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%;">
                <button class="touch-btn" onclick="sendTouchAction('æ‘¸å¤´')">ğŸ‘‹ æ‘¸æ‘¸å¤´</button>
                <button class="touch-btn" onclick="sendTouchAction('æ‹¥æŠ±')">ğŸ«‚ æŠ±ä¸€ä¸‹</button>
                <button class="touch-btn" onclick="sendTouchAction('ç‰µæ‰‹')">ğŸ¤ ç‰µæ‰‹æ‰‹</button>
                <button class="touch-btn" onclick="sendTouchAction('æˆ³è„¸')">ğŸ‘‰ æˆ³æˆ³è„¸</button>
                <button class="touch-btn" onclick="sendTouchAction('äº²å»')">ğŸ’‹ äº²ä¸€å£</button>
                <button class="touch-btn" onclick="sendTouchAction('æ’’å¨‡')">ğŸ¥º æ’’ä¸ªå¨‡</button>
                        <!-- ğŸ”¥ğŸ”¥ æ–°å¢ï¼šç¼ ç»µæŒ‰é’® (æ ·å¼æ›´æ˜¾çœ¼) ğŸ”¥ğŸ”¥ -->
        <button class="touch-btn" style="background:rgba(255,235,238,0.9); border-color:#ff5252; color:#d50000;" onclick="sendTouchAction('ç¼ ç»µ')">ğŸ”¥ ç¼ ç»µ</button>
            </div>
        </div>
    </div>
    
            <!-- è¯´æ˜ä¹¦ -->
    <div id="view-manual" class="view-overlay">
        <div class="header">
            <button class="btn-icon btn-close" onclick="closeView('view-manual')">âœ•</button> 
            <span>ä½¿ç”¨è¯´æ˜ä¹¦</span> 
            <div>ğŸ“˜</div>
        </div>
        <div style="padding:20px; overflow-y:auto; line-height:1.6; color:var(--text-color); font-size:14px; padding-bottom:80px;">
            
            <div style="background:#fff0f5; padding:15px; border-radius:15px; margin-bottom:20px; border:2px dashed #ff3b30; color:#c62828;">
                <h3 style="margin-top:0; display:flex; align-items:center; gap:5px;">
                    <span>ğŸš¨</span> <span>æ•°æ®å®‰å…¨è­¦å‘Š (å¿…è¯»)</span>
                </h3>
                <p><b>1. å›¾ç‰‡å­˜å‚¨åœ¨å“ªï¼Ÿ</b><br>
                å›¾ç‰‡å­˜å‚¨åœ¨æµè§ˆå™¨çš„ <b>IndexedDB</b> æ•°æ®åº“ä¸­ã€‚è¿™æ„å‘³ç€ï¼š<br>
                âŒ <b>åƒä¸‡ä¸è¦</b>ç‚¹å‡»æµè§ˆå™¨çš„â€œæ¸…é™¤ç¼“å­˜/æ¸…é™¤æ•°æ®â€ï¼<br>
                âŒ <b>å¸è½½æµè§ˆå™¨</b>ä¼šå¯¼è‡´å›¾ç‰‡æ°¸ä¹…ä¸¢å¤±ï¼<br>
                âŒ <b>æ— ç—•æ¨¡å¼</b>ä¸‹æ— æ³•ä¿å­˜æ•°æ®ï¼</p>
                
                <p><b>2. å…³äºå¤‡ä»½</b><br>
                è¯·åŠ¡å¿…å®šæœŸç‚¹å‡»è®¾ç½®é‡Œçš„ <b>[ğŸ“¤ å¯¼å‡ºå¤‡ä»½]</b>ã€‚<br>
                (æ³¨ï¼šè¯·ç¡®è®¤ä½ å·²æ›´æ–°äº†å¯¼å‡ºä»£ç ï¼Œå¦åˆ™æ—§ç‰ˆå¤‡ä»½åªåŒ…å«æ–‡å­—ï¼Œä¸åŒ…å«å›¾ç‰‡ï¼)</p>
            </div>

            <div style="background:var(--card-bg); padding:15px; border-radius:15px; margin-bottom:20px; box-shadow:var(--shadow);">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">ğŸ’¸ API vs æœ¬åœ° (çœé’±æ”»ç•¥)</h3>
                
                <div style="margin-bottom:10px;">
                    <span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-size:12px; font-weight:bold;">ğŸŸ¢ å…è´¹ (æœ¬åœ°è¿è¡Œ)</span>
                    <p style="margin:5px 0 0 0; font-size:13px; opacity:0.8;">
                        â€¢ <b>æ—¥è®°/æ‰‹è´¦ï¼š</b> å†™æ—¥è®°ã€è´´è´´çº¸ã€ä¸Šä¼ å›¾ç‰‡ã€‚<br>
                        â€¢ <b>å·¥å…·ç±»ï¼š</b> å€’è®¡æ—¶ã€å¾…åŠæ¸…å•ã€ç”Ÿç†æœŸè®°å½•ã€‚<br>
                        â€¢ <b>ç„å­¦ç±»ï¼š</b> æ¯æ—¥ä¸€å¦ã€å‘½è¿æ‰­è›‹ã€ä¹–å®å®é›†ç« ã€å†›ä»¤çŠ¶ã€‚<br>
                        â€¢ <b>ç§å¯†é‡‘åº“ï¼š</b> å­˜å…¥ç§˜å¯†ã€‚<br>
                        <i>è¿™äº›åŠŸèƒ½å®Œå…¨æ–­ç½‘ä¹Ÿèƒ½ç”¨ï¼Œä¸æ¶ˆè€— Keyã€‚</i>
                    </p>
                </div>

                <div style="margin-top:15px;">
                    <span style="background:#fff3e0; color:#e65100; padding:2px 6px; border-radius:4px; font-size:12px; font-weight:bold;">ğŸŸ¡ æ”¶è´¹ (æ¶ˆè€— API Key)</span>
                    <p style="margin:5px 0 0 0; font-size:13px; opacity:0.8;">
                        â€¢ <b>âœ¨ AI å›å¤ï¼š</b> è®© AI ç‚¹è¯„æ—¥è®°æˆ–æ‰‹è´¦ã€‚<br>
                        â€¢ <b>ğŸ”® è§£æ¢¦ï¼š</b> æ¢¦å¢ƒè§£ææ‰€ã€‚<br>
                        â€¢ <b>ğŸ“ è¯·ç¤ºå•ï¼š</b> æäº¤ç”³è¯·è®© Dom å®¡æ‰¹ã€‚<br>
                        â€¢ <b>ğŸ¥— é¥®é£Ÿç‚¹è¯„ï¼š</b> æ¨èé£Ÿè°±æˆ–äº¤æ¢é£Ÿè°±ã€‚<br>
                        â€¢ <b>ğŸ“¬ æ—¶å…‰ä¿¡ç®±ï¼š</b> æŸ¥æ”¶ AI å†™ç»™ä½ çš„æ–°ä¿¡ä»¶ã€‚<br>
                        <i>æç¤ºï¼šå°½é‡æ”’åœ¨ä¸€èµ·é—®ï¼Œæˆ–è€…åªåœ¨éœ€è¦æƒ…ç»ªä»·å€¼æ—¶ç‚¹å‡»ã€‚</i>
                    </p>
                </div>
            </div>

            <h3 style="margin:10px 0;">ğŸ® éšè—ç©æ³•</h3>
            <div style="font-size:13px; opacity:0.9;">
                <p><b>ğŸ¥‘ å¥½å¥½åƒé¥­ï¼š</b> åªæœ‰ç‚¹å‡»åº•éƒ¨çš„ã€ŒğŸ‘©â€ğŸ³ æ¨è/ç‚¹è¯„ã€æŒ‰é’®æ—¶æ‰ä¼šè°ƒç”¨ AIã€‚å¹³æ—¶åªè®°å½•æ˜¯å…è´¹çš„ã€‚</p>
                <p><b>ğŸ² å‘½è¿æ‰­è›‹ï¼š</b> å¦‚æœæ‰­åˆ°äº† "Ask AI"ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªè¾“å…¥æ¡†ï¼Œé‚£æ˜¯å½©è›‹ï¼Œä¼šæ¶ˆè€—ä¸€æ¬¡ APIã€‚</p>
                <p><b>ğŸŒ¸ ä¹–å®å®é›†ç« ï¼š</b> é›†æ»¡ 10 ä¸ªç« åï¼Œå…‘æ¢å¥–åŠ±æ—¶ä¼šæ¶ˆè€—ä¸€æ¬¡ API ç”Ÿæˆâ€œå…ç½ªé‡‘ç‰Œâ€ã€‚</p>
            </div>
        </div>
    </div>
    
 
<!-- è®¾ç½® (Settings View) -->
<!-- === æŒ‡ä»¤é›† APP ç•Œé¢ === -->
<div id="view-commands" class="view-overlay">
    <div class="header">
        <button class="btn-icon btn-close" onclick="closeView('view-commands')">âœ•</button> 
        <span>å…¨å±€æŒ‡ä»¤é›†</span> 
        <button class="btn-icon btn-add" onclick="openCommandModal()">+</button>
    </div>
    <div style="padding:15px; overflow-y:auto; padding-bottom:80px;">
        <div style="font-size:12px; opacity:0.6; margin-bottom:10px; text-align:center;">
            å­˜å‚¨ç ´é™è¯ã€è§„åˆ™è®¾å®šã€å¸¸ç”¨å’’è¯­
        </div>
        <div id="command-list-container"></div>
    </div>
</div>

<!-- === æ–°å¢æŒ‡ä»¤å¼¹çª— === -->
<div id="modal-command-add" class="modal">
    <div class="modal-card">
        <h3>æ–°å»ºæŒ‡ä»¤</h3>
        <input id="cmd-title" class="setting-input" placeholder="æ ‡é¢˜ (ä¾‹å¦‚: æ²‰ç¨³æ¨¡å¼)">
        <textarea id="cmd-content" class="setting-input" rows="6" placeholder="è¾“å…¥è¯¦ç»†çš„ Prompt / è§„åˆ™..."></textarea>
        <div class="btn-group">
            <button class="btn-normal btn-secondary" onclick="$('modal-command-add').style.display='none'">å–æ¶ˆ</button>
            <button class="btn-normal" onclick="saveNewCommand()">ä¿å­˜</button>
        </div>
    </div>
</div>
    <div id="view-settings" class="view-overlay">
        <div class="header">
            <button class="btn-icon btn-close" onclick="closeView('view-settings')">âœ•</button> 
            <span>è®¾ç½®</span>
        </div>
        <div style="padding:20px; overflow-y: auto;">
            <div class="glass" style="padding:20px; border-radius:20px;">
                <label>API Key</label>
                <div style="display:flex; gap:5px; margin-bottom:12px;">
                    <input id="api-key" class="setting-input" type="password" style="margin:0;">
                    <button class="btn-normal" style="width:auto; padding:0 12px; white-space:nowrap;" onclick="fetchModels()">è·å–æ¨¡å‹</button>
                </div>
                <label>API URL</label>
                <input id="api-url" class="setting-input" value="https://api.openai.com/v1">
                <label>æ¨¡å‹</label>
                <select id="model-select" class="setting-input">
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                </select>
                
                <label>ä¸»é¢˜</label>
                <select id="theme-select" class="setting-input" onchange="toggleTheme(this.value)">
                    <option value="theme-day">å¥¶æ²¹äº®è‰²</option>
                    <option value="theme-night">æ·±è‰²æ¨¡å¼</option>
                    <option value="theme-ios-light">ğŸ iOS ç£¨ç ‚ (ç™½)</option>
                    <option value="theme-ios-dark">ğŸ iOS ç£¨ç ‚ (é»‘)</option>
                    <option value="theme-apple">ğŸ è‹¹æœç”œå¿ƒ</option>
                    <option value="theme-pure">â˜ï¸ çº¯å‡€ç™½</option>
                    <option value="theme-strawberry">ğŸ“ è‰è“ç”œå¿ƒ</option>
                    <option value="theme-matcha">ğŸµ æŠ¹èŒ¶æ‹¿é“</option>
                    <option value="theme-ocean">ğŸŒŠ æµ·ç›è‹æ‰“</option>
                </select>

                <button class="btn-normal" style="margin-top:15px;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                
                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--icon-border);">
                
                <div style="display:flex; gap:10px;">
                    <button class="btn-normal" onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
                    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                    <button class="btn-secondary btn-normal" onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„ä»£ç è¢«æ­£ç¡®åœ°æ”¾åœ¨äº† phone-container å†…éƒ¨ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <!-- ======================================================= -->

    <!-- å…¨å±€é®ç½© (Seek Overlay) -->
    <div id="overlay-seek" onclick="this.style.display='none'">
        <div id="seek-text"></div>
        <div style="font-size:12px; opacity:0.6; margin-top:20px;">(ç‚¹å‡»å±å¹•å…³é—­)</div>
    </div>

    <!-- åŠŸå¾·å•†åº—å¼¹çª— -->
    <div id="modal-shop" class="modal">
        <div class="modal-card">
            <h3>åŠŸå¾·å•†åº—</h3>
            <div style="font-size:12px; margin-bottom:10px; color:var(--accent-color);">å½“å‰åŠŸå¾·: <span id="shop-merit-display">0</span></div>
            
            <div class="drawer-tabs" style="justify-content: center; margin-bottom: 15px;">
                <div class="drawer-tab active" onclick="switchShopTab('skin', this)">çš®è‚¤</div>
                <div class="drawer-tab" onclick="switchShopTab('effect', this)">ç‰¹æ•ˆ</div>
            </div>

            <div id="shop-list" class="shop-grid">
                <!-- JS åŠ¨æ€ç”Ÿæˆå•†å“ -->
            </div>

            <div class="btn-group">
                <button class="btn-normal btn-secondary" onclick="$('modal-shop').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šè‡ªå®šä¹‰å£çº¸ -->
    <div id="modal-theme-wp" class="modal">
       <div class="modal-card">
           <h3>ğŸ¨ è‡ªå®šä¹‰å£çº¸</h3>
           <div id="current-wp-preview" class="wp-preview">å½“å‰æ— å£çº¸</div>
           <input id="wp-url-input" class="setting-input" placeholder="è¾“å…¥å›¾ç‰‡ URL">
           <div style="font-size:12px; opacity:0.6; margin:5px 0;">- æˆ– -</div>
           <input type="file" id="wp-file-upload" class="setting-input" accept="image/*">
           
           <div class="btn-group">
               <button class="btn-normal btn-secondary" onclick="$('modal-theme-wp').style.display='none'">å…³é—­</button>
               <button class="btn-normal" onclick="saveCustomWallpaper()">åº”ç”¨</button>
           </div>
           <button class="btn-normal btn-danger" style="margin-top:10px;" onclick="clearCustomWallpaper()">æ¢å¤é»˜è®¤</button>
       </div>
    </div>

    <!-- è§†å›¾ï¼šæ¼‚æµç“¶å¤§æµ· -->
    <div id="view-bottle" class="view-overlay">
    <div class="header">
        <button class="btn-icon btn-close" onclick="closeView('view-bottle')">âœ•</button> 
        <span>å¿ƒæ„¿æ¼‚æµç“¶</span> 
        <div style="display:flex; gap: 5px;">
            <!-- ğŸ‘‡ æ”¹æˆäº†ç½‘å…œæŒ‰é’® -->
            <button class="btn-icon" onclick="openNetBag()">ğŸ•¸ï¸</button>
            <button class="btn-icon" onclick="$('modal-bottle-settings').style.display='flex'">âš™ï¸</button>
            <button class="btn-icon" onclick="$('modal-throw-bottle').style.display='flex'">â•</button>
        </div>
    </div>
    <div class="bottle-sea" id="bottle-sea-area">
        <div class="bottle-wave"></div>
    </div>
</div>
        
    <!-- å¼¹çª—ï¼šæ‰”ç“¶å­ -->
    <div id="modal-throw-bottle" class="modal">
        <div class="modal-card" style="text-align:left;">
            <h3 style="text-align:center;">æ‰”ä¸€ä¸ªæ¼‚æµç“¶</h3>
            <textarea id="bottle-content" class="setting-input" rows="3" placeholder="å†™ä¸‹ä½ çš„å¿ƒäº‹..."></textarea>
            
            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block;">è°èƒ½æ¡åˆ°ï¼Ÿ(å¤šé€‰)</label>
            <div class="char-select-grid" id="bottle-char-list"></div>

            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block;">ä½•æ—¶è¢«æ¡åˆ°ï¼Ÿ</label>
            <select id="bottle-time-select" class="setting-input">
                <option value="1">1åˆ†é’Ÿå (æµ‹è¯•ç”¨)</option>
                <option value="60">1å°æ—¶å</option>
                <option value="120">2å°æ—¶å</option>
                <option value="360">6å°æ—¶å (ç¡ä¸€è§‰)</option>
                <option value="720">12å°æ—¶å (æ˜å¤©)</option>
            </select>

            <div class="btn-group">
                <button class="btn-normal btn-secondary" onclick="$('modal-throw-bottle').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-normal" onclick="throwBottle()">æ‰”è¿›æµ·é‡Œ ğŸŒŠ</button>
            </div>
        </div>
    </div>

<!-- å¼¹çª—ï¼šæ¡ç“¶å­ (ä¿®å¤ç‰ˆï¼šæ–‡å­—æ»šåŠ¨ï¼ŒæŒ‰é’®å›ºå®š) -->
<!-- æ–°å¢ï¼šç½‘å…œæ”¶è—å¤¹å¼¹çª— -->
    <div id="modal-bottle-net" class="modal">
        <div class="modal-card" style="height: 80vh; display:flex; flex-direction:column;">
            <h3>ğŸ•¸ï¸ æ¼‚æµç“¶ç½‘å…œ</h3>
            <div style="font-size:12px; opacity:0.6; margin-bottom:10px;">
                æµ·é¢ä¸Šçš„å·²è¯»ç“¶å­ä¼šè¢«æåˆ°è¿™é‡Œ
            </div>
            
            <!-- åˆ—è¡¨åŒºåŸŸ -->
            <div id="net-list" style="flex:1; overflow-y:auto; padding:5px; text-align:left;">
                <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆåˆ—è¡¨ -->
            </div>

            <div class="btn-group" style="margin-top:10px; flex-shrink:0;">
                <button class="btn-normal" onclick="salvageBottles()">ğŸ£ ä¸€é”®æ‰“ææµ·é¢</button>
                <button class="btn-normal btn-secondary" onclick="$('modal-bottle-net').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- å¼¹çª—ï¼šæ¡ç“¶å­ (æ”¯æŒæ¢è‚¤ç‰ˆ) -->
    <div id="modal-read-bottle" class="modal">
        <!-- è¿™é‡Œçš„ class ä¼šè¢« JS åŠ¨æ€ä¿®æ”¹ï¼Œä¾‹å¦‚åŠ ä¸Š skin-pink -->
        <div id="read-bottle-card" class="modal-card bottle-modal-base skin-scroll">
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area" style="flex: 1; overflow-y: auto; padding: 25px;">
                <!-- å¤´éƒ¨ -->
                <div style="text-align:center; margin-bottom:20px; border-bottom: 1px dashed currentColor; padding-bottom:15px; opacity:0.8;">
                    <div style="font-size:32px;">ğŸš</div>
                    <h3 id="read-bottle-sender" style="margin:5px 0 0 0; font-family:'Ma Shan Zheng'; font-size:26px;">è§’è‰²å</h3>
                    <div id="read-bottle-time" style="font-size:12px; opacity:0.6; margin-top:5px;"></div>
                </div>

                <!-- ä½ çš„ç•™è¨€ -->
                <div class="my-note" style="text-align:left; padding: 12px; margin-bottom: 25px; font-size: 13px;">
                    <span style="opacity:0.7; font-weight:bold;">ä½ çš„å­—æ¡:</span><br>
                    <span id="read-bottle-my-content" style="font-style:italic; line-height:1.4;">...</span>
                </div>

                <!-- å›å¤å†…å®¹ -->
                <div id="read-bottle-reply" style="text-align: left; font-family: 'Ma Shan Zheng'; font-size: 20px; line-height: 1.8; min-height: 150px;"></div>
                <div style="height: 20px;"></div>
            </div>

            <!-- åº•éƒ¨æŒ‰é’® -->
            <div style="padding: 15px; text-align: center; flex-shrink: 0; opacity:0.9;">
                <button class="btn-normal btn-action" style="font-family: 'Ma Shan Zheng'; font-size: 18px; width:100%;" onclick="$('modal-read-bottle').style.display='none'">âœ¨ çè—æ­¤ä¿¡ âœ¨</button>
            </div>

        </div>
 
    
    </div>
    
           <!-- å¼¹çª—ï¼šæ¼‚æµç“¶è®¾ç½® (æ¢è‚¤) -->
    <div id="modal-bottle-settings" class="modal">
        <div class="modal-card">
            <h3>ğŸ¨ æ¼‚æµç“¶è£…æ‰®</h3>
            
            <label style="display:block; text-align:left; font-size:12px; font-weight:bold; margin-top:10px;">ğŸŒŠ å¤§æµ·èƒŒæ™¯</label>
            <div style="display:flex; gap:15px; margin-top:10px; justify-content:center;">
                <div class="skin-option bg-sea-day" onclick="setBottleSea('bg-sea-day', this)" title="æ™´ç©º">â˜€ï¸</div>
                <div class="skin-option bg-sea-sunset" onclick="setBottleSea('bg-sea-sunset', this)" title="é»„æ˜">ğŸŒ‡</div>
                <div class="skin-option bg-sea-night" onclick="setBottleSea('bg-sea-night', this)" title="é»‘å¤œ">ğŸŒ™</div>
                <div class="skin-option bg-sea-galaxy" onclick="setBottleSea('bg-sea-galaxy', this)" title="æ˜Ÿç©º">ğŸŒŒ</div>
            </div>

            <label style="display:block; text-align:left; font-size:12px; font-weight:bold; margin-top:20px;">ğŸ“œ ä¿¡çº¸é£æ ¼</label>
            <div style="display:flex; gap:15px; margin-top:10px; justify-content:center;">
                <div class="skin-option" style="background:#f4e4bc" onclick="setBottlePaper('skin-scroll', this)" title="å·è½´">ğŸ“œ</div>
                <div class="skin-option" style="background:#ffcdd2" onclick="setBottlePaper('skin-pink', this)" title="å°‘å¥³">ğŸŒ¸</div>
                <div class="skin-option" style="background:#333; color:#fff;" onclick="setBottlePaper('skin-dark', this)" title="æš—å¤œ">ğŸ•¶ï¸</div>
                <div class="skin-option" style="background:#fff; border:1px solid #ccc;" onclick="setBottlePaper('skin-simple', this)" title="æç®€">ğŸ“„</div>
            </div>

            <button class="btn-normal" style="margin-top:25px;" onclick="$('modal-bottle-settings').style.display='none'">ä¿å­˜è£…æ‰®</button>
        </div>
    </div>
</div>
<script>
    const $ = id => document.getElementById(id);
    
        // === RPG System ===
    const RPG_TITLES = ["èŒæ–°", "è§ä¹ ç”Ÿ", "è®°å½•è€…", "ç”Ÿæ´»å®¶", "å¤§å¸ˆ", "ä¼ è¯´", "åŠç¥", "ç¥"];
    function gainXP(amount) {
        DB.rpg.xp += amount;
        
        // å‡çº§é€»è¾‘
        const nextLv = DB.rpg.lv * 100;
        if (DB.rpg.xp >= nextLv) {
            DB.rpg.lv++;
            DB.rpg.xp = DB.rpg.xp - nextLv; // æº¢å‡ºç»éªŒä¿ç•™
            DB.rpg.title = RPG_TITLES[Math.min(DB.rpg.lv - 1, RPG_TITLES.length - 1)] || "ç¥";
            showToast(`ğŸ‰ å‡çº§å•¦ï¼Lv.${DB.rpg.lv} ${DB.rpg.title}`);
        } else {
            showToast(`XP +${amount}`);
        }
        
        localStorage.setItem('v29_rpg', JSON.stringify(DB.rpg));
        updateRPGDisplay();
    }

    function updateRPGDisplay() {
        if(!$('rpg-lv')) return;
        $('rpg-lv').innerText = `Lv.${DB.rpg.lv} ${DB.rpg.title}`;
        const percent = Math.min(100, (DB.rpg.xp / (DB.rpg.lv * 100)) * 100);
        $('rpg-bar').style.width = `${percent}%`;
    }

    function showToast(msg) {
        const div = document.createElement('div');
        div.className = 'xp-toast';
        div.innerHTML = `<span>âœ¨</span> ${msg}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    }
    
        // === On This Day (é‚£å¹´ä»Šæ—¥) ===
    async function checkOnThisDay() {
        // å¿…é¡»ç­‰æ•°æ®åº“åŠ è½½å®Œ
        if (!DB.diaries || DB.diaries.length === 0) return;

        const today = new Date();
        const tMonth = today.getMonth() + 1; // 0-11 -> 1-12
        const tDate = today.getDate();
        const tYear = today.getFullYear();

        // å¯»æ‰¾åŒ¹é…ï¼šåŒæœˆåŒæ—¥ï¼Œä½†å¹´ä»½ä¸åŒ
        const match = DB.diaries.find(d => {
            const entryDate = new Date(d.date);
            return entryDate.getMonth() + 1 === tMonth && 
                   entryDate.getDate() === tDate && 
                   entryDate.getFullYear() !== tYear;
        });

        if (match) {
            const matchDate = new Date(match.date);
            const yearsAgo = tYear - matchDate.getFullYear();
            
            $('otd-date-display').innerText = `${tMonth}æœˆ${tDate}æ—¥`;
            $('otd-year-display').innerText = `${matchDate.getFullYear()}å¹´ (${yearsAgo}å¹´å‰)`;
            $('otd-content-display').innerText = match.content.substring(0, 100) + (match.content.length > 100 ? '...' : '');
            
                        // å»¶è¿Ÿä¸€ç‚¹å¼¹å‡ºï¼Œç»™ç”¨æˆ·æƒŠå–œ
            setTimeout(() => {
                $('modal-otd').style.display = 'flex';
            }, 1000);
        }
    }
    
    // === Dexie Database Initialization ===
    const db = new Dexie('MyOS_DB');
    db.version(1).stores({
        diaries: 'id, date', // ç´¢å¼•å­—æ®µï¼šid, date. content, images, comments å­˜å‚¨åœ¨å¯¹è±¡ä¸­
        settings: 'key' // é”®å€¼å¯¹å­˜å‚¨ï¼škey='widgetBg'
    });

    const DB = {
        weightLogs: JSON.parse(localStorage.getItem('v32_weight')) || [],
                touchHistory: JSON.parse(localStorage.getItem('v33_touch_history')) || [],
    commands: JSON.parse(localStorage.getItem('v31_commands')) || [],
            rpg: JSON.parse(localStorage.getItem('v29_rpg')) || { lv: 1, xp: 0, title: 'èŒæ–°' },
        settings: JSON.parse(localStorage.getItem('v16_set')) || { url:'https://api.openai.com/v1', key:'', model:'gpt-4o', theme:'theme-day' },
        contacts: JSON.parse(localStorage.getItem('v15_con')) || [{id:1, name:'æœªæ¥çš„è‡ªå·±', prompt:'æ¸©æŸ”ã€æˆç†Ÿ', history:[]}],
        todos: JSON.parse(localStorage.getItem('v15_todo')) || [],
        widgetImg: '', // å°†ä» IndexedDB åŠ è½½
        meals: JSON.parse(localStorage.getItem('v15_meals')) || { items: { breakfast:[], lunch:[], dinner:[], snack:[] }, reply: {} },
        diaries: [], // å°†ä» IndexedDB åŠ è½½
        letters: JSON.parse(localStorage.getItem('v15_letters')) || [],
        journals: JSON.parse(localStorage.getItem('v15_journals')) || [],
        extras: JSON.parse(localStorage.getItem('v15_extras')) || { mood: 'calm', fridge: '', cdText:'è§é¢', cdDate: new Date().toISOString().split('T')[0] },
        doodle: localStorage.getItem('v18_doodle') || '',
        period: JSON.parse(localStorage.getItem('v19_period')) || { history: [] }, 
        customStickers: JSON.parse(localStorage.getItem('v18_custom_stickers')) || [],
        vault: JSON.parse(localStorage.getItem('v20_vault')) || [],
        divination: JSON.parse(localStorage.getItem('v20_divination')) || { date: '', result: null },
        pledges: JSON.parse(localStorage.getItem('v25_pledges')) || [],
        stampCount: parseInt(localStorage.getItem('v25_stamps') || '0'),
        lastStampDate: localStorage.getItem('v26_last_stamp') || '',
        capsules: JSON.parse(localStorage.getItem('v25_capsules')) || [],
        customAssets: JSON.parse(localStorage.getItem('v26_assets')) || { stickers: [], fonts: [] },
            moodHistory: JSON.parse(localStorage.getItem('v30_mood_pixels')) || [], 
    merit: parseInt(localStorage.getItem('v30_merit') || '0'), /* âœ… è¿™é‡Œè¡¥ä¸Šäº†ä¸€ä¸ªé€—å· */
    businessCard: JSON.parse(localStorage.getItem('v34_card')) || {
        front: { name: 'ä½ çš„åå­—', bio: '@è‡ªå®šä¹‰ãƒ»ç‚¹å‡»ç¿»è½¬', avatar: '', fontUrl: '' },
        back: { name: 'Ta çš„åå­—', bio: 'ä¸€å¥å–œæ¬¢çš„è¯', avatar: '', fontUrl: '' }
    }
}; /* âœ… è¿™é‡Œåˆ æ‰äº†ä¸€ä¸ªå¤šä½™çš„ }; */
    
        const ASSETS = {
        stickers: ["https://cdn-icons-png.flaticon.com/128/4193/4193235.png", "https://cdn-icons-png.flaticon.com/128/4193/4193286.png", "https://cdn-icons-png.flaticon.com/128/2550/2550266.png", "https://cdn-icons-png.flaticon.com/128/616/616430.png", "https://cdn-icons-png.flaticon.com/128/616/616554.png", "https://cdn-icons-png.flaticon.com/128/1048/1048944.png", "https://cdn-icons-png.flaticon.com/128/3209/3209265.png", "https://cdn-icons-png.flaticon.com/128/2916/2916115.png"],
        papers: [{name: "çº¯ç™½", val: "#fff"}, {name: "ç‚¹é˜µ", val: "radial-gradient(#ccc 1px, transparent 1px) 0 0 / 20px 20px #fff"}, {name: "æ–¹æ ¼", val: "linear-gradient(#e5e5e5 1px, transparent 1px) 0 0 / 20px 20px, linear-gradient(90deg, #e5e5e5 1px, transparent 1px) 0 0 / 20px 20px #fff"}, {name: "ç‰›çš®çº¸", val: "#f0e6d2"}, {name: "ç²‰è‰²", val: "#fff0f5"}],
        fonts: [
            {name: "é»˜è®¤", val: "sans-serif"}, 
            {name: "æ‰‹å†™", val: "'Ma Shan Zheng', cursive"},
            {name: "è‹±æ–‡èŠ±ä½“", val: "'Zeyada', cursive"},
            {name: "å®‹ä½“", val: "'Noto Serif SC', serif"},
            {name: "é•¿ä»“ç¬”æ„", val: "'Long Cang', cursive"},
            {name: "æµäº‘", val: "'Liu Jian Mao Cao', cursive"},
            {name: "ç‹‚è‰", val: "'Zhi Mang Xing', cursive"}
        ],
        gachaFood: ["éº»è¾£çƒ«", "èºè›³ç²‰", "è½»é£Ÿæ²™æ‹‰", "æ—¥æ–™", "éŸ©å¼ç‚¸é¸¡", "è‡ªå·±ç…®é¢", "ä¸åƒäº†å‡è‚¥", "ä¾¿åˆ©åº—", "ç«é”…"],
        gachaAct: ["å†™ä»£ç ", "çœ‹ä¹¦30åˆ†é’Ÿ", "åš20ä¸ªæ·±è¹²", "ç¡è§‰", "æ‰“æ‰«å«ç”Ÿ", "å¬æ’­å®¢", "Ask AI"],
        guidance: ["æ·±å‘¼å¸ï¼Œå¬æˆ‘çš„ã€‚", "ä¹–ï¼Œå»ç¡è§‰ï¼Œä¸è¦ç†¬å¤œã€‚", "åˆ«æ€•ï¼Œæˆ‘åœ¨ä½ èº«åã€‚", "ç°åœ¨ï¼Œæ”¾ä¸‹æ‰‹æœºï¼Œé—­ä¸Šçœ¼ã€‚", "ä½ åšå¾—å¤Ÿå¥½äº†ã€‚", "ä¸å‡†èƒ¡æ€ä¹±æƒ³ã€‚", "ç›¸ä¿¡ç›´è§‰ã€‚", "æŠ¬å¤´ï¼Œä½ å¯ä»¥çš„ã€‚", "å–æ¯æ°´ï¼Œå†·é™ä¸‹æ¥ã€‚", "æˆ‘çš„å¥³å­©ï¼Œä¸è¦å“­ã€‚", "å»åƒç‚¹å¥½åƒçš„ã€‚", "å¤©å¡Œä¸‹æ¥æœ‰é«˜ä¸ªå­é¡¶ç€ã€‚", "å»æ´—ä¸ªçƒ­æ°´æ¾¡ã€‚", "ä½ æ˜¯æœ€çè´µçš„ã€‚", "æˆ‘åœ¨ï¼Œä¸€ç›´éƒ½åœ¨ã€‚"],
        hexagrams: ["å¤§å‰", "ä¸­å‰", "å°å‰", "å¹³", "å¾…æœº", "åŠªåŠ›"] 
    };
    
        // Helper: Base64 to Blob
    function base64ToBlob(base64) {
        if (!base64 || !base64.startsWith('data:')) return null;
        try {
            const arr = base64.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){ u8arr[n] = bstr.charCodeAt(n); }
            return new Blob([u8arr], {type:mime});
        } catch(e) { return null; }
    }

        window.onload = async () => {
    // ... åŸæœ‰çš„ä»£ç  ...
    
    // åŠ è½½è‡ªå®šä¹‰å£çº¸
    await loadCustomWallpaper();

    // åŠ è½½æ¼‚æµç“¶æ•°æ®
    const savedBottles = localStorage.getItem('v30_bottles');
    if (savedBottles) DB.bottles = JSON.parse(savedBottles);
    

        // === ä¿®å¤ç‰ˆï¼šæ•°æ®æ¬å®¶é€»è¾‘ ===
        // 1. è¿ç§»æ—¥è®°
        const oldDiaries = localStorage.getItem('v15_diary');
        if (oldDiaries) {
            const parsed = JSON.parse(oldDiaries);
            if (parsed.length > 0) {
                console.log("æ­£åœ¨è¿ç§»æ—¥è®°...");
                for (const d of parsed) {
                    if (d.img && d.img.startsWith('data:')) {
                        d.imgBlob = base64ToBlob(d.img); 
                        d.img = null; 
                    }
                    await db.diaries.put(d);
                }
                localStorage.removeItem('v15_diary'); // åˆ æ‰æ—§æ—¥è®°
            }
        }
        
        // 2. è¿ç§»å°é¢å›¾ (è¿™é‡Œæ˜¯å‡ºBugçš„åœ°æ–¹ï¼Œå·²ä¿®å¤)
        const oldImg = localStorage.getItem('v15_img');
        if (oldImg && oldImg.startsWith('data:')) {
            // å¦‚æœæ˜¯æ—§çš„ Base64 å›¾ç‰‡
            const blob = base64ToBlob(oldImg);
            await db.settings.put({key: 'widgetBg', value: blob});
            localStorage.removeItem('v15_img'); // ğŸŸ¢ è¿™ä¸€è¡Œä¹‹å‰æœ‰
        } else if (oldImg) {
            // å¦‚æœæ˜¯ URL é“¾æ¥
            await db.settings.put({key: 'widgetBg', value: oldImg});
            localStorage.removeItem('v15_img'); // ğŸŸ¢ è¡¥ä¸Šäº†è¿™ä¸€è¡Œï¼æ¬å®Œå°±åˆ ï¼
        }
        
        // === åŠ è½½æ•°æ® ===
        DB.diaries = await db.diaries.toArray();
        
        // è¯»å–å°é¢å›¾
        const bgSetting = await db.settings.get('widgetBg');
        if (bgSetting) {
            if (bgSetting.value instanceof Blob) {
                DB.widgetImg = URL.createObjectURL(bgSetting.value);
            } else {
                DB.widgetImg = bgSetting.value;
            }
        }

        // === åˆå§‹åŒ– UI (ä¿æŒä¸å˜) ===
        $('api-url').value = DB.settings.url; $('api-key').value = DB.settings.key; 
        $('theme-select').value = DB.settings.theme;
        const ms = $('model-select'); if(DB.settings.model && !Array.from(ms.options).some(o=>o.value===DB.settings.model)) ms.add(new Option(DB.settings.model, DB.settings.model)); ms.value = DB.settings.model;
        toggleTheme(DB.settings.theme); 
        if(DB.widgetImg) setWidgetBg(DB.widgetImg);

        updateTime(); setInterval(updateTime, 1000); initBattery(); 
        renderTodosWidget(); renderContacts(); renderMealsApp(); renderDiaryList(); renderExtras(); renderJournalShelf(); updateHisStatus(); initDoodle(); renderPeriodWidget(); checkDivinationStatus();
        renderStampGrid(); renderPledges(); renderCapsules(); renderMailbox();
        loadCustomFonts();
        $('ml-date').valueAsDate = new Date();
                // Init V30
        $('merit-count').innerText = `åŠŸå¾·: ${DB.merit || 0}`;
        renderMoodPixels();
                updateRPGDisplay(); // åˆå§‹åŒ–æ˜¾ç¤ºç­‰çº§
        checkOnThisDay();   // æ£€æŸ¥é‚£å¹´ä»Šæ—¥
    };

    
    // === Core UI ===
    const updateTime = () => $('clock-time').innerText = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
    function initBattery() { if(navigator.getBattery) navigator.getBattery().then(b=>{const u=()=>{const p=Math.round(b.level*100);$('battery-text').innerText=p+'%';$('battery-fill').style.width=p+'%';};u();b.addEventListener('levelchange',u);}); }
    function toggleTheme(t) { document.body.className = document.body.className.replace(/theme-[\w-]+/g, ''); document.body.classList.add(t); DB.settings.theme=t; localStorage.setItem('v16_set', JSON.stringify(DB.settings)); }
    const openView = id => { 
        $(id).classList.add('active'); 
        
        // --- æ ¹æ®ä¸åŒé¡µé¢ï¼Œæ‰§è¡Œä¸åŒçš„åˆå§‹åŒ–å‡½æ•° ---
        if(id==='view-letters') { updateRoleSelects(); renderMailbox(); }
        if(id==='view-permission' || id==='view-dream') updateRoleSelects();
        if(id==='view-period') renderPeriodApp();
        if(id==='view-vault') checkVault();
        if(id==='view-capsule') renderCapsules();
        if(id==='view-diary') renderDiaryList(); 
        if(id==='view-pledge') renderPledges();
        
        
        // å®‰å…¨é€»è¾‘
        if(id==='view-commands') renderCommandList();
        
        // ä½“é‡é€»è¾‘
        if(id==='view-weight') {
            setTimeout(renderWeightApp, 50); 
        }

        // â¤ï¸ æ–°å¢ï¼šäº²æ˜µ APP åˆå§‹åŒ–
        if(id==='view-touch') {
            initTouchApp();
        }
    };
    const closeView = id => $(id).classList.remove('active');
        function updateDots() { 
        const sl = $('scroll-container').scrollLeft; 
        const w = window.innerWidth; 
        const p = Math.round(sl / w) + 1;
        for(let i=1; i<=6; i++) {
            const d = $(`dot-${i}`);
            if(d) d.className = (i === p) ? 'dot active' : 'dot';
        }
    }
    function openCustomPrompt(title, callback, placeholder="") { $('prompt-title').innerText = title; $('prompt-input').value = ''; $('prompt-input').placeholder = placeholder; $('modal-prompt').style.display = 'flex'; $('prompt-input').focus(); promptCallback = callback; }
    function closeCustomPrompt() { $('modal-prompt').style.display = 'none'; promptCallback = null; }
    let promptCallback = null; $('prompt-confirm-btn').onclick = () => { if (promptCallback) { const val = $('prompt-input').value; promptCallback(val); } closeCustomPrompt(); };
    function updateRoleSelects() { 
        const opts = DB.contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); 
        if($('letter-role-select')) $('letter-role-select').innerHTML = opts;
        if($('perm-role')) $('perm-role').innerHTML = opts;
        if($('dream-role')) $('dream-role').innerHTML = opts;
    }
    
        // === REFACTORED: Widget Photo Logic (Using Dexie) ===
    function openPhotoSettings() { 
        $('modal-photo').style.display = 'flex'; 
        $('photo-url-input').value = ''; 
        $('bg-upload').value = ''; // æ¯æ¬¡æ‰“å¼€æ—¶æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œé˜²æ­¢é‡å¤æäº¤
    }
    
    async function savePhotoSetting() { 
        const urlInput = $('photo-url-input').value.trim(); 
        const fileInput = $('bg-upload'); 
        let newImageSrc = null;

        if (fileInput.files && fileInput.files[0]) { 
            // ä¼˜å…ˆå¤„ç†æ–‡ä»¶ä¸Šä¼ 
            const file = fileInput.files[0];
            await db.settings.put({key: 'widgetBg', value: file});
            // ä¸ºé˜²æ­¢æ—§çš„ blob URL ç¼“å­˜ï¼Œå…ˆé‡Šæ”¾æ‰
            if (DB.widgetImg && DB.widgetImg.startsWith('blob:')) {
                URL.revokeObjectURL(DB.widgetImg);
            }
            newImageSrc = URL.createObjectURL(file);
        } 
        else if (urlInput) {
            // å¤„ç† URL è¾“å…¥
            await db.settings.put({key: 'widgetBg', value: urlInput});
            newImageSrc = urlInput;
        }

        if (newImageSrc) {
            DB.widgetImg = newImageSrc; // æ›´æ–°å†…å­˜ä¸­çš„å›¾ç‰‡æº
            applyImg();
        } else {
            // å¦‚æœç”¨æˆ·ä»€ä¹ˆéƒ½æ²¡è¾“å…¥å°±ç‚¹äº†ç¡®å®šï¼Œåˆ™ç›´æ¥å…³é—­å¼¹çª—
            $('modal-photo').style.display = 'none';
        }
    }

    // æ–°å¢ï¼šæ¸…é™¤å°é¢å›¾çš„å‡½æ•°
    async function clearPhotoSetting() {
        if (confirm("ç¡®å®šè¦ç§»é™¤å°é¢å›¾å—ï¼Ÿ")) {
            await db.settings.delete('widgetBg'); // ä»æ•°æ®åº“åˆ é™¤
            
            // å¦‚æœå½“å‰æ˜¯ blob URLï¼Œä»å†…å­˜ä¸­é‡Šæ”¾
            if (DB.widgetImg && DB.widgetImg.startsWith('blob:')) {
                URL.revokeObjectURL(DB.widgetImg);
            }
            
            DB.widgetImg = ''; // æ¸…ç©ºå†…å­˜å˜é‡
            setWidgetBg(null); // æ›´æ–°UI
            $('modal-photo').style.display = 'none';
        }
    }
    
    function applyImg() { 
        setWidgetBg(DB.widgetImg); 
        $('modal-photo').style.display = 'none'; 
    }

    function setWidgetBg(src) { 
        const photoWidget = $('widget-photo');
        if(!src) {
             photoWidget.style.backgroundImage = '';
             photoWidget.querySelector('.photo-placeholder').style.display = 'flex';
        } else {
             photoWidget.style.backgroundImage = `url('${src}')`; 
             photoWidget.querySelector('.photo-placeholder').style.display = 'none'; 
        }
    }
    
        // === REFACTORED: MindLog Pro Logic (Using Dexie) ===
    function mlInsertTime() { $('ml-input').value += new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}) + ' '; }
    
    // === 1. ä¿å­˜æ—¥è®° (å·²ä¿®å¤æ‹¬å·é—®é¢˜) ===
    async function mlSave() { 
        const t = $('ml-input').value; 
        const fileInput = $('ml-file-upload');
        const urlInput = $('ml-img-url').value; 
        
        if(!t && !fileInput.files[0] && !urlInput) return; 

        // æŒ‰é’®å˜æ€é˜²æ­¢é‡å¤ç‚¹å‡»
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        try {
            let finalBlob = null;
            // å¦‚æœæœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œå…ˆè¿›è¡Œå‹ç¼©
            if (fileInput.files[0]) {
                finalBlob = await compressImage(fileInput.files[0], 1024, 0.7);
            }

            const newEntry = {
                id: Date.now(),
                date: $('ml-date').value,
                content: t,
                comments: [],
                img: urlInput || null, 
                imgBlob: finalBlob
            };

            await db.diaries.add(newEntry);
                        gainXP(10); // å†™æ—¥è®° +10 XP
            DB.diaries.unshift(newEntry);
            
            $('ml-input').value=''; 
            $('ml-img-url').value=''; 
            fileInput.value = ''; 
            renderDiaryList(); 

        } catch(e) {
            alert("ä¿å­˜å¤±è´¥ï¼š" + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    } // <--- è¿™ä¸ªå¤§æ‹¬å·éå¸¸é‡è¦ï¼å®ƒç»“æŸäº† mlSave å‡½æ•°

    // === 2. åˆ é™¤æ—¥è®° (ç¡®ä¿å®ƒåœ¨å¤–é¢ï¼Œå¹¶ä¸”èƒ½æ­£å¸¸å·¥ä½œ) ===
    async function deleteDiary(id) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢ç‚¹åˆ é™¤æ—¶è§¦å‘å¡ç‰‡å±•å¼€/æŠ˜å 
        if (event) event.stopPropagation();

        if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ(ä¸å¯æ¢å¤)")) {
            try {
                // ç¡®ä¿ id æ˜¯æ•°å­—ç±»å‹ï¼ˆDexie çš„ key æ˜¯æ•°å­—ï¼‰
                const numId = Number(id);
                
                await db.diaries.delete(numId); // ä»æ•°æ®åº“åˆ é™¤
                DB.diaries = DB.diaries.filter(d => d.id !== numId); // ä»å†…å­˜åˆ é™¤
                
                renderDiaryList(); // åˆ·æ–°åˆ—è¡¨
                alert("å·²åˆ é™¤ ğŸ—‘ï¸");
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥: " + e.message);
            }
        }
    }


   

    // Save Comments (AI Reply) to Dexie
    async function updateDiaryInDB(diary) {
        await db.diaries.put(diary);
    }
    
    let activeDiaryForReply = null;
    let openedDiaryIds = new Set(); 

    function toggleDiaryCard(id) {
        const card = document.getElementById(`diary-card-${id}`);
        if(card) {
            card.classList.toggle('open');
            if(card.classList.contains('open')) openedDiaryIds.add(id);
            else openedDiaryIds.delete(id);
        }
    }

    function renderDiaryList() {
        const list = $('ml-list');
        list.innerHTML = '';
        
        const grouped = {};
        DB.diaries.forEach(d => {
            if(!grouped[d.date]) grouped[d.date] = [];
            grouped[d.date].push(d);
        });
        
        
        Object.keys(grouped).sort().reverse().forEach(date => {
            list.innerHTML += `<div style="font-size:14px; font-weight:bold; margin:20px 0 10px 5px; opacity:0.6;">ğŸ—“ ${date}</div>`;
            grouped[date].sort((a,b)=>b.id-a.id).forEach(d => {
                const commentsHtml = (d.comments || []).map(c => `
                    <div class="comment-bubble" style="${c.isTyping ? 'opacity:0.6; font-style:italic;' : ''}">
                        <span class="comment-role ${c.role==='AI'?'role-ai':'role-user'}">${c.name}:</span>
                        <span>${c.text}</span>
                    </div>`).join('');
                
                const time = new Date(d.id).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
                const preview = d.content.substring(0, 15) + (d.content.length>15?"...":"");
                const isOpen = openedDiaryIds.has(d.id);

                // Handle Image Display (Blob or URL)
                let imgSrc = '';
                if (d.imgBlob) {
                    imgSrc = URL.createObjectURL(d.imgBlob);
                } else if (d.img) {
                    imgSrc = d.img;
                }
                
                                const cardHTML = `
                <div class="diary-card ${isOpen ? 'open' : ''}" id="diary-card-${d.id}">
                    <div class="diary-header-row" onclick="toggleDiaryCard(${d.id})">
                        <div class="d-meta">
                            <span class="d-time">${time}</span>
                            <span class="d-preview">${preview}</span>
                        </div>
                        <div class="d-arrow">â–¼</div>
                    </div>
                    <div class="diary-body">
                        ${imgSrc ? `<img src="${imgSrc}" class="d-image">` : ''}
                        <div class="d-content-text">${d.content}</div>
                                                ${commentsHtml ? `<div class="ai-section">
                            ${commentsHtml}
                            <div style="text-align:right; margin-top:8px; padding-top:5px; border-top:1px dashed rgba(0,0,0,0.1);">
                                <button class="btn-small" style="font-size:12px; padding:4px 10px; background:var(--bg-color); border:1px solid var(--accent-color); color:var(--text-color);" onclick="userReplyToComment(event, ${d.id})">â†©ï¸ å›å¤ AI</button>
                            </div>
                        </div>` : ''}
                        <div class="d-actions">
                            <button class="btn-small btn-danger" onclick="deleteDiary(${d.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                            <button class="btn-small" style="background:var(--accent-color); color:#fff;" onclick="openDiaryAIReply(event, ${d.id})">âœ¨ AI å›å¤</button>
                        </div>
                    </div>
                </div>`;
                list.innerHTML += cardHTML;
            });
        });
    }
    
        function openDiaryAIReply(event, diaryId) {
        event.stopPropagation(); 
        activeDiaryForReply = diaryId;
        replyTarget = 'diary';
        if(!openedDiaryIds.has(diaryId)) {
            toggleDiaryCard(diaryId);
        }
        const s = $('role-select-input');
        s.innerHTML = DB.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        $('modal-role-select').style.display = 'flex';
    }
    
    
    // === AI Reply Logic ===
    // === å‡çº§ç‰ˆ AI å›å¤é€»è¾‘ (æ”¯æŒçœ‹å›¾ï¼) ===
$('role-select-confirm').onclick = async () => {
    const cid = $('role-select-input').value;
    const role = DB.contacts.find(c => c.id == cid);
    $('modal-role-select').style.display = 'none';
    
    if (!role) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²");
    
    // ===========================
    // åˆ†æ”¯ 1: æ‰‹è´¦ AI (ä¿æŒä¸å˜)
    // ===========================
    if (replyTarget === 'journal') {
        askJournalAI(role);
    } 
    
    // ===========================
    // åˆ†æ”¯ 2: é¥®é£Ÿ AI (é›†æˆä½“é‡é€»è¾‘)
    // ===========================
    else if (replyTarget === 'meal') {
        const aiBox = $('meal-ai-response');
        aiBox.style.display = 'block';
        aiBox.innerText = `${role.name} æ­£åœ¨æŸ¥çœ‹ä½ çš„ä½“é‡è®°å½•å’Œèœå•...`;
        
        // --- è·å–ä½“é‡æ•°æ® ---
        const sortedWeights = [...DB.weightLogs].sort((a,b) => new Date(b.date) - new Date(a.date));
        const latest = sortedWeights[0];
        const previous = sortedWeights[1];
        
        let healthContext = "ç”¨æˆ·æš‚æ— ä½“é‡è®°å½•ã€‚";
        if (latest) {
            healthContext = `ç”¨æˆ·å½“å‰ä½“é‡: ${latest.weight}kg (æ—¥æœŸ: ${latest.date})ã€‚`;
            // è®¡ç®—è¶‹åŠ¿
            if (previous) {
                const diff = (latest.weight - previous.weight).toFixed(1);
                if (diff < 0) healthContext += ` ç›¸æ¯”ä¸Šæ¬¡å‡è½»äº† ${Math.abs(diff)}kg (å¾ˆæ£’)ã€‚`;
                else if (diff > 0) healthContext += ` ç›¸æ¯”ä¸Šæ¬¡é‡äº† ${diff}kgã€‚`;
                else healthContext += ` ä½“é‡æ— å˜åŒ–ã€‚`;
            }
            // æ£€æŸ¥è¿åŠ¨
            if (latest.exercise) {
                healthContext += ` ä»Šå¤©å·²åšè¿åŠ¨: "${latest.exercise}"ã€‚`;
            } else {
                healthContext += ` ä»Šå¤©è®°å½•æ˜¾ç¤ºæš‚æœªè¿åŠ¨ã€‚`;
            }
        }
        // --------------------
        
                let prompt = "";
        const itemsJSON = JSON.stringify(DB.meals.items);
        
        // é€šç”¨äººè®¾å‰ç¼€
        const basePersona = `ä½ ç°åœ¨æ‰®æ¼”ç”¨æˆ·çš„"${role.name}"ã€‚äººè®¾å¦‚ä¸‹ï¼š${role.prompt}ã€‚
        ã€é‡è¦åŸåˆ™ã€‘ï¼š
        1. å¿…é¡»å®Œå…¨ç¬¦åˆäººè®¾çš„è¯­æ°”ï¼ˆå¦‚æœæ˜¯ä¸¥å‰çš„å°±ä¸¥å‰ï¼Œæ¸©æŸ”çš„å°±æ¸©æŸ”ï¼‰ã€‚
        2. å…³æ³¨å¥åº·ï¼Œä¸è¦å•çº¯è¿½æ±‚ç˜¦ï¼Œå¦‚æœç”¨æˆ·ä½“é‡è¿‡è½»è¦å…³å¿ƒï¼Œè¿‡é‡åˆ™æ ¹æ®äººè®¾é¼“åŠ±æˆ–ç£ä¿ƒã€‚
        3. ç»“åˆç”¨æˆ·çš„ã€èº«ä½“æ•°æ®ã€‘è¿›è¡Œå›å¤ã€‚
        ã€èº«ä½“æ•°æ®ã€‘ï¼š${healthContext}`;

        // æ ¹æ®ä¸åŒçš„æ“ä½œç±»å‹ç”Ÿæˆ Prompt
        if(pendingMealType === 'recommend') {
            prompt = `${basePersona}
            ä»»åŠ¡ï¼šè¯·æ ¹æ®æˆ‘çš„ä½“é‡å˜åŒ–å’Œè¿åŠ¨æƒ…å†µï¼Œä¸ºæˆ‘æ¨èä¸€ä»½ä»Šå¤©çš„å¥åº·é£Ÿè°±ï¼ˆå«æ—©ä¸­æ™šï¼‰ã€‚
            è¦æ±‚ï¼šç›´æ¥ç»™å‡ºé£Ÿè°±å’Œç†ç”±ï¼Œå£è¯­åŒ–äº¤æµã€‚`;
        } 
        else if(pendingMealType === 'exchange') {
            prompt = `${basePersona}
            ä»»åŠ¡ï¼šåƒé—²èŠä¸€æ ·ï¼Œå‘Šè¯‰æˆ‘ä½ ä»Šå¤©åƒäº†ä»€ä¹ˆï¼ˆç¬¦åˆä½ çš„äººè®¾ï¼‰ï¼Œç„¶åè¯„ä»·ä¸€ä¸‹æˆ‘çš„çŠ¶å†µï¼Œå¹¶é—®æˆ‘æƒ³åƒä»€ä¹ˆã€‚`;
        } 
        else if(pendingMealType === 'critique_all') {
            prompt = `${basePersona}
            è¿™æ˜¯æˆ‘ä»Šå¤©çš„é¥®é£Ÿè®°å½•ï¼š${itemsJSON}ã€‚
            ä»»åŠ¡ï¼šç‚¹è¯„æˆ‘åƒå¾—æ€ä¹ˆæ ·ã€‚ç»“åˆæˆ‘ä»Šå¤©çš„ä½“é‡å’Œè¿åŠ¨æƒ…å†µæ¥å¤¸å¥–æˆ–æ‰¹è¯„æˆ‘ã€‚`;
        } 
        else {
            // å•ä¸ªæ—¶æ®µç‚¹è¯„
            const mealList = JSON.stringify(DB.meals.items[pendingMealType]);
            const timeMap = {breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', snack:'é›¶é£Ÿ'};
            prompt = `${basePersona}
            æˆ‘${timeMap[pendingMealType]}åƒäº†ï¼š${mealList}ã€‚
            ä»»åŠ¡ï¼šæ ¹æ®æˆ‘ç›®å‰çš„ä½“é‡è¶‹åŠ¿ï¼Œè¯„ä»·è¿™é¡¿é¥­æ˜¯å¦åˆé€‚ã€‚`;
        }
        
                try {
            const res = await callAI([
                {
                    role:'system', 
                    content: `You are roleplaying as ${role.name}. Keep strictly to the persona. Direct speech only.`
                }, 
                {role:'user', content: prompt}
            ]);
            aiBox.innerText = res;
        } catch(e) {
            aiBox.innerText = "è¿æ¥å¤±è´¥: " + e.message;
        }
    }
        
                // ===========================
        // åˆ†æ”¯ 3: æ—¥è®° AI (åŸç‰ˆé€»è¾‘ï¼Œå®Œæ•´ä¿ç•™)
        // ===========================
        else if (replyTarget === 'diary') {
            const diary = DB.diaries.find(d => d.id === activeDiaryForReply);
            if (!diary || !role) return;
            
            // === æ—¶é—´æ„ŸçŸ¥è®¡ç®— ===
            const now = new Date();
            const diaryTime = new Date(diary.id); 
            const timeDiffHours = ((now - diaryTime) / (1000 * 60 * 60)).toFixed(1); 
            const currentTimeStr = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
            const diaryTimeStr = diaryTime.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
            
            // 1. çŠ¶æ€: æ­£åœ¨è¾“å…¥
            diary.comments.push({role: 'AI', name: role.name, text: 'æ­£åœ¨çœ‹æ—¥è®°(å¹¶çœ‹äº†ä¸€çœ¼æ—¶é—´)...', isTyping: true});
            renderDiaryList(); 
            
                        try {
                const context = diary.comments.filter(c=>!c.isTyping).map(c => `${c.role}: ${c.text}`).join('\n');
                
                // 2. å‡†å¤‡å‘é€ç»™ AI çš„å†…å®¹
                let userMessageContent = `Diary Content: ${diary.content}\nHistory: ${context}\n(Please reply to this)`;

                // 3. ğŸ“· æ£€æŸ¥æœ‰æ²¡æœ‰å›¾ç‰‡
                let hasImage = false;
                let imageUrl = "";
                
                if (diary.imgBlob) {
                    imageUrl = await blobToBase64(diary.imgBlob);
                    hasImage = true;
                } else if (diary.img) {
                    imageUrl = diary.img;
                    hasImage = true;
                }

                if (hasImage) {
                    userMessageContent = [
                        { type: "text", text: `Diary Content: ${diary.content}\nHistory: ${context}\n(Please reply based on the text and the attached image)` },
                        { type: "image_url", image_url: { url: imageUrl } }
                    ];
                }
                
                                // 4. å‘é€è¯·æ±‚ (åŒ…å«æ—¶é—´æ„ŸçŸ¥)
                const systemPrompt = `
                You are strictly roleplaying as: ${role.name}.
                [CHARACTER PERSONA] ${role.prompt}
                
                [TIME AWARENESS]
                - Current Real Time: ${currentTimeStr}
                - Diary Written At: ${diaryTimeStr} (Time elapsed: ${timeDiffHours} hours)
                
                [RULES]
                1. If elapsed time > 2 hours, acknowledge the delay (e.g., "Sorry I was busy").
                2. If it's late night (23:00-05:00), tell them to sleep.
                3. Casual, direct speech. No asterisks.
                `;

                const res = await callAI([
                    {role: 'system', content: systemPrompt},
                    {role: 'user', content: userMessageContent}
                ]);

                // 5. ä¿å­˜ç»“æœ
                diary.comments = diary.comments.filter(c => !c.isTyping);
                diary.comments.push({role: 'AI', name: role.name, text: res});
                
                await updateDiaryInDB(diary);
                renderDiaryList();

            } catch(e) {
                diary.comments = diary.comments.filter(c => !c.isTyping);
                showError(e.message);
                renderDiaryList();
            }
        }
    };

    
        // === Journal Logic ===
    function toggleDrawer() { $('journal-drawer').classList.toggle('active'); if($('journal-drawer').classList.contains('active')) switchDrawerTab('stickers'); }
    function switchDrawerTab(tab) {
        document.querySelectorAll('.drawer-tab').forEach(t=>t.classList.remove('active'));
        event.target.classList.add('active');
        const c = $('drawer-content'); c.innerHTML='';
        const t = $('drawer-custom-tool'); t.style.display = (tab === 'custom') ? 'flex' : 'none';
        
        if(tab==='stickers') {
            ASSETS.stickers.forEach(u=>c.innerHTML+=`<div class="asset-item"><img src="${u}" style="width:80%;" onclick="addSticker('${u}')"></div>`);
            DB.customAssets.stickers.forEach(u=>c.innerHTML+=`<div class="asset-item"><img src="${u}" style="width:80%;" onclick="addSticker('${u}')"><div style="position:absolute;top:0;right:0;font-size:10px;color:red;" onclick="removeCustomAsset('stickers','${u}', event)">x</div></div>`);
        }
        if(tab==='papers') ASSETS.papers.forEach(p=>c.innerHTML+=`<div class="asset-item" style="background:${p.val}" onclick="$('journal-wrapper').style.background='${p.val}'"></div>`);
        if(tab==='fonts') {
            ASSETS.fonts.forEach(f=>c.innerHTML+=`<div class="asset-item" style="font-family:${f.val}; font-size:16px;" onclick="setFont(&quot;${f.val}&quot;)">${f.name}</div>`);
            DB.customAssets.fonts.forEach(f=>c.innerHTML+=`<div class="asset-item" style="font-family:'${f.name}'; font-size:16px;" onclick="setFont('${f.name}')">è‡ªå®šä¹‰<div style="position:absolute;top:0;right:0;font-size:10px;color:red;" onclick="removeCustomAsset('fonts','${f.name}', event)">x</div></div>`);
        }
    }
    
    function addCustomAsset(type) {
        const url = $('custom-url').value;
        if(!url) return;
        if(type === 'image') {
            DB.customAssets.stickers.push(url);
            alert("è´´çº¸å·²æ·»åŠ ");
            switchDrawerTab('stickers');
        } else if (type === 'font') {
            const fontName = 'CustomFont' + Date.now();
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${url}'); }`;
            document.head.appendChild(style);
            DB.customAssets.fonts.push({name: fontName, url: url});
            alert("å­—ä½“å·²æ·»åŠ  (å¦‚æœURLæœ‰æ•ˆ)");
            switchDrawerTab('fonts');
        }
        localStorage.setItem('v26_assets', JSON.stringify(DB.customAssets));
        $('custom-url').value = '';
    }
    
    function removeCustomAsset(type, val, e) {
        e.stopPropagation();
        if(!confirm("åˆ é™¤æ­¤ç´ æï¼Ÿ")) return;
        if(type === 'stickers') DB.customAssets.stickers = DB.customAssets.stickers.filter(x => x !== val);
        if(type === 'fonts') DB.customAssets.fonts = DB.customAssets.fonts.filter(x => x.name !== val);
        localStorage.setItem('v26_assets', JSON.stringify(DB.customAssets));
        switchDrawerTab(type);
    }
    
    
    function loadCustomFonts() {
        DB.customAssets.fonts.forEach(f => {
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family: '${f.name}'; src: url('${f.url}'); }`;
            document.head.appendChild(style);
        });
    }

    function addTextBox() {
        const div = document.createElement('div'); div.className = 'draggable-item active';
        div.style.left = '50px'; div.style.top = '100px';
        div.innerHTML = `<div class="drag-handle">âœ‹</div><div class="text-box-content" contenteditable="true" style="color:${$('j-color-text').value}">ç‚¹å‡»è¾“å…¥...</div><div class="delete-btn" onclick="this.parentElement.remove()">âœ•</div>`;
        $('journal-layer-sticker').appendChild(div);
        makeDraggable(div);
    }
    
    function setFont(fontVal) {
        const activeItem = document.querySelector('.draggable-item.active');
        if(activeItem) {
            const content = activeItem.querySelector('.text-box-content');
            if(content) content.style.fontFamily = fontVal;
            else alert("é€‰ä¸­çš„ä¸æ˜¯æ–‡æœ¬æ¡†");
        } else alert("è¯·å…ˆç‚¹å‡»é€‰ä¸­ä¸€ä¸ªæ–‡æœ¬æ¡†");
    }
    
            function changeTextColor(val) { const active = document.querySelector('.draggable-item.active .text-box-content'); if(active) active.style.color = val; }
    function changeBgColor(val) { $('journal-wrapper').style.background = val; }
    function addSticker(u) { const div = document.createElement('div'); div.className = 'draggable-item active'; div.style.left = '50px'; div.style.top = '50px'; div.style.width = '80px'; div.innerHTML = `<img src="${u}"><div class="delete-btn" onclick="this.parentElement.remove()">âœ•</div>`; $('journal-layer-sticker').appendChild(div); makeDraggable(div); }
    
    function makeDraggable(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = elmnt.ontouchstart = function(e) { 
            e.stopPropagation(); 
            if (e.target.classList.contains('text-box-content')) { deselectAllDraggables(); elmnt.classList.add('active'); return; }
            deselectAllDraggables(); elmnt.classList.add('active'); dragMouseDown(e); 
        };
        function dragMouseDown(e) { e = e || window.event; e.type==='touchstart'?(pos3=e.touches[0].clientX,pos4=e.touches[0].clientY):(pos3=e.clientX,pos4=e.clientY); document.onmouseup=closeDragElement; document.onmousemove=elementDrag; document.ontouchend=closeDragElement; document.ontouchmove=elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); let clientX, clientY; if(e.type==='touchmove'){clientX=e.touches[0].clientX;clientY=e.touches[0].clientY;}else{clientX=e.clientX;clientY=e.clientY;} pos1=pos3-clientX; pos2=pos4-clientY; pos3=clientX; pos4=clientY; elmnt.style.top=(elmnt.offsetTop-pos2)+"px"; elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"; }
        function closeDragElement() { document.onmouseup=null; document.onmousemove=null; document.ontouchend=null; document.ontouchmove=null; }
    }
    function deselectAllDraggables(e) { if(e)e.stopPropagation(); document.querySelectorAll('.draggable-item').forEach(el => el.classList.remove('active')); }
    function saveJournalPage() { const j = DB.journals.find(x => x.id === currentJournalId); if(!j)return; j.title = $('editor-title').innerText; j.contentStickers = $('journal-layer-sticker').innerHTML; j.bg = $('journal-wrapper').style.background; localStorage.setItem('v15_journals', JSON.stringify(DB.journals)); alert("æ‰‹è´¦å·²ä¿å­˜ ğŸ’¾"); }
    function createNewJournal() { openCustomPrompt("æ‰‹è´¦æ ‡é¢˜", (t)=>{ if(t) { DB.journals.unshift({ id: Date.now(), title: t, contentText: '', contentStickers: '', bg: '#fff' }); localStorage.setItem('v15_journals', JSON.stringify(DB.journals)); renderJournalShelf(); } }); }
    function openJournalEditor(id) { currentJournalId = id; const j = DB.journals.find(x => x.id === id); $('editor-title').innerText = j.title; $('journal-wrapper').style.background = j.bg||'#fff'; $('journal-layer-sticker').innerHTML = j.contentStickers||''; $('journal-editor-view').style.display = 'flex'; document.querySelectorAll('.draggable-item').forEach(el=>{makeDraggable(el); const del=el.querySelector('.delete-btn'); if(del)del.onclick=function(){this.parentElement.remove()}}); }
    function closeJournalEditor() { $('journal-editor-view').style.display = 'none'; }
    function renderJournalShelf() { const s = $('journal-shelf'); s.innerHTML = '<div class="journal-book journal-add" onclick="createNewJournal()">+</div>'; DB.journals.forEach(j => { s.innerHTML += `<div class="journal-book" onclick="openJournalEditor(${j.id})"><div class="journal-title">${j.title}</div></div>`; }); }
    let currentJournalId = null;
    let replyTarget = null;
    function openJournalAIReply() { replyTarget = 'journal'; const s = $('role-select-input'); s.innerHTML = DB.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); $('modal-role-select').style.display = 'flex'; }
    async function askJournalAI(role) { 
        const text = $('journal-layer-sticker').innerText; 
        const note = document.createElement('div'); note.className = 'ai-sticky-note draggable-item active'; note.style.left = '50px'; note.style.top = '200px'; 
        note.innerHTML = `<div class="drag-handle">âœ‹</div>æ­£åœ¨æ’°å†™...<div class="delete-btn" onclick="this.parentElement.remove()">âœ•</div>`; 
        $('journal-layer-sticker').appendChild(note); makeDraggable(note); 
        try { 
            const res = await callAI([{role:'system', content:`Roleplay ${role.name}. ${role.prompt}. Read the user's scrapbook (journal) and leave a short sticky note comment (max 30 words). DIRECT SPEECH ONLY, NO ASTERISKS.`}, {role:'user', content:text}]); 
            note.innerHTML = `<div class="drag-handle">âœ‹</div>${res}<div class="delete-btn" onclick="this.parentElement.remove()">âœ•</div>`;
        } catch(e) { showError(e.message); note.remove(); } 
    }
    
        // === Feature Logic ===
            // 1. ç”µå­æœ¨é±¼
    function knockWoodenFish(e) {
        DB.merit = (DB.merit || 0) + 1;
        localStorage.setItem('v30_merit', DB.merit);
        $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
        
        // åŠ¨ç”»
        const fish = e.currentTarget.querySelector('.wooden-fish-icon');
        fish.style.transform = "scale(0.9)";
        setTimeout(() => fish.style.transform = "scale(1)", 100);
        
                // +1 é£˜å­—
        const pop = document.createElement('div');
        pop.className = 'merit-popup';
        pop.innerText = 'åŠŸå¾· +1';
        e.currentTarget.querySelector('.wooden-fish-widget').appendChild(pop);
        setTimeout(() => pop.remove(), 1000);
        
        // éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
    }
    
        // 2. å¿ƒæƒ…åƒç´ å¢™
    function renderMoodPixels() {
        const grid = $('pixel-grid');
        if(!grid) return;
        grid.innerHTML = '';
        
        // ç”Ÿæˆæœ€è¿‘ 365 å¤© (æˆ–å›ºå®šæ ¼å­)
        // è¿™é‡Œç®€å•ç”Ÿæˆ 12åˆ— x 7è¡Œ (ç¤ºä¾‹) æˆ–è€…æŒ‰å®é™…å†å²æ¸²æŸ“
        // ä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬æ¸²æŸ“æœ€è¿‘ 84 å¤© (12å‘¨)
        const days = 84; 
        const now = new Date();
        
        // è½¬æ¢å†å²æ•°æ®ä¸º Map æ–¹ä¾¿æŸ¥æ‰¾
        const moodMap = {};
        (DB.moodHistory || []).forEach(m => moodMap[m.date] = m.val);
        
        for(let i=days; i>=0; i--) {
            const d = new Date();
            d.setDate(now.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const mood = moodMap[dateStr];
            
            let color = 'rgba(0,0,0,0.05)'; // é»˜è®¤ç©º
            if(mood === 'happy') color = '#ff9a9e';
            if(mood === 'calm') color = '#a18cd1';
            if(mood === 'tired') color = '#cfd9df';
            
                        const cell = document.createElement('div');
            cell.className = 'pixel-cell';
            cell.style.background = color;
            cell.title = `${dateStr}: ${mood || 'æ— è®°å½•'}`;
            grid.appendChild(cell);
        }
    }
    
        // æ›´æ–° setMood ä»¥ä¿å­˜å†å²
    const originalSetMood = setMood; // ä¿å­˜æ—§å‡½æ•°
    setMood = function(m) {
        originalSetMood(m); // æ‰§è¡Œæ—§é€»è¾‘
        // æ–°é€»è¾‘ï¼šä¿å­˜åˆ°å†å²
        const today = new Date().toISOString().split('T')[0];
        const idx = DB.moodHistory.findIndex(x => x.date === today);
        if(idx >= 0) DB.moodHistory[idx].val = m;
        else DB.moodHistory.push({date: today, val: m});
        localStorage.setItem('v30_mood_pixels', JSON.stringify(DB.moodHistory));
        renderMoodPixels(); // åˆ·æ–°å¢™
    }
    
    function renderPledges() {
        const area = $('pledge-content-area'); area.innerHTML = '';
        if(DB.pledges.length === 0) { area.innerHTML = '<div style="text-align:center; opacity:0.6; margin-top:50px;">æš‚æ— å†›ä»¤</div>'; return; }
        const p = DB.pledges[0]; const expired = new Date() > new Date(p.due);
        area.innerHTML = `<div class="pledge-scroll"><div style="font-size:24px; font-weight:bold; margin-bottom:10px;">ğŸ›¡ï¸ å†›ä»¤çŠ¶</div><div class="pledge-text">ä»Šç«‹æ­¤èª“ï¼Œå¿…å®Œæˆï¼š<br><b>${p.task}</b></div><div class="pledge-text">æˆªæ­¢æ—¶é—´ï¼š${new Date(p.due).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="pledge-text" style="color:#d32f2f;">è‹¥è¿æ­¤èª“ï¼š${p.punish}</div>${expired ? '<div class="pledge-stamp">å·²è¶…æ—¶</div>' : ''}</div><div style="display:flex; gap:10px;"><button class="btn-normal" onclick="finishPledge()">âœ… å¹¸ä¸è¾±å‘½ (å®Œæˆ)</button><button class="btn-normal btn-danger" onclick="failPledge()">ğŸ’€ é¢†ç½š (æœªå®Œæˆ)</button></div>`;
    }
    function createNewPledge() {
        if(DB.pledges.length > 0) { alert("å·²æœ‰å†›ä»¤åœ¨èº«ï¼Œä¸å¯è´ªå¤šï¼"); return; }
        openCustomPrompt("ç«‹èª“ä»»åŠ¡", (task)=>{ if(!task) return; setTimeout(() => { openCustomPrompt("æˆªæ­¢æ—¶é—´ (HH:MM)", (time)=>{ if(!time) return; setTimeout(() => { openCustomPrompt("æƒ©ç½š (å¦‚: æ·±è¹²20)", (punish)=>{ const today = new Date().toISOString().split('T')[0]; const due = new Date(`${today}T${time}`); DB.pledges.push({task, due: due.toISOString(), punish}); localStorage.setItem('v25_pledges', JSON.stringify(DB.pledges)); renderPledges(); }); }, 200); }, "18:00"); }, 200); });
    }
    function finishPledge() { alert("ğŸ‰ èµï¼(å¤§å¤§çš„èµèµ)"); DB.pledges = []; localStorage.setItem('v25_pledges', JSON.stringify(DB.pledges)); renderPledges(); }
    function failPledge() { const p = document.querySelector('.pledge-scroll'); p.style.transition = "1s"; p.style.transform = "rotate(5deg) scale(0.9)"; p.style.filter = "grayscale(1)"; setTimeout(()=>{ alert("ğŸ©¸ æ–©ï¼(è¯·è‡ªè§‰æ‰§è¡Œæƒ©ç½š)"); DB.pledges = []; localStorage.setItem('v25_pledges', JSON.stringify(DB.pledges)); renderPledges(); }, 1000); }

    function renderStampGrid() { const grid = $('stamp-grid'); grid.innerHTML = ''; for(let i=0; i<9; i++) { const hasStamp = i < DB.stampCount; grid.innerHTML += `<div class="stamp-cell">${hasStamp ? '<span class="stamp-mark">ğŸŒ¸</span>' : ''}</div>`; } $('btn-redeem').style.display = DB.stampCount >= 10 ? 'block' : 'none'; }
    function addStamp() { const today = new Date().toDateString(); if (DB.lastStampDate === today) { alert("è´ªå¿ƒï¼æ˜å¤©å†æ¥ã€‚"); return; } if(DB.stampCount >= 10) return; DB.stampCount++; DB.lastStampDate = today; localStorage.setItem('v25_stamps', DB.stampCount); localStorage.setItem('v26_last_stamp', DB.lastStampDate); renderStampGrid(); }
    async function redeemStampReward() { $('btn-redeem').innerText = "ç”Ÿæˆä¸­..."; try { const res = await callAI([{role:'system', content:'ä½ æ˜¯ä¸€ä¸ªå® æººçš„Domã€‚ç”¨æˆ·é›†æ»¡10ä¸ªç« ï¼Œå†™ä¸€å¼ ç®€çŸ­çš„â€œå…ç½ªé‡‘ç‰Œâ€æˆ–â€œå¥–åŠ±åˆ¸â€ã€‚'}, {role:'user', content:'æ±‚å¥–åŠ±'}]); $('stamp-reward-display').innerText = res; $('stamp-reward-display').style.display = 'block'; DB.stampCount = 0; localStorage.setItem('v25_stamps', DB.stampCount); renderStampGrid(); $('btn-redeem').innerText = "ğŸ å…‘æ¢å…ç½ªé‡‘ç‰Œ"; } catch(e) { showError(e.message); } }

    async function submitPermission() { const cid = $('perm-role').value; const content = $('perm-content').value; if(!content) return; const c = DB.contacts.find(x=>x.id==cid); $('perm-result').style.display = 'block'; $('perm-result').innerText = "å®¡æ‰¹ä¸­..."; try { const res = await callAI([{role:'system', content:`Roleplay ${c.name}. ${c.prompt}. User asks for permission. Approve or Deny firmly but lovingly. Short. DIRECT SPEECH ONLY, NO ASTERISKS/ACTIONS.`}, {role:'user', content:content}]); const isApproved = res.includes("Approve") || res.includes("æ‰¹å‡†") || res.includes("å¯ä»¥"); $('perm-result').style.background = isApproved ? '#e8f5e9' : '#ffebee'; $('perm-result').style.color = isApproved ? '#2e7d32' : '#c62828'; $('perm-result').innerText = res; } catch(e) { $('perm-result').innerText = "è¿æ¥å¤±è´¥: " + e.message; } }
    async function interpretDream() { const content = $('dream-input').value; if(!content) return; const cid = $('dream-role').value; const c = DB.contacts.find(x=>x.id==cid); $('dream-result').innerText = "è§£æä¸­..."; try { const res = await callAI([{role:'system', content:`ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨æ‰®æ¼”${c.name}çš„è§’è‰²ï¼Œè¯·ä¸¥æ ¼éµå®ˆè¿™ä¸ªäººè®¾ï¼š${c.prompt}ã€‚è¯·ä½ åˆ†æç”¨æˆ·çš„æ¢¦å¢ƒï¼Œä½¿ç”¨å¿ƒç†å­¦æˆ–è±¡å¾æ„ä¹‰è¿›è¡Œè§£è¯»ã€‚ä½ çš„å›å¤å¿…é¡»æ˜¯çº¯ç²¹çš„å£è¯­å¯¹è¯ï¼Œä¿æŒäººè®¾è¯­è¨€é£æ ¼ï¼Œç¦æ­¢ä»»ä½•åŠ¨ä½œæå†™ï¼Œç¦æ­¢ä½¿ç”¨æ˜Ÿå·ï¼Œç¦æ­¢ä½¿ç”¨æ‹¬å·ã€‚`}, {role:'user', content:content}]); $('dream-result').innerText = res; } catch(e) { $('dream-result').innerText = "è¿æ¥å¤±è´¥: " + e.message; } }
    function spinGacha(type) { const btn = document.querySelector('#gacha-icon'); btn.style.transition = '0.5s'; btn.style.transform = 'rotate(720deg)'; setTimeout(()=>{ btn.style.transform = 'rotate(0deg)'; }, 500); let list = type === 'food' ? ASSETS.gachaFood : ASSETS.gachaAct; const res = list[Math.floor(Math.random() * list.length)]; $('gacha-text').innerHTML = `<span style="color:var(--accent-color);">${res}</span>`; if(res === 'Ask AI') { setTimeout(()=>{ openCustomPrompt("é—®é—®AIè¯¥å¹²å˜›", async (v)=>{ if(v) { $('gacha-text').innerText = "AI: " + await callAI([{role:'user', content:`Decide for me: ${v}. Short reply.`}]); } }); }, 600); } }
    
        function renderCapsules() { const list = $('capsule-list'); list.innerHTML = ''; if(DB.capsules.length === 0) { list.innerHTML = '<div style="text-align:center; opacity:0.5;">æ— èƒ¶å›Š</div>'; return; } DB.capsules.forEach((c, i) => { const locked = new Date() < new Date(c.unlock); list.innerHTML += `<div style="background:var(--card-bg); padding:15px; border-radius:12px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; opacity:${locked?0.7:1};"><div><div style="font-size:12px; font-weight:bold;">${new Date(c.unlock).toLocaleDateString()} è§£å°</div><div style="font-size:14px; margin-top:5px;">${locked ? '********' : c.msg}</div></div><div class="${locked ? 'capsule-lock' : 'capsule-unlock'}">ğŸ”’</div></div>`; }); }
    function sealCapsule() { const msg = $('cap-msg').value; const date = $('cap-date').value; if(!msg || !date) return; DB.capsules.push({msg, unlock: date}); localStorage.setItem('v25_capsules', JSON.stringify(DB.capsules)); $('cap-msg').value = ''; renderCapsules(); alert("èƒ¶å›Šå·²åŸ‹ä¸‹"); }

    async function generateLetter() { const cid=$('letter-role-select').value; const c=DB.contacts.find(x=>x.id==cid); if(!c) { alert("è¯·å…ˆæ·»åŠ è§’è‰²"); return; } $('letter-result').style.display='block'; $('letter-content').innerText="æ­£åœ¨å†™ä¿¡..."; try{ const msgs = [{role:'system',content:`Roleplay ${c.name}. ${c.prompt}. Write a short, warm letter. DIRECT SPEECH ONLY, NO ASTERISKS.`},{role:'user',content:`Status: ${DB.extras.mood}`}]; const r=await callAI(msgs); $('letter-content').innerText=r; } catch(e){$('letter-content').innerText="AI Error: " + e.message;} }
    function saveLetter() { const content = $('letter-content').innerText; if (!content || content.includes("Error")) return; const sender = $('letter-role-select').selectedOptions[0].text; DB.letters.unshift({id: Date.now(), date: new Date().toLocaleDateString(), sender: sender, content: content}); localStorage.setItem('v15_letters', JSON.stringify(DB.letters)); $('letter-result').style.display='none'; renderMailbox(); alert("ä¿¡ä»¶å·²å­˜å…¥"); }
    function renderMailbox() { const list = $('mailbox-list'); if(DB.letters.length === 0) { list.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#999;">æš‚æ— ä¿¡ä»¶</div>'; return; } list.innerHTML = DB.letters.map(l => `<div style="background:var(--card-bg); padding:12px; border-radius:12px; box-shadow:var(--shadow); cursor:pointer;" onclick="readLetter('${encodeURIComponent(l.content)}')"><div style="font-size:10px; color:var(--text-color); opacity:0.6;">${l.date}</div><div style="font-weight:bold; color:var(--accent-color); margin-top:4px;">${l.sender}</div><div style="font-size:12px; margin-top:4px; color:var(--text-color); opacity:0.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${l.content.substring(0,12)}...</div></div>`).join(''); }
    function readLetter(encodedContent) { $('read-content').innerText = decodeURIComponent(encodedContent); $('modal-letter-read').style.display = 'flex'; }
    
// === æ”¾åœ¨ askMealAI ä¸Šé¢ ===
let pendingMealType = null; 

// === ä¿®å¤ç‰ˆï¼šaskMealAI å‡½æ•° (é›†æˆä½“é‡ä¸è¿åŠ¨è¯»å–) ===
function askMealAI(type) { 
    // 1. æ ‡è®°å½“å‰æ˜¯é¥®é£Ÿæ¨¡å—
    replyTarget = 'meal'; 
    pendingMealType = type; 
    
    // 2. åˆ·æ–°è§’è‰²åˆ—è¡¨
    const selectBox = document.getElementById('role-select-input');
    if (selectBox) {
        selectBox.innerHTML = DB.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
    
    
     // 3. æ‰“å¼€é€‰äººå¼¹çª—
    document.getElementById('modal-role-select').style.display = 'flex'; 
}
    
    function showError(msg) { $('alert-msg').innerText = "API é”™è¯¯: " + msg; $('modal-alert').style.display = 'flex'; }
    function fetchModels() { const k=$('api-key').value; const u=$('api-url').value; if(!k){alert("No Key");return;} fetch(`${u}/models`,{headers:{'Authorization':`Bearer ${k}`}}).then(r=>r.json()).then(d=>{const s=$('model-select');s.innerHTML='';d.data.forEach(m=>s.add(new Option(m.id,m.id)));alert("Updated");}).catch(e=>alert("Fail")); }
    function saveSettings() { DB.settings.url=$('api-url').value; DB.settings.key=$('api-key').value; DB.settings.model=$('model-select').value; localStorage.setItem('v16_set', JSON.stringify(DB.settings)); alert("Saved"); }
    async function callAI(msgs) { if(!DB.settings.key) throw new Error("ç¼ºå°‘ API Key"); try { const r = await fetch(`${DB.settings.url}/chat/completions`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${DB.settings.key}`}, body:JSON.stringify({model:DB.settings.model||'gpt-4o', messages:msgs}) }); if (!r.ok) throw new Error(`Status ${r.status}`); const d = await r.json(); return d.choices[0].message.content; } catch (e) { console.error(e); throw e; } }
    
        // === ä¿®å¤ç‰ˆï¼šå¼•ç”¨åŠŸèƒ½ (å«å¾€æœŸæ—¥è®°) ===
    function insertReference(type) {
        let text = "";
        const today = new Date().toISOString().split('T')[0];
        
        if (type === 'meals') {
            const m = DB.meals.items;
            const format = (t, label) => t.length ? `\n[${label}]: ${t.map(i=>i.text).join(', ')}` : "";
            text = `\n> ã€é¥®é£Ÿè®°å½•ã€‘${format(m.breakfast, 'æ—©')}${format(m.lunch, 'åˆ')}${format(m.dinner, 'æ™š')}${format(m.snack, 'é›¶é£Ÿ')}`;
            if(text === "\n> ã€é¥®é£Ÿè®°å½•ã€‘") text = "\n> ã€é¥®é£Ÿè®°å½•ã€‘ä»Šå¤©è¿˜æ²¡è®°åƒçš„...";
        } 
        else if (type === 'period') {
            const h = DB.period.history;
            if(h.length === 0) { text = "\n> ã€ç»æœŸã€‘æš‚æ— è®°å½•"; }
            else {
                const sorted = [...h].sort((a,b) => new Date(a.start) - new Date(b.start));
                const last = sorted[sorted.length-1];
                const diff = Math.floor((new Date() - new Date(last.start)) / 86400000);
                if (diff >= 0 && diff <= 7) text = `\n> ã€ç»æœŸã€‘ä»Šå¤©æ˜¯ç»æœŸç¬¬ ${diff + 1} å¤©ã€‚`;
                else text = `\n> ã€ç»æœŸã€‘ç›®å‰ä¸åœ¨ç»æœŸï¼Œè·ç¦»ä¸Šæ¬¡å¼€å§‹å·²è¿‡ ${diff} å¤©ã€‚`;
            }
        }
        else if (type === 'todo') {
            const pending = DB.todos.filter(t => !t.done).map(t => t.text);
            text = pending.length ? `\n> ã€å¾…åŠã€‘æœªå®Œæˆï¼š${pending.join(', ')}` : "\n> ã€å¾…åŠã€‘æ— æœªå®Œæˆäº‹é¡¹ã€‚";
        }
        else if (type === 'pledge') {
            const p = DB.pledges[0];
            text = p ? `\n> ã€å†›ä»¤çŠ¶ã€‘ä»»åŠ¡ï¼š${p.task} (æˆªæ­¢: ${new Date(p.due).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})})` : "\n> ã€å†›ä»¤çŠ¶ã€‘å½“å‰æ— å†›ä»¤ã€‚";
        }

        const input = $('ml-input');
        input.value = input.value + text + "\n";
        $('modal-reference').style.display = 'none';
        hideDiaryPicker(); // é‡ç½®ç•Œé¢
        input.focus();
    }

    // æ˜¾ç¤ºæ—¥è®°é€‰æ‹©å™¨
    function showDiaryPicker() {
        $('ref-buttons').style.display = 'none';
        $('ref-diary-picker').style.display = 'block';
        $('btn-ref-back').style.display = 'inline-block';
        
        const list = $('ref-diary-list');
        list.innerHTML = '';
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        const sortedDiaries = [...DB.diaries].sort((a,b) => b.id - a.id);
        
        if(sortedDiaries.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5;">æš‚æ— æ—¥è®°</div>';
            return;
        }

        sortedDiaries.forEach(d => {
            const date = d.date;
            const preview = d.content.substring(0, 30).replace(/\n/g, ' ') + (d.content.length>30?'...':'');
            const div = document.createElement('div');
            div.style.cssText = "padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:13px;";
            div.innerHTML = `<span style="color:var(--accent-color); font-weight:bold;">${date}</span><br><span style="opacity:0.8;">${preview}</span>`;
            div.onclick = () => {
                const input = $('ml-input');
                input.value += `\n> ã€å¼•ç”¨æ—¥è®° ${date}ã€‘\n> ${d.content}\n`;
                $('modal-reference').style.display = 'none';
                hideDiaryPicker();
                input.focus();
            };
            list.appendChild(div);
        });
    }
    
        // éšè—æ—¥è®°é€‰æ‹©å™¨
    function hideDiaryPicker() {
        $('ref-buttons').style.display = 'grid';
        $('ref-diary-picker').style.display = 'none';
        $('btn-ref-back').style.display = 'none';
    }

    // === ä¿®å¤ç‰ˆï¼šå›å¤ AI (ç¡®ä¿äº‹ä»¶è§¦å‘) ===
    window.userReplyToComment = function(e, diaryId) {
        if(e) e.stopPropagation();
        
        openCustomPrompt("å›å¤ AI", async (val) => {
            if (!val) return;
            
            const diary = DB.diaries.find(d => d.id === diaryId);
            if (!diary) return;

            // 1. è®°å½•ç”¨æˆ·å›å¤
            diary.comments.push({role: 'User', name: 'æˆ‘', text: val});
            await updateDiaryInDB(diary);
            renderDiaryList();

            // 2. å¯»æ‰¾å¯¹è¯å¯¹è±¡
            const lastAI = [...diary.comments].reverse().find(c => c.role === 'AI');
            // å¦‚æœæ‰¾ä¸åˆ°ä¸Šæ¬¡æ˜¯è°å›å¤çš„ï¼Œé»˜è®¤ç”¨ç¬¬ä¸€ä¸ªè§’è‰²ï¼Œæˆ–è€…æç¤ºé”™è¯¯
            let role = null;
            if (lastAI) {
                role = DB.contacts.find(c => c.name === lastAI.name);
            } 
            if (!role && DB.contacts.length > 0) role = DB.contacts[0];

            if (!role) { alert("æ— æ³•æ‰¾åˆ°å¯¹åº”çš„è§’è‰²è¿›è¡Œå›å¤ï¼Œè¯·å…ˆåœ¨é€šè®¯å½•æ·»åŠ è§’è‰²ã€‚"); return; }

            // 3. AI æ€è€ƒä¸­
            diary.comments.push({role: 'AI', name: role.name, text: '...', isTyping: true});
            renderDiaryList();

            try {
                const history = diary.comments.filter(c => !c.isTyping).map(c => `${c.role === 'AI' ? role.name : 'User'}: ${c.text}`).join('\n');
                const sys = `Roleplay ${role.name}. ${role.prompt}. Context: User replied to your comment on their diary. Reply naturally. Short, casual style.`;
                const userMsg = `Diary: ${diary.content}\n\nChat History:\n${history}\n\n(Reply to the last message)`;
                
                                const res = await callAI([{role: 'system', content: sys}, {role: 'user', content: userMsg}]);

                diary.comments = diary.comments.filter(c => !c.isTyping);
                diary.comments.push({role: 'AI', name: role.name, text: res});
                await updateDiaryInDB(diary);
                renderDiaryList();

            } catch (err) {
                diary.comments = diary.comments.filter(c => !c.isTyping);
                alert("AI è¿æ¥å¤±è´¥: " + err.message);
                renderDiaryList();
            }
        }, "è¾“å…¥ä½ çš„å›å¤...");
    };
        // === V29 ä¸“ç”¨ï¼šç²¾å‡†å¤‡ä»½åŠŸèƒ½ ===
    async function exportData() {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "æ­£åœ¨ç­›é€‰æ‰“åŒ…..."; 
        
        try {
            // 1. ğŸ” å®šä¹‰ V29 ç‰ˆæœ¬çœŸæ­£ä½¿ç”¨çš„â€œé’¥åŒ™â€å‰ç¼€
            // (è™½ç„¶æœ‰çš„å«v15ï¼Œä½†å®ƒä»¬ç¡®å®æ˜¯ä½ ç°åœ¨æ­£åœ¨ç”¨çš„æ•°æ®ï¼)
            const activePrefixes = [
                'v15_', // æ—¥è®°(æ—§æ–‡æœ¬)ã€é€šè®¯å½•ã€å¾…åŠã€æ‰‹è´¦ã€ä¿¡ç®±ã€é¥®é£Ÿã€é¢å¤–ä¿¡æ¯
                'v16_', // è®¾ç½®
                'v18_', // æ¶‚é¸¦ã€æ—§è´´çº¸
                'v19_', // ç»æœŸ
                'v20_', // é‡‘åº“ã€å åœ
                'v25_', // å†›ä»¤çŠ¶ã€é›†ç« ã€èƒ¶å›Š
                'v26_', // æ–°ç´ æåº“ã€æœ€åç›–ç« æ—¶é—´
                'v29_', // RPGç­‰çº§
                'v30_', // æ¼‚æµç“¶ã€å¿ƒæƒ…åƒç´ å¢™ã€åŠŸå¾·å•†åº—ã€æœ¨é±¼
                'v31_', // æŒ‡ä»¤é›†
                'v32_', // ä½“é‡ç®¡ç†ã€è¿åŠ¨è®°å½•
                'v33_', // äº²æ˜µã€ç¼ ç»µã€æš§æ˜§å€¼
                'v34_' // åç‰‡
            ];
            
            const filteredLS = {};
            Object.keys(localStorage).forEach(key => {
                // åªæœ‰å½“å‰ç‰ˆæœ¬ä»£ç é‡ŒçœŸçš„ç”¨åˆ°çš„ keyï¼Œæ‰æ‰“åŒ…
                if (activePrefixes.some(prefix => key.startsWith(prefix))) {
                    filteredLS[key] = localStorage.getItem(key);
                }
            });

            const backup = {
                type: 'MyOS_V33_Full', // æ›´æ–°ä¸€ä¸‹ç‰ˆæœ¬æ ‡è®°ï¼Œæ–¹ä¾¿è¯†åˆ«
                date: new Date().toISOString(),
                localStorage: filteredLS, 
                indexedDB: {
                    diaries: [],
                    settings: []
                }
            };
            
                        // 2. è·å– IndexedDB é‡Œçš„æ—¥è®° (å›¾ç‰‡)
            const diaries = await db.diaries.toArray();
            for (const d of diaries) {
                const diaryCopy = { ...d };
                if (d.imgBlob) {
                    diaryCopy.imgBase64 = await blobToBase64(d.imgBlob);
                    delete diaryCopy.imgBlob;
                }
                backup.indexedDB.diaries.push(diaryCopy);
            }

            // 3. è·å–å°é¢å›¾
            const bg = await db.settings.get('widgetBg');
            if (bg && bg.value instanceof Blob) {
                const bgBase64 = await blobToBase64(bg.value);
                backup.indexedDB.settings.push({ key: 'widgetBg', valueBase64: bgBase64 });
            } else if (bg) {
                backup.indexedDB.settings.push(bg);
            }
            
            // è·å–è‡ªå®šä¹‰å£çº¸ (å¦‚æœæœ‰)
            const customWp = await db.settings.get('customWallpaper');
            if (customWp && customWp.value instanceof Blob) {
                const wpBase64 = await blobToBase64(customWp.value);
                backup.indexedDB.settings.push({ key: 'customWallpaper', valueBase64: wpBase64 });
            } else if (customWp) {
                backup.indexedDB.settings.push(customWp);
            }

// âœ… æ–°å¢ï¼šè·å–åç‰‡å¤´åƒ
for (const side of ['front', 'back']) {
    const avatarKey = `cardAvatar_${side}`;
    const avatar = await db.settings.get(avatarKey);
    if (avatar && avatar.value instanceof Blob) {
        const avatarBase64 = await blobToBase64(avatar.value);
        backup.indexedDB.settings.push({ key: avatarKey, valueBase64: avatarBase64 });
    } else if (avatar) {
        backup.indexedDB.settings.push(avatar);
    }
}

            // 4. ç”Ÿæˆä¸‹è½½
            const blob = new Blob([JSON.stringify(backup)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `MyOS_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            alert("âœ… å¤‡ä»½æˆåŠŸï¼åŒ…å«ï¼šæ¼‚æµç“¶ã€å¿ƒæƒ…ã€è¿åŠ¨ã€ç¼ ç»µç­‰æ‰€æœ‰æ•°æ®ã€‚");

        } catch (e) {
            console.error(e);
            alert("âŒ å¤‡ä»½å¤±è´¥: " + e.message);
        } finally {
            btn.innerText = originalText;
        }
    }


    // è¾…åŠ©å‡½æ•°ï¼šæŠŠ Blob å›¾ç‰‡è½¬æˆ Base64 å­—ç¬¦ä¸²
    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // === å¢å¼ºç‰ˆå¯¼å…¥åŠŸèƒ½ (å¯¹åº”ä¸Šé¢çš„å¯¼å‡º) ===
    function importData(input) {
        const f = input.files[0];
        if (!f) return;
        
        if (!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å¤‡ä»½å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ç¡®å®šå—ï¼Ÿ")) {
            input.value = ''; 
            return;
        }

        const r = new FileReader();
        r.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                // 1. æ¢å¤ LocalStorage
                if (data.localStorage) {
                    Object.keys(data.localStorage).forEach(k => {
                        localStorage.setItem(k, data.localStorage[k]);
                    });
                } else {
                    // å…¼å®¹æ—§ç‰ˆå¤‡ä»½ (ç›´æ¥æ˜¯ localStorage å¯¹è±¡)
                    Object.keys(data).forEach(k => {
                        if(typeof data[k] === 'string') localStorage.setItem(k, data[k]);
                    });
                }

                // 2. æ¢å¤ IndexedDB (å¦‚æœæœ‰)
                if (data.indexedDB) {
                    // æ¸…ç©ºç°æœ‰è¡¨
                    await db.diaries.clear();
                    await db.settings.clear();

                    // æ¢å¤æ—¥è®°
                    if (data.indexedDB.diaries) {
                        for (const d of data.indexedDB.diaries) {
                            if (d.imgBase64) {
                                d.imgBlob = base64ToBlob(d.imgBase64); // è½¬å› Blob
                                delete d.imgBase64;
                            }
                            await db.diaries.put(d);
                        }
                    }

                    // æ¢å¤å°é¢
                    if (data.indexedDB.settings) {
                        for (const s of data.indexedDB.settings) {
                            if (s.valueBase64) {
                                const blob = base64ToBlob(s.valueBase64);
                                await db.settings.put({ key: s.key, value: blob });
                            } else {
                                await db.settings.put(s);
                            }
                        }
                    }
                }

                alert("âœ… æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                location.reload();
            } catch (e) {
                alert("âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼å¯èƒ½é”™è¯¯ã€‚\n" + e.message);
            }
        };
        r.readAsText(f);
    }

    function renderTodosWidget() { const list = $('todo-list-desktop'); if (!list) return; list.innerHTML = DB.todos.length ? DB.todos.map((t, i) => `<div class="todo-item-desk"><input type="checkbox" ${t.done?'checked':''} onclick="toggleTodo(${i})"><span style="${t.done?'text-decoration:line-through;opacity:0.5':''}; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${t.text}</span><span style="font-size:10px; cursor:pointer; color:#ff3b30;" onclick="delTodo(${i})">âœ•</span></div>`).join('') : '<div style="text-align:center; color:#999; padding-top:20px;">æš‚æ— å¾…åŠ</div>'; }
    function addTodo(val) { if(val) { DB.todos.push({text:val, done:false}); localStorage.setItem('v15_todo', JSON.stringify(DB.todos)); renderTodosWidget(); } }
        function toggleTodo(i) { 
        DB.todos[i].done = !DB.todos[i].done; 
        if(DB.todos[i].done) gainXP(5); // å®Œæˆå¾…åŠ +5 XP
        localStorage.setItem('v15_todo', JSON.stringify(DB.todos)); 
        renderTodosWidget(); 
    }
    function delTodo(i) { DB.todos.splice(i,1); localStorage.setItem('v15_todo', JSON.stringify(DB.todos)); renderTodosWidget(); }
    function renderContacts() { $('contact-list').innerHTML = DB.contacts.map(c=>`<div style="background:var(--card-bg); padding:15px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;"><span>${c.name}</span> <span onclick="editContact(${c.id})" style="cursor:pointer; font-size:20px;">âš™ï¸</span></div>`).join(''); }
    function editContact(id) { $('modal-contact').style.display='flex'; if(id){const c=DB.contacts.find(x=>x.id==id);$('c-id').value=c.id;$('c-name').value=c.name;$('c-prompt').value=c.prompt;}else{$('c-id').value='';$('c-name').value='';$('c-prompt').value='';} }
    function saveContact() { const id=$('c-id').value, n=$('c-name').value, p=$('c-prompt').value; if(id){ Object.assign(DB.contacts.find(x=>x.id==id),{name:n,prompt:p}); } else { DB.contacts.push({id:Date.now(),name:n,prompt:p}); } localStorage.setItem('v15_con', JSON.stringify(DB.contacts)); renderContacts(); $('modal-contact').style.display='none'; }
    function deleteContact() { const id = $('c-id').value; if(id && confirm("Del?")) { DB.contacts = DB.contacts.filter(c => c.id != id); localStorage.setItem('v15_con', JSON.stringify(DB.contacts)); renderContacts(); $('modal-contact').style.display='none'; } }
    
            function renderMealsApp() { const area=$('meal-cards-area'); area.innerHTML=''; const types={breakfast:'æ—©é¤ ğŸ³',lunch:'åˆé¤ ğŸ±',dinner:'æ™šé¤ ğŸ·',snack:'é›¶é£Ÿ ğŸª'}; Object.keys(types).forEach(type=>{ const items=(DB.meals.items[type]||[]).map((i, idx)=>`<div style="display:flex; justify-content:space-between; padding:4px 0;"><span>- ${i.text}</span><span style="color:#ff3b30; cursor:pointer; font-weight:bold;" onclick="removeMeal('${type}', ${idx})">Ã—</span></div>`).join(''); area.innerHTML+=`<div style="background:var(--card-bg); border-radius:20px; padding:15px; margin-bottom:15px;"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:bold;">${types[type]}</div><button class="btn-small" onclick="clearMealType('${type}')" style="margin:0; padding:2px 8px; font-size:10px; opacity:0.6;">æ¸…ç©º</button></div><div style="margin:5px 0; opacity:0.8;">${items}</div><div style="display:flex; gap:5px; margin-top:10px;"><input class="setting-input" id="in-${type}" placeholder="Add..." style="margin:0; flex:1;"><button class="btn-normal" style="width:auto;" onclick="addMealItem('${type}')">+</button></div></div>`; }); }
    function addMealItem(t) { const v=$(`in-${t}`).value; if(v){ DB.meals.items[t].push({text:v}); localStorage.setItem('v15_meals', JSON.stringify(DB.meals)); renderMealsApp(); } }
    function removeMeal(type, index) { DB.meals.items[type].splice(index, 1); localStorage.setItem('v15_meals', JSON.stringify(DB.meals)); renderMealsApp(); }
    function clearMealType(type) { if(confirm('æ¸…ç©ºè¯¥ç±»ç›®æ‰€æœ‰è®°å½•ï¼Ÿ')) { DB.meals.items[type] = []; localStorage.setItem('v15_meals', JSON.stringify(DB.meals)); renderMealsApp(); } }
    
        function renderExtras() { document.querySelectorAll('.mood-btn').forEach(b=>b.style.opacity='0.4'); if($('mood-'+DB.extras.mood)) $('mood-'+DB.extras.mood).style.opacity='1'; $('fridge-memo').value = DB.extras.fridge || ''; const diff = new Date(DB.extras.cdDate) - new Date(new Date().setHours(0,0,0,0)); $('cd-text').innerText = diff >= 0 ? `è·ç¦»${DB.extras.cdText}` : `${DB.extras.cdText}å·²è¿‡`; $('cd-num').innerText = Math.ceil(Math.abs(diff)/(86400000)); }
        function setMood(m) { 
        DB.extras.mood = m; 
        gainXP(2); // è®°å½•å¿ƒæƒ… +2 XP
        localStorage.setItem('v15_extras', JSON.stringify(DB.extras)); 
        renderExtras(); 
    }
    function saveFridgeMemo() { DB.extras.fridge = $('fridge-memo').value; localStorage.setItem('v15_extras', JSON.stringify(DB.extras)); }
    function updateHisStatus() { $('his-status-display').innerText = ["ğŸš— å›å®¶è·¯ä¸Š", "ğŸŒ™ ä¼‘æ¯ä¸­", "ğŸ’¼ å¼€ä¼šä¸­", "â˜• å–å’–å•¡", "ğŸ® æ‰“æ¸¸æˆä¸­"][Math.floor(Math.random()*5)]; }
    function editCountdown() { $('cd-input-text').value = DB.extras.cdText; $('cd-input-date').value = DB.extras.cdDate; $('modal-countdown').style.display = 'flex'; }
    function saveCountdown() { DB.extras.cdText = $('cd-input-text').value; DB.extras.cdDate = $('cd-input-date').value; localStorage.setItem('v15_extras', JSON.stringify(DB.extras)); renderExtras(); $('modal-countdown').style.display = 'none'; }
    function initDoodle() { const c = $('doodle-canvas'); const ctx = c.getContext('2d'); const rect = c.getBoundingClientRect(); c.width = rect.width; c.height = rect.height; if(DB.doodle) { const img = new Image(); img.onload = () => ctx.drawImage(img,0,0); img.src = DB.doodle; } let drawing = false; const getPos = (e) => { const r = c.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: t.clientX - r.left, y: t.clientY - r.top }; }; c.addEventListener('mousedown', e => { drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }); c.addEventListener('touchstart', e => { drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }); const move = e => { if(!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle="#333"; ctx.lineWidth=2; ctx.stroke(); }; c.addEventListener('mousemove', move); c.addEventListener('touchmove', move); const end = () => { if(drawing) { drawing=false; DB.doodle=c.toDataURL(); localStorage.setItem('v18_doodle', DB.doodle); } }; c.addEventListener('mouseup', end); c.addEventListener('touchend', end); }
    function clearDoodle() { $('doodle-canvas').getContext('2d').clearRect(0,0,$('doodle-canvas').width,$('doodle-canvas').height); DB.doodle=''; localStorage.removeItem('v18_doodle'); }
    function renderPeriodWidget() { const h = DB.period.history; const el = $('period-status-widget'); if (h.length === 0) { el.innerText = "æ— è®°å½•"; return; } h.sort((a,b) => new Date(a.start) - new Date(b.start)); const last = h[h.length-1]; const diff = Math.floor((new Date() - new Date(last.start)) / 86400000); if (diff >= 0 && diff <= 7) { el.innerText = `Day ${diff + 1}`; el.style.color = '#ff3b30'; } else { const next = new Date(last.start); next.setDate(next.getDate() + 28); const daysTo = Math.ceil((next - new Date()) / 86400000); el.innerText = daysTo > 0 ? `T-${daysTo}` : `+${Math.abs(daysTo)}`; el.style.color = 'var(--text-color)'; } }
    function renderPeriodApp() { const h = DB.period.history; const list = $('period-history-list'); list.innerHTML = ''; const sorted = [...h].sort((a,b) => new Date(b.start) - new Date(a.start)); sorted.forEach(item => { list.innerHTML += `<div class="period-log-item"><div><div style="font-weight:bold;">${item.start}</div><div style="font-size:12px;opacity:0.6;">${item.end||'--'}</div></div><button class="btn-secondary" style="padding:5px 10px;" onclick="deletePeriodLog(${item.id})">âœ•</button></div>`; }); if (sorted.length > 0) { const diff = Math.floor((new Date() - new Date(sorted[0].start)) / 86400000); $('p-app-status').innerText = (diff >= 0 && diff <= 7) ? `ç»æœŸç¬¬ ${diff + 1} å¤©` : "ä¸åœ¨ç»æœŸ"; } }
    function addNewPeriodLog() { $('modal-period-add').style.display = 'flex'; $('p-log-start').value = new Date().toISOString().split('T')[0]; }
    function savePeriodLog() { DB.period.history.push({ id: Date.now(), start: $('p-log-start').value, end: $('p-log-end').value }); localStorage.setItem('v19_period', JSON.stringify(DB.period)); $('modal-period-add').style.display = 'none'; renderPeriodApp(); renderPeriodWidget(); }
    function deletePeriodLog(id) { DB.period.history = DB.period.history.filter(x => x.id !== id); localStorage.setItem('v19_period', JSON.stringify(DB.period)); renderPeriodApp(); renderPeriodWidget(); }
    function drawDivination() { const today = new Date().toISOString().split('T')[0]; if (DB.divination.date === today) { alert(`ä»Šæ—¥å·²æ±‚å¦: ${DB.divination.result}`); } else { const res = ASSETS.hexagrams[Math.floor(Math.random() * ASSETS.hexagrams.length)]; DB.divination = { date: today, result: res }; localStorage.setItem('v20_divination', JSON.stringify(DB.divination)); checkDivinationStatus(); alert(`æ±‚å¾—: ${res}`); } }
    function checkDivinationStatus() { if (DB.divination.date === new Date().toISOString().split('T')[0]) { $('divination-text').innerText = DB.divination.result.split('ï¼š')[0]; $('divination-text').style.color = '#eebb4d'; } }
    function seekGuidance() { $('seek-text').innerText = ASSETS.guidance[Math.floor(Math.random() * ASSETS.guidance.length)]; $('overlay-seek').style.display = 'flex'; }
    function checkVault() { if (isVaultUnlocked) { renderVaultContent(); } else { setTimeout(() => { openCustomPrompt("è¾“å…¥é‡‘åº“å¯†ç  (é»˜è®¤1234)", (pwd) => { if (pwd === '1234') { isVaultUnlocked = true; renderVaultContent(); } else { alert("å¯†ç é”™è¯¯"); closeView('view-vault'); } }, "è¯·è¾“å…¥å¯†ç "); }, 300); } }
    function renderVaultContent() { const list = DB.vault.map(v => `<div style="background:var(--card-bg); padding:10px; margin-bottom:5px; border-radius:8px;">${v.text}</div>`).join(''); $('vault-content').innerHTML = `<div style="margin-bottom:10px;"><input id="vault-in" class="setting-input" placeholder="å­˜å…¥ç§˜å¯†..."><button class="btn-normal" onclick="saveVault()">åŠ å¯†å­˜å‚¨</button></div>${list}`; }
    function saveVault() { const t = $('vault-in').value; if(!t) return; DB.vault.unshift({id: Date.now(), text: t}); localStorage.setItem('v20_vault', JSON.stringify(DB.vault)); renderVaultContent(); }
    let isVaultUnlocked = false; 
    
        // === å›¾ç‰‡å‹ç¼©å·¥å…· (é˜²æ­¢æ•°æ®åº“çˆ†ç‚¸) ===
    function compressImage(file, maxWidth = 1024, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // ä¿æŒæ¯”ä¾‹ç¼©æ”¾
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è½¬æ¢å› Blob (å‹ç¼©å)
                    canvas.toBlob(blob => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    }

// === åŠŸå¾·å•†åº—ç³»ç»Ÿ (Merit Shop) ===

// 1. å•†å“é…ç½®
const SHOP_ITEMS = {
    skin: [
        { id: 'skin_default', name: 'åŸæœ¨', icon: 'ğŸ¡', price: 0, text: 'åŠŸå¾· +1' },
        { id: 'skin_gold', name: 'çº¯é‡‘', icon: 'ğŸ†', price: 100, text: 'è´¢è¿ +1' },
        { id: 'skin_cat', name: 'å“ˆå‰ç±³', icon: 'ğŸ±', price: 500, text: 'å–µ +1' },
        { id: 'skin_bug', name: 'Debug', icon: 'âŒ¨ï¸', price: 300, text: 'Bug -1' },
        { id: 'skin_coffee', name: 'ç¾å¼', icon: 'â˜•', price: 150, text: 'ç²¾ç¥ +1' },
        { id: 'skin_love', name: 'çˆ±å¿ƒ', icon: 'ğŸ’—', price: 888, text: 'æ¡ƒèŠ± +1' }
    ],
    effect: [
        { id: 'eff_none', name: 'æ— ç‰¹æ•ˆ', icon: 'ğŸš«', price: 0 },
        { id: 'eff_matrix', name: 'é»‘å®¢é›¨', icon: 'ğŸ’»', price: 1000 }, // èµ›åšé£
        { id: 'eff_sakura', name: 'è½æ¨±', icon: 'ğŸŒ¸', price: 800 },   // æ²»æ„ˆé£
        { id: 'eff_snow', name: 'é£˜é›ª', icon: 'â„ï¸', price: 600 }      // æ°›å›´æ„Ÿ
    ]
};

// 2. åˆå§‹åŒ–æ•°æ®ç»“æ„
// ç¡®ä¿ DB å¯¹è±¡é‡Œæœ‰ shop å­—æ®µ
if (!DB.shop) {
    DB.shop = {
        owned: ['skin_default', 'eff_none'], // å·²æ‹¥æœ‰çš„ ID
        equipped: { skin: 'skin_default', effect: 'eff_none' } // å½“å‰è£…å¤‡
    };
}

// 3. å•†åº—æ ¸å¿ƒé€»è¾‘
let currentShopTab = 'skin';

function openShop() {
    $('modal-shop').style.display = 'flex';
    $('shop-merit-display').innerText = DB.merit;
    renderShopItems();
}

function switchShopTab(tab, btn) {
    currentShopTab = tab;
    document.querySelectorAll('#modal-shop .drawer-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderShopItems();
}

function renderShopItems() {
    const container = $('shop-list');
    container.innerHTML = '';
    
    const items = SHOP_ITEMS[currentShopTab];
    
    items.forEach(item => {
        const isOwned = DB.shop.owned.includes(item.id);
        const isEquipped = DB.shop.equipped[currentShopTab] === item.id;
        const canBuy = DB.merit >= item.price;
        
        let btnText = '';
        let btnClass = 'shop-price';
        let action = '';

        if (isEquipped) {
            btnText = 'ä½¿ç”¨ä¸­';
            btnClass += ' owned';
        } else if (isOwned) {
            btnText = 'è£…å¤‡';
            btnClass += ' owned';
            action = `equipItem('${item.id}', '${currentShopTab}')`;
        } else {
            btnText = item.price + ' åŠŸå¾·';
            if (canBuy) {
                btnClass += ' can-buy';
                action = `buyItem('${item.id}', '${currentShopTab}', ${item.price})`;
            } else {
                action = `alert('åŠŸå¾·ä¸è¶³ï¼Œå¿«å»æ•²æœ¨é±¼ï¼')`;
            }
        }
        
        
        const div = document.createElement('div');
        div.className = `shop-item ${isEquipped ? 'active' : ''}`;
        div.onclick = action ? new Function(action) : null;
        div.innerHTML = `
            <div class="shop-icon">${item.icon}</div>
            <div class="shop-name">${item.name}</div>
            <div class="${btnClass}">${btnText}</div>
        `;
        container.appendChild(div);
    });
}

function buyItem(id, type, price) {
    if (DB.merit >= price) {
        if(confirm(`ç¡®å®šèŠ±è´¹ ${price} åŠŸå¾·è´­ä¹°ã€${SHOP_ITEMS[type].find(i=>i.id===id).name}ã€‘å—ï¼Ÿ`)) {
            DB.merit -= price;
            DB.shop.owned.push(id);
            localStorage.setItem('v30_merit', DB.merit);
            saveShopData();
            $('shop-merit-display').innerText = DB.merit;
            $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
            
                        // è´­ä¹°åè‡ªåŠ¨è£…å¤‡
            equipItem(id, type);
            alert("è´­ä¹°æˆåŠŸï¼ğŸ‰");
        }
    }
}

function equipItem(id, type) {
    DB.shop.equipped[type] = id;
    saveShopData();
    renderShopItems();
    applyVisuals(); // ç«‹å³åº”ç”¨æ•ˆæœ
}

function saveShopData() {
    // è¿™é‡Œæˆ‘ä»¬æŠŠ shop æ•°æ®æ··å…¥ v30_merit æˆ–è€…å•ç‹¬å­˜ä¸€ä¸ª key
    // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å•ç‹¬å­˜ä¸€ä¸ª key
    localStorage.setItem('v30_shop', JSON.stringify(DB.shop));
}

// 4. è§†è§‰æ•ˆæœåº”ç”¨ (æ ¸å¿ƒ)
function applyVisuals() {
    // 4.1 åº”ç”¨çš®è‚¤ (å›¾æ ‡)
    const skinId = DB.shop.equipped.skin;
    const skin = SHOP_ITEMS.skin.find(i => i.id === skinId) || SHOP_ITEMS.skin[0];
    const fishIcon = $('fish-icon-display');
    if(fishIcon) fishIcon.innerText = skin.icon;
    
    // æ›´æ–°æ•²å‡»æ—¶çš„æ–‡å­— (å­˜åˆ°å…¨å±€å˜é‡é‡Œä¾› knockWoodenFish ä½¿ç”¨)
    window.currentPopText = skin.text; 

    // 4.2 åº”ç”¨èƒŒæ™¯ç‰¹æ•ˆ
    const effectId = DB.shop.equipped.effect;
    stopCurrentEffect(); // å…ˆåœæ­¢æ—§çš„
    
    if (effectId === 'eff_matrix') startMatrixEffect();
    else if (effectId === 'eff_sakura') startSakuraEffect();
    else if (effectId === 'eff_snow') startSnowEffect();
}

// ä¿®æ”¹åŸæœ‰çš„ knockWoodenFish å‡½æ•°ï¼Œæ”¯æŒè‡ªå®šä¹‰æ–‡å­—
// (ä½ éœ€è¦æŠŠåŸæ¥ HTML é‡Œçš„ knockWoodenFish å‡½æ•°æ›¿æ¢æˆè¿™ä¸ªï¼Œæˆ–è€…ä¿®æ”¹å®ƒ)
const originalKnock = knockWoodenFish; // å¤‡ä»½æ—§å‡½æ•°
knockWoodenFish = function(e) {
    // 1. è°ƒç”¨æ—§é€»è¾‘ (åŠ åŠŸå¾·)
    DB.merit = (DB.merit || 0) + 1;
    localStorage.setItem('v30_merit', DB.merit);
    $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
    
        // 2. åŠ¨ç”»
    const fish = e.currentTarget.querySelector('.wooden-fish-icon');
    fish.style.transform = "scale(0.9)";
    setTimeout(() => fish.style.transform = "scale(1)", 100);
    
    // 3. é£˜å­— (ä½¿ç”¨çš®è‚¤å®šä¹‰çš„æ–‡å­—)
    const pop = document.createElement('div');
    pop.className = 'merit-popup';
    pop.innerText = window.currentPopText || 'åŠŸå¾· +1'; // ä½¿ç”¨è‡ªå®šä¹‰æ–‡å­—
    e.currentTarget.querySelector('.wooden-fish-widget').appendChild(pop);
    setTimeout(() => pop.remove(), 1000);
    
    if(navigator.vibrate) navigator.vibrate(50);
}

// === ç‰¹æ•ˆå¼•æ“ (Canvas) ===
let effectCtx = null;
let effectAnimationId = null;
let effectCanvas = null;

function initEffectCanvas() {
    // åŠ¨æ€åˆ›å»º canvas æ’å…¥åˆ° phone-container çš„æœ€å‰é¢
    if (!$('effect-canvas')) {
        const c = document.createElement('canvas');
        c.id = 'effect-canvas';
        const container = $('phone-container');
        // æ’å…¥åˆ° status-bar åé¢ï¼Œæˆ–è€…ç›´æ¥ä½œä¸º container çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ 
        container.insertBefore(c, container.firstChild);
        
                effectCanvas = c;
        effectCtx = c.getContext('2d');
        
        // è‡ªé€‚åº”å¤§å°
        const resize = () => {
            c.width = container.clientWidth;
            c.height = container.clientHeight;
        };
        window.addEventListener('resize', resize);
        resize();
    }
}

function stopCurrentEffect() {
    if (effectAnimationId) cancelAnimationFrame(effectAnimationId);
    if (effectCtx && effectCanvas) effectCtx.clearRect(0, 0, effectCanvas.width, effectCanvas.height);
}

// --- ç‰¹æ•ˆ 1: é»‘å®¢å¸å›½ (Matrix) ---
function startMatrixEffect() {
    initEffectCanvas();
    const w = effectCanvas.width, h = effectCanvas.height;
    const cols = Math.floor(w / 20) + 1;
    const ypos = Array(cols).fill(0);

    function step() {
        effectCtx.fillStyle = 'rgba(0, 0, 0, 0.05)'; // æ‹–å°¾æ•ˆæœ
        effectCtx.fillRect(0, 0, w, h);
        
        effectCtx.fillStyle = '#0f0';
        effectCtx.font = '15px monospace';
        
        ypos.forEach((y, ind) => {
            const text = String.fromCharCode(Math.random() * 128);
            const x = ind * 20;
            effectCtx.fillText(text, x, y);
            if (y > 100 + Math.random() * 10000) ypos[ind] = 0;
            else ypos[ind] = y + 20;
        });
        effectAnimationId = requestAnimationFrame(step);
    }
    step();
}

// --- ç‰¹æ•ˆ 2: æ¨±èŠ± (Sakura) ---
function startSakuraEffect() {
    initEffectCanvas();
    const w = effectCanvas.width, h = effectCanvas.height;
    const petals = Array(30).fill().map(() => ({
        x: Math.random() * w,
        y: Math.random() * h - h,
        size: Math.random() * 10 + 5,
        speed: Math.random() * 2 + 1,
        sway: Math.random() * 2 // å·¦å³æ‘‡æ‘†å¹…åº¦
    }));

    function step() {
        effectCtx.clearRect(0, 0, w, h);
        effectCtx.fillStyle = 'rgba(255, 183, 197, 0.8)';
        
        petals.forEach(p => {
            effectCtx.beginPath();
            effectCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            effectCtx.fill();
            
            p.y += p.speed;
            p.x += Math.sin(p.y * 0.01) * p.sway;
            
            if (p.y > h) p.y = -20;
        });
        effectAnimationId = requestAnimationFrame(step);
    }
    step();
}

// --- ç‰¹æ•ˆ 3: é£˜é›ª (Snow) ---
function startSnowEffect() {
    initEffectCanvas();
    const w = effectCanvas.width, h = effectCanvas.height;
    const flakes = Array(50).fill().map(() => ({
        x: Math.random() * w,
        y: Math.random() * h - h,
        size: Math.random() * 3 + 1,
        speed: Math.random() * 1 + 0.5
    }));

    function step() {
        effectCtx.clearRect(0, 0, w, h);
        effectCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        
        flakes.forEach(p => {
            effectCtx.beginPath();
            effectCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            effectCtx.fill();
            p.y += p.speed;
            if (p.y > h) p.y = -5;
        });
        effectAnimationId = requestAnimationFrame(step);
    }
    step();
}


// 5. åˆå§‹åŒ–åŠ è½½
// åœ¨ window.onload çš„æœ€åè°ƒç”¨è¿™ä¸ª
function initShopSystem() {
    // è¯»å–ä¿å­˜çš„å•†åº—æ•°æ®
    const savedShop = localStorage.getItem('v30_shop');
    if (savedShop) {
        DB.shop = JSON.parse(savedShop);
    }
    // åº”ç”¨å½“å‰è£…å¤‡
    applyVisuals();
}

// æ‰‹åŠ¨æŠŠå®ƒåŠ åˆ° window.onload é‡Œï¼Œæˆ–è€…ç›´æ¥åœ¨è¿™é‡Œæ‰§è¡Œ(å¦‚æœè„šæœ¬åœ¨bodyå)
// ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ hook ä¸€ä¸‹
const oldOnload = window.onload;
window.onload = async () => {
    if(oldOnload) await oldOnload();
    initShopSystem();
    await renderBusinessCard(); // âœ… æ–°å¢è¿™ä¸€è¡Œ
};

/* è¯·å°†è¿™æ®µä»£ç æ”¾åœ¨ <script> æ ‡ç­¾çš„æœ€åé¢ï¼Œ
   æˆ–è€…æ”¾åœ¨ window.onload = async () => { ... } çš„å¤§æ‹¬å·å¤–é¢ 
*/

// 1. è·å–å®¹å™¨
const scrollContainer = document.getElementById('scroll-container');

// 2. ä¼˜åŒ–çš„æ»šåŠ¨ç›‘å¬å˜é‡
let isScrolling = false;

// 3. ç›‘å¬æ»šåŠ¨äº‹ä»¶ (æ›¿ä»£åŸæ¥çš„ onscroll="updateDots()")
if (scrollContainer) {
    scrollContainer.addEventListener('scroll', () => {
        if (!isScrolling) {
            window.requestAnimationFrame(() => {
                updateDots();
                isScrolling = false;
            });
            isScrolling = true;
        }
    }, { passive: true }); // passive: true è®©æ»šåŠ¨æ›´æµç•…
}

// 4. ä¼˜åŒ–åçš„ updateDots å‡½æ•° (å¦‚æœä½ åŸæ¥çš„æ²¡åˆ ï¼Œå¯ä»¥ç›´æ¥è¦†ç›–)
function updateDots() {
    const sl = scrollContainer.scrollLeft;
    const w = scrollContainer.clientWidth; // ä½¿ç”¨ clientWidth æ›´å‡†ç¡®
    // è®¡ç®—å½“å‰é¡µ (å››èˆäº”å…¥ï¼Œè¶…è¿‡ä¸€åŠå°±ç®—ä¸‹ä¸€é¡µ)
    const p = Math.round(sl / w) + 1;

    for (let i = 1; i <= 6; i++) {
        const d = document.getElementById(`dot-${i}`);
        if (d) {
            // åªåœ¨çŠ¶æ€æ”¹å˜æ—¶æ“ä½œ DOMï¼Œå‡å°‘é—ªçƒ
            const isActive = (i === p);
            if (isActive && !d.classList.contains('active')) {
                d.classList.add('active');
            } else if (!isActive && d.classList.contains('active')) {
                d.classList.remove('active');
            }
        }
    }
}

// === è‡ªå®šä¹‰å£çº¸åŠŸèƒ½ ===
    async function saveCustomWallpaper() {
        const urlInput = $('wp-url-input').value;
        const fileInput = $('wp-file-upload');
        let src = '';

        if (fileInput.files[0]) {
            // å­˜æ–‡ä»¶åˆ° DB
            await db.settings.put({key: 'customWallpaper', value: fileInput.files[0]});
            src = URL.createObjectURL(fileInput.files[0]);
        } else if (urlInput) {
            // å­˜ URL åˆ° DB
            await db.settings.put({key: 'customWallpaper', value: urlInput});
            src = urlInput;
        }

        if (src) {
            applyCustomWallpaper(src);
            $('modal-theme-wp').style.display = 'none';
        }
    }

    async function loadCustomWallpaper() {
        const bg = await db.settings.get('customWallpaper');
        if (bg) {
            let src = bg.value;
            if (bg.value instanceof Blob) src = URL.createObjectURL(bg.value);
            applyCustomWallpaper(src);
        }
    }

    function applyCustomWallpaper(src) {
        document.body.style.backgroundImage = `url('${src}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        // æ›´æ–°é¢„è§ˆå›¾
        $('current-wp-preview').innerText = '';
        $('current-wp-preview').style.backgroundImage = `url('${src}')`;
    }

    async function clearCustomWallpaper() {
        await db.settings.delete('customWallpaper');
        document.body.style.backgroundImage = ''; // æ¢å¤é»˜è®¤
        $('current-wp-preview').style.backgroundImage = '';
        $('current-wp-preview').innerText = 'å·²æ¢å¤é»˜è®¤';
    }


    // === æ¼‚æµç“¶ (Drift Bottle) ===
    
    // åˆå§‹åŒ–æ•°æ®ç»“æ„
    if (!DB.bottles) DB.bottles = [];

    // === æ–°ç‰ˆï¼šæ‰“å¼€æ¼‚æµç“¶ï¼ˆè‡ªåŠ¨åˆ·æ€ªï¼‰ ===
    function openDriftBottle() {
    openView('view-bottle');
    
    if (!DB.bottles) DB.bottles = [];

    // === æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å†·å´æ—¶é—´å’Œæ•°é‡é™åˆ¶ ===
    const now = Date.now();
    // è¯»å–ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ (å¦‚æœæ²¡æœ‰ï¼Œå°±é»˜è®¤ä¸º0)
    const lastRefresh = parseInt(localStorage.getItem('v30_last_bottle_refresh') || '0');
    // è®¾ç½®å†·å´æ—¶é—´ï¼š4å°æ—¶ (4 * 60 * 60 * 1000)
    const cooldown = 4 * 60 * 60 * 1000; 

    // æ¡ä»¶1ï¼šæµ·é¢ä¸Šçš„ç“¶å­å°‘äº 3 ä¸ª (åŸæ¥æ˜¯5ä¸ªï¼Œæ”¹å°‘ä¸€ç‚¹)
    // æ¡ä»¶2ï¼šè·ç¦»ä¸Šæ¬¡åˆ·æ–°å·²ç»è¿‡äº† 4 å°æ—¶ (æˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡ç©)
    if (DB.bottles.length < 3 && (now - lastRefresh > cooldown)) {
        
        // æ¯æ¬¡åªç”Ÿæˆ 1 ä¸ªæ–°ç“¶å­ (ä¸è¦ä¸€æ¬¡åˆ·ä¸€å †)
        DB.bottles.push({
            id: Date.now() + Math.random(), 
            type: 'system',     
            status: 'floating',
            content: 'ä¸€å¼ æ¨¡ç³Šçš„å­—æ¡...',
            unlockTime: 0 
        });

        // è®°å½•è¿™æ¬¡åˆ·æ–°çš„æ—¶é—´
        localStorage.setItem('v30_last_bottle_refresh', now);
        // ä¿å­˜ç“¶å­æ•°æ®
        localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
    }

    renderBottleSea();
    
    // æ¸²æŸ“è§’è‰²åˆ—è¡¨
    const list = $('bottle-char-list');
    if(list) {
        list.innerHTML = DB.contacts.map(c => 
            `<div class="char-option" onclick="toggleCharSelect(this, ${c.id})" data-cid="${c.id}">${c.name}</div>`
        ).join('');
    }
}


    function throwBottle() {
        const content = $('bottle-content').value;
        const delayMinutes = parseInt($('bottle-time-select').value);
        
        // è·å–é€‰ä¸­çš„è§’è‰²
        const selectedEls = document.querySelectorAll('.char-option.selected');
        const selectedIds = Array.from(selectedEls).map(el => parseInt(el.dataset.cid));

        if (!content) return alert("å†™ç‚¹ä»€ä¹ˆå§...");
        if (selectedIds.length === 0) return alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå¯èƒ½æ¡åˆ°ç“¶å­çš„äºº");

        const unlockTime = Date.now() + (delayMinutes * 60 * 1000); // æ ¸å¿ƒï¼šè®¡ç®—è§£é”æ—¶é—´æˆ³

        DB.bottles.push({
            id: Date.now(),
            content: content,
            pool: selectedIds, // å€™é€‰äººæ± 
            unlockTime: unlockTime,
            status: 'floating', // floating (æ¼‚æµä¸­), arrived (å·²åˆ°è¾¾/å¯è¯»), replied (å·²è¯»)
            reply: null,
            finderId: null // è¿˜æ²¡å®šæ˜¯è°æ¡åˆ°çš„
        });

        // å­˜å…¥ LocalStorage (ç®€å•èµ·è§å­˜LSï¼Œä¹Ÿå¯ä»¥å­˜Dexie)
        localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
        
        $('modal-throw-bottle').style.display = 'none';
        $('bottle-content').value = '';
        renderBottleSea();
        alert("ğŸ¾ ç“¶å­æ‰”å‡ºå»äº†ï¼ç­‰å¾…ç¼˜åˆ†å§...");
    }

    // === æ–°ç‰ˆï¼šæ¸²æŸ“å¤§æµ·ï¼ˆåŒºåˆ†ç³»ç»Ÿç“¶å’Œç”¨æˆ·ç“¶ï¼‰ ===
    function renderBottleSea() {
        const sea = $('bottle-sea-area');
        // ä¿ç•™æµ·æµªï¼Œæ¸…ç©ºç“¶å­
        sea.innerHTML = '<div class="bottle-wave"></div>';
        
        if (!DB.bottles) DB.bottles = [];
        const now = Date.now();

        DB.bottles.forEach((b, index) => {
            // éšæœºä½ç½®ç®—æ³•ä¼˜åŒ–ï¼Œé˜²æ­¢é‡å 
            const left = (index * 23 + 10) % 85; 
            const top = (index * 17 + 15) % 65;
            
            let icon = 'ğŸ¾';
            let label = 'æ¼‚æµä¸­';
            let clickAction = ''; 

            // === æ ¸å¿ƒé€»è¾‘ä¿®æ”¹å¼€å§‹ ===
            if (b.type === 'system') {
                // ç³»ç»Ÿç“¶ï¼šé—®å·å›¾æ ‡
                icon = 'â“'; 
                label = 'æœªçŸ¥ç“¶å­';
                clickAction = `checkSystemBottle(${b.id})`;
            } else {
                // ç”¨æˆ·ç“¶ï¼šåˆ¤æ–­çŠ¶æ€
                let displayStatus = b.status;
                if (b.status === 'floating' && now >= b.unlockTime) displayStatus = 'arrived';
                
                if (displayStatus === 'arrived' || displayStatus === 'replied') {
                    icon = 'ğŸ’Œ';
                    label = 'æœ‰å›ä¿¡!';
                    clickAction = `openFoundBottle(${b.id})`; 
                } else {
                    clickAction = `alert('è¿™æ˜¯ä½ æ‰”å‡ºçš„ç“¶å­ï¼Œè¿˜æ²¡äººæ¡åˆ°å‘¢...')`;
                }
            }
            // === æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ç»“æŸ ===

            const div = document.createElement('div');
            div.className = 'bottle-item';
            div.style.left = left + '%';
            div.style.top = top + '%';
            div.style.animationDelay = (index * 0.3) + 's'; // é”™å¼€åŠ¨ç”»æ—¶é—´
            div.innerHTML = `<div>${icon}</div><div class="bottle-name">${label}</div>`;
            div.setAttribute('onclick', clickAction); // ä½¿ç”¨ setAttribute å…¼å®¹æ€§æ›´å¥½
            
            sea.appendChild(div);
        });
    }

    // æ‰“å¼€ç“¶å­ï¼ˆæ ¸å¿ƒ AI è°ƒç”¨é€»è¾‘ï¼‰
    async function openFoundBottle(bid) {
        const bottle = DB.bottles.find(b => b.id === bid);
        if (!bottle) return;

        // å¦‚æœå·²ç»æœ‰å›å¤äº†ï¼Œç›´æ¥æ˜¾ç¤º
        if (bottle.reply) {
            showReadModal(bottle);
            return;
        }

        // --- è¿˜æ²¡å›å¤ï¼Œç°åœ¨ç°åœºç”Ÿæˆï¼---
        
        // 1. ä»å€™é€‰æ± é‡Œéšæœºé€‰ä¸€ä¸ªäºº
        const finderId = bottle.pool[Math.floor(Math.random() * bottle.pool.length)];
        const finder = DB.contacts.find(c => c.id === finderId);
        
        if (!finder) return alert("æ¡åˆ°ç“¶å­çš„äººå¥½åƒæ¶ˆå¤±äº†...");

        // 2. é‡ç½®å¹¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”» (ä¿®å¤ç‰ˆ)
        // âœ… æ–°å¢ï¼šå…ˆæŠŠå½“å‰ç“¶å­çš„æ­£ç¡®å†…å®¹æ”¾è¿›å»
        $('read-bottle-my-content').innerText = bottle.content; 
        // âœ… æ–°å¢ï¼šæ¸…ç©ºæ—§çš„æ—¶é—´
        $('read-bottle-time').innerText = '...'; // ç”¨çœç•¥å·è¡¨ç¤ºæ­£åœ¨åŠ è½½

        // æ›´æ–°åŠ è½½çŠ¶æ€
        $('read-bottle-sender').innerText = "æ­£åœ¨æ‰“å¼€...";
        $('read-bottle-reply').innerText = "å¯¹æ–¹æ­£åœ¨é˜…è¯»ä½ çš„å­—æ¡...";
        
        // åº”ç”¨æœ€æ–°çš„çš®è‚¤è®¾ç½®
        applyBottleVisuals();
        
        // æœ€åå†æ˜¾ç¤ºå¼¹çª—
        $('modal-read-bottle').style.display = 'flex';

        // 3. è·å–å½“å‰çœŸå®æ—¶é—´ï¼Œç”¨äº Prompt
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        const isNight = now.getHours() >= 22 || now.getHours() < 5;
        
        try {
            const systemPrompt = `
            You are roleplaying as ${finder.name}.
            [Persona]: ${finder.prompt}
            
            [Scenario]: You just picked up a "Drift Bottle" (message in a bottle) on the beach.
            The user wrote: "${bottle.content}".
            
            [Real-Time Context]: 
            - Current Time: ${timeString}.
            - This is VERY important. If it's late night, mention it (e.g., "Can't sleep?"). If it's morning, say good morning.
            
            [Task]: Write a warm, lifestyle-oriented reply.
            - Maybe you are walking on the beach, or just finished work.
            - Connect your persona + the user's message + the current time.
            - Keep it short, casual, and conversational. No asterisks.
            `;

            const reply = await callAI([
                {role: 'system', content: systemPrompt},
                {role: 'user', content: "Please reply to my bottle."}
            ]);

            // 4. ä¿å­˜ç»“æœ
            bottle.status = 'replied';
            bottle.finderId = finderId;
            bottle.reply = reply;
            bottle.unlockTime = Date.now(); // æ›´æ–°æ—¶é—´ä¸ºå®é™…æ‰“å¼€æ—¶é—´
            
            // æ›´æ–°å­˜å‚¨
            localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
            
            // 5. æ›´æ–° UI
            showReadModal(bottle);
            renderBottleSea(); // åˆ·æ–°å¤§æµ·å›¾æ ‡

        } catch (e) {
            alert("ç½‘ç»œä¿¡å·ä¸å¥½ï¼Œç“¶å­æ²¡æ‰“å¼€...\n" + e.message);
            $('modal-read-bottle').style.display = 'none';
        }
    }

    function showReadModal(bottle) {
        const finder = DB.contacts.find(c => c.id === bottle.finderId);
        $('read-bottle-sender').innerText = finder ? finder.name : 'ç¥ç§˜äºº';
        $('read-bottle-time').innerText = new Date(bottle.unlockTime).toLocaleString();
        $('read-bottle-my-content').innerText = bottle.content;
        $('read-bottle-reply').innerText = bottle.reply;
        
        // âœ… æ–°å¢ï¼šåœ¨æ˜¾ç¤ºä¹‹å‰ï¼Œåº”ç”¨æœ€æ–°çš„çš®è‚¤è®¾ç½®ï¼
        applyBottleVisuals(); 
        
        $('modal-read-bottle').style.display = 'flex';
    }
    
    // === ğŸ¨ æ¼‚æµç“¶çš®è‚¤ç³»ç»Ÿ ===
    
    // åˆå§‹åŒ–é»˜è®¤è®¾ç½®
    if (!DB.bottleSettings) {
        DB.bottleSettings = { sea: 'bg-sea-day', paper: 'skin-scroll' };
    }

    // 1. è®¾ç½®å¤§æµ·èƒŒæ™¯
    function setBottleSea(className, btn) {
        DB.bottleSettings.sea = className;
        saveBottleSettings();
        applyBottleVisuals();
        
        // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('#modal-bottle-settings .skin-option').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active'); // ç®€å•é«˜äº®
    }

// 2. è®¾ç½®ä¿¡çº¸çš®è‚¤ (ä¿®å¤ç‰ˆ)
    function setBottlePaper(className, btn) {
        DB.bottleSettings.paper = className;
        saveBottleSettings();
        
        // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
        const parent = btn.parentElement;
        parent.querySelectorAll('.skin-option').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');

        // å¦‚æœè¯»ä¿¡å¼¹çª—ç¢°å·§å¼€ç€ï¼Œç«‹åˆ»åˆ·æ–°å®ƒ
        if ($('modal-read-bottle').style.display === 'flex') {
            applyBottleVisuals();
        }
    }

    function saveBottleSettings() {
        localStorage.setItem('v30_bottle_settings', JSON.stringify(DB.bottleSettings));
    }

    // 3. åº”ç”¨è§†è§‰æ•ˆæœ (æ‰“å¼€ç•Œé¢æ—¶è°ƒç”¨)
    function applyBottleVisuals() {
        // åº”ç”¨å¤§æµ·èƒŒæ™¯
        const sea = $('bottle-sea-area');
        if (sea) {
            // æ¸…é™¤æ—§çš„ bg-sea-xxx ç±»
            sea.className = 'bottle-sea ' + DB.bottleSettings.sea;
        }

        // åº”ç”¨ä¿¡çº¸çš®è‚¤
        const card = $('read-bottle-card');
        if (card) {
            // æ¸…é™¤æ—§çš„ skin-xxx ç±»
            card.className = 'modal-card bottle-modal-base ' + DB.bottleSettings.paper;
        }
    }

    // === Hook åˆ°åŸæœ‰é€»è¾‘ä¸­ ===
    
    // 1. åœ¨ openDriftBottle é‡Œè°ƒç”¨ apply
    const oldOpenDriftBottle = openDriftBottle;
    openDriftBottle = function() {
        oldOpenDriftBottle(); // æ‰§è¡Œæ—§é€»è¾‘
        // åŠ è½½è®¾ç½®
        const saved = localStorage.getItem('v30_bottle_settings');
        if(saved) DB.bottleSettings = JSON.parse(saved);
        applyBottleVisuals();
    };
    
// === â¤ï¸ äº²æ˜µç³»ç»Ÿé€»è¾‘ (å«æš§æ˜§å‡æ¸©) ===

// è¯»å–æš§æ˜§å€¼ (å¦‚æœæ²¡æœ‰åˆ™ä¸º0)
let loveHeat = parseInt(localStorage.getItem('v33_heat') || '0');

// åˆå§‹åŒ–æ—¶æ›´æ–°ç•Œé¢ (è¯·æŠŠ updateHeatUI() æ”¾åˆ° initTouchApp é‡Œè°ƒç”¨ä¸€ä¸‹)
function updateHeatUI() {
    const bar = document.getElementById('heat-bar');
    const txt = document.getElementById('heat-text');
    if(bar && txt) {
        bar.style.width = loveHeat + '%';
        txt.innerText = loveHeat + '%';
        
        if(loveHeat >= 100) {
            bar.classList.add('heat-full');
            txt.innerText = "MAX (ç‚¹å‡»è§¦å‘)";
        } else {
            bar.classList.remove('heat-full');
        }
    }
}

// æ ¸å¿ƒå‘é€å‡½æ•°
async function sendTouchAction(action) {
    const cid = $('touch-role-select').value;
    const role = DB.contacts.find(c => c.id == cid);
    if (!role) return alert("è¯·å…ˆæ·»åŠ è§’è‰²ï¼");

    // --- ğŸŒ¡ï¸ æš§æ˜§å‡æ¸©é€»è¾‘ ---
    let heatGain = 5; // æ™®é€šåŠ¨ä½œ +5
    if (action === 'äº²å»') heatGain = 10;
    if (action === 'ç¼ ç»µ') heatGain = 20;
    if (action === 'å¿ƒè·³') heatGain = 2;

    loveHeat += heatGain;
    if (loveHeat > 100) loveHeat = 100; // ä¸Šé™100
    localStorage.setItem('v33_heat', loveHeat); // ä¿å­˜
    updateHeatUI();
    // -----------------------

    // 1. æ‰“å¼€å¼¹çª—
    $('modal-touch-result').style.display = 'flex';
    const display = $('touch-display-text');
    display.innerHTML = `<div style="text-align:center; color:#999; margin-top:40px;">å¯¹æ–¹æ­£åœ¨æ„ŸçŸ¥...<br>ğŸ’—</div>`;

            try {
        // 2. æ„å»º Prompt
        let systemPrompt = `ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt}ã€‚
        ã€æƒ…å¢ƒã€‘ï¼šç”¨æˆ·å¯¹ä½ åšäº†ã€${action}ã€‘ã€‚
        ã€è¦æ±‚ã€‘ï¼š
        1. å¿…é¡»ç”¨**ç¬¬ä¸€äººç§°**æå†™ä½ çš„ç”Ÿç†ååº”ã€ç¥æ€å’Œå¿ƒç†æ´»åŠ¨ã€‚
        2. æ‹’ç»åˆ»æ¿å°è±¡ï¼Œè¦çœŸå®ã€ç»†è…»ã€æœ‰ç”Ÿæ´»æ„Ÿã€‚
        3. ä½ çš„å†…å¿ƒæ˜¯æ·±çˆ±ç”¨æˆ·çš„ï¼Œå³ä½¿å˜´ä¸Šä¸è¯´ï¼Œèº«ä½“ååº”æ˜¯è¯šå®çš„ã€‚
        4. ç»å¯¹ç¦æ­¢ä»»ä½•æ²¹è…»æå†™ã€‚èšç„¦äºæƒ…æ„Ÿã€è§¦æ„Ÿï¼Œä½¿ç”¨ç»†è…»ç™½æï¼Œæ‘’é™¤åœŸå‘³ã€æ²¹è…»çš„è¯æ±‡ã€‚`;

        // ğŸ”¥ é’ˆå¯¹â€œç¼ ç»µâ€çš„ç‰¹æ®ŠæŒ‡ä»¤
        if (action === 'ç¼ ç»µ') {
            systemPrompt += `
            âš ï¸ã€ç‰¹æ®Šæ¨¡å¼ã€‘ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸äº²å¯†ã€å……æ»¡æ¿€æƒ…çš„æ—¶åˆ»ã€‚
            - è¯·æå†™å¾—æ›´åŠ å¤§èƒ†ã€æ²‰æµ¸ã€æ„Ÿæ€§ã€‚
            - é‡ç‚¹æå†™å‘¼å¸ã€ä½“æ¸©ã€çœ¼ç¥ã€è§¦ç¢°æ„Ÿã€‚
            - è¯­æ°”å¯ä»¥ç¨å¾®å¤±æ§ã€å–˜æ¯æˆ–æ›´åŠ æ·±æƒ…ã€‚
            - ç»å¯¹ç¦æ­¢ä»»ä½•æ²¹è…»ã€åœŸå‘³è‡ªç§°ï¼›ç¦æ­¢æ²¹è…»æå†™ã€‚`;
        }

        // ğŸ”¥ é’ˆå¯¹â€œæ»¡å€¼å½©è›‹â€çš„ç‰¹æ®ŠæŒ‡ä»¤
        let userContent = `(æˆ‘å¯¹ä½ åšäº†åŠ¨ä½œï¼š${action})`;
        
                if (loveHeat >= 100) {
            userContent += ` (æ³¨æ„ï¼šç°åœ¨çš„æš§æ˜§æ°”æ°›å·²ç»è¾¾åˆ°äº†é¡¶å³°(100%)ï¼è¯·åœ¨è¿™ä¸ªå›å¤ä¸­ï¼Œä¸»åŠ¨å‘æˆ‘ç´¢å–æ›´å¤šï¼Œæˆ–è€…åšä¸€ä¸ªå¤§èƒ†çš„ä¸¾åŠ¨ï¼Œæ‰“ç ´æœ€åçš„çŸœæŒã€‚å›å¤ç»“æŸåï¼Œæš§æ˜§å€¼å°†æ¸…é›¶ã€‚)`;
            // è§¦å‘å®Œå½©è›‹åæ¸…é›¶
            loveHeat = 0;
            localStorage.setItem('v33_heat', 0);
            updateHeatUI();
        }

        const res = await callAI([
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userContent }
        ]);

                    // 3. æ˜¾ç¤ºç»“æœ
        display.innerHTML = res.replace(/\n/g, '<br>');

        // 4. æš‚å­˜æ•°æ®
        currentTouchData = {
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            roleName: role.name,
            action: action,
            content: res
        };

        if(navigator.vibrate) navigator.vibrate([50, 50, 100]);

    } catch (e) {
        display.innerHTML = "è¿æ¥æ–­å¼€äº†... (API Error)";
    }
}

// åˆ«å¿˜äº†ä¿®æ”¹ initTouchAppï¼Œè®©å®ƒæ‰“å¼€æ—¶åˆ·æ–°è¿›åº¦æ¡
function initTouchApp() {
    const select = $('touch-role-select');
    if (select) {
        select.innerHTML = DB.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
    updateHeatUI(); // <--- åŠ ä¸Šè¿™ä¸€è¡Œ
}
    
        // === ä¿®å¤åçš„åˆ é™¤å‡½æ•° ===
    function deleteTouchItem(event, id) {
        event.stopPropagation(); // é˜²æ­¢è§¦å‘ç‚¹å‡»æŸ¥çœ‹
        if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¿†å—ï¼Ÿ")) {
            // æ³¨æ„ï¼šfilter è¿”å›æ–°æ•°ç»„ï¼Œå¿…é¡»é‡æ–°èµ‹å€¼ç»™ DB.touchHistory
            DB.touchHistory = DB.touchHistory.filter(i => i.id !== id);
            localStorage.setItem('v33_touch_history', JSON.stringify(DB.touchHistory));
            
            // å¦‚æœå½“å‰æ­£å¥½å¼€ç€æ”¶è—åˆ—è¡¨ï¼Œåˆ·æ–°å®ƒ
            if(document.getElementById('modal-touch-collection').style.display === 'flex') {
                renderTouchCollection();
            }
        }
    }
    
        // === è¡¥å…¨ï¼šæ¸²æŸ“æ”¶è—åˆ—è¡¨å‡½æ•° ===
    function renderTouchCollection() {
        const list = document.getElementById('touch-collection-list');
        if(!list) return;
        list.innerHTML = '';

        if(DB.touchHistory.length === 0) {
            list.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">æš‚æ— æ”¶è—çš„å›å¿†</div>';
            return;
        }

        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        const sorted = [...DB.touchHistory].sort((a,b) => b.id - a.id);
        
        // æŒ‰æ—¥æœŸåˆ†ç»„
        let lastDate = '';
        sorted.forEach(item => {
            if(item.date !== lastDate) {
                list.innerHTML += `<div class="touch-date-header">${item.date}</div>`;
                lastDate = item.date;
            }
            
            const preview = item.content.substring(0, 30).replace(/\n/g, ' ') + '...';
            
            list.innerHTML += `
                <div class="touch-history-item" onclick="readTouchItem(event, ${item.id})">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <span class="t-action-tag">${item.action}</span>
                            <span class="t-role-name">${item.roleName}</span>
                        </div>
                        <button class="btn-icon" style="color:#ff3b30; font-size:14px; padding:0;" onclick="deleteTouchItem(event, ${item.id})">ğŸ—‘ï¸</button>
                    </div>
                    <div style="font-size:13px; opacity:0.8; line-height:1.5; margin-top:5px;">${preview}</div>
                </div>
            `;
        });
        
                // æ‰“å¼€å¼¹çª—
        document.getElementById('modal-touch-collection').style.display = 'flex';
    }
    
        // === è¡¥å…¨ï¼šä¿å­˜å½“å‰ç»“æœ ===
    function saveCurrentTouch() {
        if(!currentTouchData) return alert("æ²¡æœ‰å¯æ”¶è—çš„å†…å®¹");
        
        // æŸ¥é‡
        if(DB.touchHistory.some(i => i.id === currentTouchData.id)) {
            return alert("è¿™æ¡å·²ç»æ”¶è—è¿‡å•¦");
        }
        
        DB.touchHistory.unshift(currentTouchData);
        localStorage.setItem('v33_touch_history', JSON.stringify(DB.touchHistory));
        alert("â¤ï¸ å·²æ”¶è—è¿›å›å¿†å½•");
        $('modal-touch-result').style.display = 'none';
    }
    
    // ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å›å¿†
    function readTouchItem(event, id) {
        event.stopPropagation();
        const item = DB.touchHistory.find(i => i.id === id);
        if (item) {
                $('modal-touch-collection').style.display = 'none'; 
        
        // ç„¶åæ‰“å¼€è¯¦æƒ…å¼¹çª—
        $('modal-touch-result').style.display = 'flex';
        $('touch-display-text').innerHTML = item.content.replace(/\n/g, '<br>');
        currentTouchData = item; 
    }
}
    
        // åˆå§‹åŒ–è§’è‰²åˆ—è¡¨ (åœ¨æ‰“å¼€è§†å›¾æ—¶è°ƒç”¨)
    function initTouchApp() {
        const select = $('touch-role-select');
        if (select) {
            select.innerHTML = DB.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
    }
    
    // === æŒ‡ä»¤é›† (Command Center) é€»è¾‘ ===

// 1. æ‰“å¼€å¼¹çª—
function openCommandModal() {
    $('cmd-title').value = '';
    $('cmd-content').value = '';
    $('modal-command-add').style.display = 'flex';
}

// 2. ä¿å­˜æŒ‡ä»¤
function saveNewCommand() {
    const title = $('cmd-title').value.trim();
    const content = $('cmd-content').value.trim();
    
    if (!title || !content) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
    
    DB.commands.unshift({
        id: Date.now(),
        title: title,
        content: content
    });
    
    localStorage.setItem('v31_commands', JSON.stringify(DB.commands));
    renderCommandList();
    $('modal-command-add').style.display = 'none';
}

// 3. æ¸²æŸ“åˆ—è¡¨
function renderCommandList() {
    const list = $('command-list-container');
    if (!list) return;
    
    if (DB.commands.length === 0) {
        list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:50px;">æš‚æ— æŒ‡ä»¤<br>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ </div>';
        return;
    }
    
    list.innerHTML = DB.commands.map(cmd => `
        <div style="background:var(--card-bg); border:1px solid var(--glass-border); border-radius:12px; padding:15px; margin-bottom:12px; box-shadow:var(--shadow);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:bold; color:var(--accent-color); font-size:15px;">${cmd.title}</span>
                <button class="btn-icon" style="color:#ff3b30; font-size:14px;" onclick="deleteCommand(${cmd.id})">ğŸ—‘ï¸</button>
            </div>
            <div style="background:var(--input-bg); padding:8px; border-radius:6px; font-size:12px; opacity:0.8; max-height:60px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-bottom:10px; font-family:monospace;">
                ${cmd.content.substring(0, 50)}...
            </div>
            <button class="btn-normal" style="width:100%; height:36px; font-size:13px;" onclick="copyCommand(${cmd.id})">ğŸ“‹ å¤åˆ¶æŒ‡ä»¤</button>
        </div>
    `).join('');
}

// 4. åˆ é™¤æŒ‡ä»¤
function deleteCommand(id) {
    if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡æŒ‡ä»¤å—ï¼Ÿ")) {
        DB.commands = DB.commands.filter(c => c.id !== id);
        localStorage.setItem('v31_commands', JSON.stringify(DB.commands));
        renderCommandList();
    }
}

// 5. å¤åˆ¶æŒ‡ä»¤
function copyCommand(id) {
    const cmd = DB.commands.find(c => c.id === id);
    if (cmd) {
        navigator.clipboard.writeText(cmd.content).then(() => {
            // ç®€å•çš„æç¤ºåé¦ˆ
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "âœ… å·²å¤åˆ¶";
            setTimeout(() => btn.innerText = oldText, 1500);
        }).catch(err => {
            alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        });
    }
}

    // === ä½“é‡ç®¡ç†ç³»ç»Ÿé€»è¾‘ ===

    // 1. æ¸²æŸ“ä¸»ç•Œé¢ (ç»ˆæä¿®å¤ç‰ˆï¼šå¼ºåˆ¶å±‚çº§ + é”™è¯¯ä¿æŠ¤)
    window.renderWeightApp = function() {
        // é˜²æ­¢æ•°æ®åº“æœªåˆå§‹åŒ–
        if (!DB) return console.error("DBæœªåŠ è½½");
        if (!DB.weightLogs) DB.weightLogs = [];

        // ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶æŠŠ Canvas è®¾ä¸ºä¸æŒ¡æ‰‹ï¼ŒæŠŠè¾“å…¥æ¡†æåˆ°æœ€ä¸Šå±‚
        const canvas = document.getElementById('weight-canvas');
        if(canvas) canvas.style.pointerEvents = 'none';
        
        const inputCard = document.querySelector('.weight-input-card');
        if(inputCard) {
            inputCard.style.position = 'relative';
            inputCard.style.zIndex = '1000'; // æåˆ°æœ€é«˜
        }

        // 1. è‡ªåŠ¨å¡«æ—¥æœŸ
        const dateInput = document.getElementById('w-date');
        if (dateInput && !dateInput.value) {
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000))
                                .toISOString().split('T')[0];
            dateInput.value = localDate;
        }
        
                // 2. æ¸²æŸ“åˆ—è¡¨
        const list = document.getElementById('weight-history-list');
        if (!list) return;
        list.innerHTML = '';

        // æŒ‰æ—¥æœŸå€’åº
        const sorted = [...DB.weightLogs].sort((a,b) => new Date(b.date) - new Date(a.date));

        if(sorted.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5;">æš‚æ— è®°å½•</div>';
            try { drawWeightChart([]); } catch(e) {}
            return;
        }

        sorted.forEach((item) => {
            const exTag = item.exercise ? `<div style="font-size:10px; color:var(--accent-color); margin-top:2px;">ğŸƒ ${item.exercise}</div>` : '';

            list.innerHTML += `
                <div class="w-history-item" style="position:relative; z-index:20;">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <div style="font-weight:bold; font-size:15px;">${item.date}</div>
                        ${exTag}
                    </div>
                    
                                        <div style="display:flex; align-items:center; gap:15px;">
                        <div style="font-size:16px; font-weight:bold;">${item.weight} <span style="font-size:12px;">kg</span></div>
                        
                        <div onclick="deleteWeightLog(event, '${item.id}')" 
                             style="color:#ff3b30; cursor:pointer; font-size:24px; padding:10px 15px; margin-right:-15px; font-weight:bold; display:flex; align-items:center; justify-content:center; z-index:1000;">
                             âœ•
                        </div>
                    </div>
                </div>
            `;
        });
            
                    try {
            const chartData = sorted.slice(0, 7).reverse();
            drawWeightChart(chartData);
        } catch(e) {}
    };

    // 2. ä¿å­˜è®°å½•
    window.saveWeightLog = function() {
        console.log("ç‚¹å‡»äº†ä¿å­˜æŒ‰é’®"); // è°ƒè¯•ç”¨
        const date = $('w-date').value;
        const weight = parseFloat($('w-num').value);
        const hasEx = $('w-ex-check').checked;
        const exDesc = $('w-ex-desc').value;

        if(!date || !weight) return alert("è¯·å¡«å†™æ—¥æœŸå’Œä½“é‡");
        
        const existingIdx = DB.weightLogs.findIndex(x => x.date === date);
        const newLog = {
            id: Date.now(),
            date: date,
            weight: weight,
            exercise: hasEx ? (exDesc || 'æ‰“å¡è¿åŠ¨') : null
        };

        if(existingIdx >= 0) {
            if(confirm("ä»Šå¤©å·²ç»è®°å½•è¿‡äº†ï¼Œè¦è¦†ç›–å—ï¼Ÿ")) {
                DB.weightLogs[existingIdx] = newLog;
            } else return;
        } else {
            DB.weightLogs.push(newLog);
        }

        localStorage.setItem('v32_weight', JSON.stringify(DB.weightLogs));
        gainXP(hasEx ? 15 : 5); 
        alert(`è®°å½•æˆåŠŸï¼${hasEx ? 'è¿åŠ¨è¾›è‹¦å•¦ï¼XP+15' : 'XP+5'}`);
        renderWeightApp();
    };
    
        // 3. åˆ é™¤è®°å½•
    window.deleteWeightLog = function(e, id) {
        if(e) { e.stopPropagation(); e.preventDefault(); }
        if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;

        const originalLen = DB.weightLogs.length;
        DB.weightLogs = DB.weightLogs.filter(x => x.id !== Number(id));
        if(DB.weightLogs.length === originalLen) {
             DB.weightLogs = DB.weightLogs.filter(x => String(x.id) !== String(id));
        }

        localStorage.setItem('v32_weight', JSON.stringify(DB.weightLogs));
        renderWeightApp();
    };

            // 4. ç»˜åˆ¶ Canvas æ›²çº¿å›¾ (æ ¸å¿ƒå¯è§†åŒ–)
    function drawWeightChart(data) {
    const canvas = $('weight-canvas');
    if(!canvas) return; // å®¹é”™ä¿æŠ¤
    const ctx = canvas.getContext('2d');
    
    // é€‚é…é«˜æ¸…å± (ä¿®å¤ç‰ˆ)
    const dpr = window.devicePixelRatio || 1;
    // è·å–å®¹å™¨çš„å®é™…å¤§å°
    const rect = canvas.parentElement.getBoundingClientRect();
    
    // 1. è®¾ç½®â€œç‰©ç†åˆ†è¾¨ç‡â€ (ä¸ºäº†æ¸…æ™°ï¼Œä¹˜å€æ•°)
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    
    // 2. ğŸ‘‡ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶è®¾å®šâ€œæ˜¾ç¤ºå¤§å°â€ (CSSåƒç´ ) ğŸ‘‡
    // é˜²æ­¢ç”»å¸ƒæŒ‰ç‰©ç†åˆ†è¾¨ç‡æ¸²æŸ“å¯¼è‡´å˜å¤§
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    // 3. ç¼©æ”¾ç»˜å›¾ä¸Šä¸‹æ–‡
    ctx.scale(dpr, dpr);
    
    // ä½¿ç”¨å®¹å™¨çš„é€»è¾‘å®½é«˜è¿›è¡Œç»˜å›¾è®¡ç®—
    const w = rect.width;
    const h = rect.height;

    ctx.clearRect(0, 0, w, h);
    // ... (åé¢çš„ç»˜å›¾ä»£ç ä¸ç”¨åŠ¨) ...


        if(data.length < 2) {
            ctx.font = "14px sans-serif";
            ctx.fillStyle = "#ccc";
            ctx.fillText("æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç»˜å›¾", w/2 - 60, h/2);
            return;
        }

        // è®¡ç®—æå€¼ä»¥ä¾¿å®šåæ ‡è½´
        const weights = data.map(d => d.weight);
        const minW = Math.min(...weights) - 1;
        const maxW = Math.max(...weights) + 1;
        const range = maxW - minW;

        const padding = 30;
        const graphW = w - padding * 2;
        const graphH = h - padding * 2;
        
                // ç»˜åˆ¶çº¿æ¡
        ctx.beginPath();
        ctx.strokeStyle = "#eebb4d"; // ä¸»é¢˜è‰²
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';

        const points = [];

        data.forEach((d, i) => {
            const x = padding + (i / (data.length - 1)) * graphW;
            const y = h - padding - ((d.weight - minW) / range) * graphH;
            points.push({x, y, val: d.weight, date: d.date.slice(5)}); // sliceå»æ‰å¹´ä»½

            if(i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // ç»˜åˆ¶åŒºåŸŸå¡«å…… (æ¸å˜)
        ctx.lineTo(points[points.length-1].x, h - padding);
        ctx.lineTo(points[0].x, h - padding);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, "rgba(238, 187, 77, 0.3)");
        grad.addColorStop(1, "rgba(255, 255, 255, 0)");
        ctx.fillStyle = grad;
        ctx.fill();

        // ç»˜åˆ¶ç‚¹å’Œæ–‡å­—
        points.forEach(p => {
            // ç‚¹
            ctx.beginPath();
            ctx.fillStyle = "#fff";
            ctx.strokeStyle = "#eebb4d";
            ctx.lineWidth = 2;
            ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
                        // æ•°å€¼
            ctx.fillStyle = "#555";
            ctx.font = "bold 10px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(p.val, p.x, p.y - 10);

            // æ—¥æœŸ
            ctx.fillStyle = "#999";
            ctx.font = "10px sans-serif";
            ctx.fillText(p.date, p.x, h - 5);
        });
    }

    // ==================================================
    // ğŸš¨ æ•‘å‘½è¡¥ä¸ï¼šæŠŠå‡½æ•°æŒ‚åˆ° window ä¸Š (å…³é”®ä¿®å¤) ğŸš¨
    // ==================================================
    // åªæœ‰åŠ äº†ä¸‹é¢è¿™å‡ è¡Œï¼Œä½ çš„ APP æ‰èƒ½ç‚¹å¾—å¼€ï¼
    
    window.openView = openView;
    window.closeView = closeView;
    
    // ä½“é‡ç›¸å…³
    window.renderWeightApp = renderWeightApp;
    window.saveWeightLog = saveWeightLog;
    // deleteWeightLog ä¹‹å‰å·²ç»æ”¹æˆ window.deleteWeightLog äº†ï¼Œè¿™é‡Œä¸ç”¨é‡å¤
    
    // å…¶ä»–å¸¸ç”¨åŠŸèƒ½ (é˜²æ­¢å…¶ä»–æŒ‰é’®ç‚¹ä¸åŠ¨)
    if(typeof toggleTheme !== 'undefined') window.toggleTheme = toggleTheme;
    if(typeof updateDots !== 'undefined') window.updateDots = updateDots;
    if(typeof knockWoodenFish !== 'undefined') window.knockWoodenFish = knockWoodenFish;
    if(typeof openDriftBottle !== 'undefined') window.openDriftBottle = openDriftBottle;
    if(typeof throwBottle !== 'undefined') window.throwBottle = throwBottle;
    if(typeof openFoundBottle !== 'undefined') window.openFoundBottle = openFoundBottle;
window.renderTouchCollection = renderTouchCollection;
window.deleteTouchItem = deleteTouchItem; // åˆ é™¤æŒ‰é’®ä¹Ÿé¡ºä¾¿åŠ ä¸ªä¿é™©
// // === æ‰“å¼€ç½‘å…œï¼ˆæŸ¥çœ‹æ”¶è—ï¼‰ ===
    function openNetBag() {
        $('modal-bottle-net').style.display = 'flex';
        renderNetList();
    }

    // === æ¸²æŸ“ç½‘å…œåˆ—è¡¨ ===
    function renderNetList() {
        const list = $('net-list');
        list.innerHTML = '';

        // ç­›é€‰å‡ºçŠ¶æ€ä¸º 'collected' (å·²æ”¶è—) çš„ç“¶å­
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        const collection = DB.bottles.filter(b => b.status === 'collected').sort((a,b) => b.unlockTime - a.unlockTime);

        if (collection.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:30px; opacity:0.5;">ç½‘å…œæ˜¯ç©ºçš„<br>å¿«ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“æå§</div>';
            return;
        }

        collection.forEach(b => {
            // è·å–å‘é€è€…åå­—
            let senderName = 'ç¥ç§˜äºº';
            if (b.finderId) {
                const c = DB.contacts.find(x => x.id === b.finderId);
                if (c) senderName = c.name;
            }

            // ç”Ÿæˆé¢„è§ˆæ–‡å­—
            const preview = b.reply ? b.reply.substring(0, 20) + '...' : '(æ— å†…å®¹)';
            const dateStr = new Date(b.unlockTime).toLocaleDateString();

            list.innerHTML += `
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.05); cursor:pointer; position:relative;" onclick="reReadBottle(${b.id})">
                    <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.7; margin-bottom:4px;">
                        <span>æ¥è‡ª: ${senderName}</span>
                        <span>${dateStr}</span>
                    </div>
                    <div style="font-weight:bold; color:var(--text-color); font-size:14px;">${preview}</div>
                    
                    <!-- åˆ é™¤æŒ‰é’® -->
                    <div style="position:absolute; right:10px; bottom:10px; z-index:10;" onclick="deleteBottle(event, ${b.id})">ğŸ—‘ï¸</div>
                </div>
            `;
        });
    }

    // === æ–°ç‰ˆï¼šæ‰“æ/æ¸…ç†æµ·é¢ (æ”¾å…¥ç½‘å…œ) ===
    function salvageBottles() {
        if(!DB.bottles) DB.bottles = [];
        
        // 1. æ‰¾å‡ºæµ·é¢ä¸Šâ€œå·²è¯»â€çš„ç“¶å­ (status === 'replied')
        const readyToCollect = DB.bottles.filter(b => b.status === 'replied');
        
        // 2. æ‰¾å‡ºâ€œç³»ç»Ÿç”Ÿæˆçš„æœªè¯»ç“¶å­â€ (åƒåœ¾æ¸…ç†)
        const trash = DB.bottles.filter(b => b.type === 'system');

        if (readyToCollect.length === 0 && trash.length === 0) {
            alert("ğŸŒŠ æµ·é¢ä¸Šå¾ˆå¹²å‡€ï¼Œæ²¡æœ‰å¯æ‰“æçš„ç“¶å­ã€‚\n(åªæœ‰ã€å·²è¯»ã€‘çš„ç“¶å­æ‰èƒ½è¢«æ”¶è—å“¦)");
            return;
        }

        if(!confirm(`ğŸ£ å‡†å¤‡æ”¶ç½‘ï¼\n\nğŸ“¦ æ”¶è—: ${readyToCollect.length} ä¸ªå·²è¯»ç“¶å­\nğŸ§¹ æ¸…ç†: ${trash.length} ä¸ªæœªè¯»ç©ºç“¶\n\nç¡®å®šå—ï¼Ÿ`)) return;

        // æ‰§è¡Œæ“ä½œ
        let count = 0;
        DB.bottles.forEach(b => {
            if (b.status === 'replied') {
                b.status = 'collected'; // æ ‡è®°ä¸ºå·²æ”¶è—
                count++;
            }
        });
        
        // å½»åº•åˆ é™¤ç³»ç»Ÿåƒåœ¾ç“¶ (type=system)
        // ä¿ç•™ï¼šå·²æ”¶è—(collected) + è¿˜æ²¡è¢«äººæ¡åˆ°çš„(floating) + åˆšæ¡åˆ°è¿˜æ²¡è¯»çš„(arrived)
        DB.bottles = DB.bottles.filter(b => b.type !== 'system');

        localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
        
        // åˆ·æ–°ç•Œé¢
        renderBottleSea();
        renderNetList();
        
        
        
        alert(`âœ¨ æˆåŠŸæ‰“æäº† ${count} ä¸ªç“¶å­è¿›ç½‘å…œï¼`);
    }

    // === é‡è¯»ç½‘å…œé‡Œçš„ç“¶å­ ===
    function reReadBottle(bid) {
        const bottle = DB.bottles.find(b => b.id === bid);
        if(bottle) showReadModal(bottle);
    }

// === åˆ é™¤å•ä¸ªç“¶å­ ===
    function deleteBottle(e, bid) {
        e.stopPropagation();
        if(!confirm("è¦æŠŠè¿™ä¸ªç“¶å­æ‰”å›å¤§æµ·(æ°¸ä¹…åˆ é™¤)å—ï¼Ÿ")) return;
        DB.bottles = DB.bottles.filter(b => b.id !== bid);
        localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
        renderNetList();
    }

    // === ä¿®å¤ï¼šæ£€æŸ¥ç³»ç»Ÿç“¶å­ (è¿™å°±æ˜¯ä½ ç¼ºå¤±çš„å‡½æ•°å¤´éƒ¨) ===
    async function checkSystemBottle(bid) {
        // 1. æ‰¾åˆ°ç“¶å­
        const bottle = DB.bottles.find(b => b.id === bid);
        if (!bottle) return;

        // 2. éšæœºé€‰ä¸€ä¸ªè§’è‰²ä½œä¸ºå‘é€è€…
        if (DB.contacts.length === 0) return alert("è¯·å…ˆåœ¨é€šè®¯å½•æ·»åŠ ä¸€ä¸ªè§’è‰²ï¼");
        const randomRole = DB.contacts[Math.floor(Math.random() * DB.contacts.length)];

        // 3. åº”ç”¨çš®è‚¤è®¾ç½®
        if(typeof applyBottleVisuals === 'function') applyBottleVisuals();
        
        // 4. å…ˆæ˜¾ç¤ºå¼¹çª—ï¼ˆæ˜¾ç¤ºåŠ è½½ä¸­ï¼‰
        $('read-bottle-sender').innerText = "???";
        $('read-bottle-time').innerText = "åˆšåˆš";
        $('read-bottle-my-content').innerText = "(è¿™æ˜¯ä¸€ä¸ªç¥ç§˜çš„ç©ºç“¶å­)";
        $('read-bottle-reply').innerText = "æ­£åœ¨è¯»å–ç“¶ä¸­ä¿¡...";
        $('modal-read-bottle').style.display = 'flex';

        try {
            // 5. è°ƒç”¨ AI
            const sysPrompt = `
            ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ï¼š${randomRole.name}ã€‚äººè®¾ï¼š${randomRole.prompt}ã€‚
            åœºæ™¯ï¼šä½ å†™äº†ä¸€ä¸ªæ¼‚æµç“¶æ‰”è¿›æµ·é‡Œï¼Œç°åœ¨è¢«é™Œç”Ÿäººæ¡åˆ°äº†ã€‚
            è¦æ±‚ï¼š
            1. å†™ä¸€æ®µç¬¦åˆä½ äººè®¾çš„â€œå¿ƒäº‹â€ã€â€œåæ§½â€æˆ–â€œç”Ÿæ´»æ„Ÿæ‚Ÿâ€ã€‚
            2. ä¸è¦ç§°å‘¼å¯¹æ–¹ï¼ˆå› ä¸ºä½ ä¸çŸ¥é“æ˜¯è°æ¡åˆ°çš„ï¼‰ã€‚
            3. å£è¯­åŒ–ï¼ŒçŸ­å°ç²¾æ‚ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
            4. è¯­æ°”è¦è‡ªç„¶ï¼Œå°±åƒéšæ‰‹å†™ä¸‹çš„å­—æ¡ã€‚
            `;

            const content = await callAI([
                { role: 'system', content: sysPrompt },
                { role: 'user', content: "ç”Ÿæˆå†…å®¹" }
            ]);

            // 6. æ˜¾ç¤ºç»“æœ
            $('read-bottle-sender').innerText = randomRole.name; 
            $('read-bottle-reply').innerText = content;
            
            // 7. å˜æˆå·²è¯»çŠ¶æ€
            bottle.type = 'user'; // è½¬æ­£ï¼Œå˜æˆæ™®é€šç“¶å­
            bottle.status = 'replied';
            bottle.content = "ï¼ˆæåˆ°çš„ç“¶å­ï¼‰";
            bottle.reply = content;
            bottle.finderId = randomRole.id;
            bottle.unlockTime = Date.now();
            
            localStorage.setItem('v30_bottles', JSON.stringify(DB.bottles));
            renderBottleSea(); // åˆ·æ–°å›¾æ ‡

        } catch (e) {
            alert("API è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚\n" + e.message);
            $('modal-read-bottle').style.display = 'none';
        }
    }
    
    
    // === æŒ‚è½½åˆ° window ===
    window.salvageBottles = salvageBottles;
    window.checkSystemBottle = checkSystemBottle;
    window.openNetBag = openNetBag;
    window.reReadBottle = reReadBottle;
    window.deleteBottle = deleteBottle;
    // === V34: åç‰‡å°ç»„ä»¶é€»è¾‘ ===

// ç¿»è½¬å¡ç‰‡
function flipCard() {
    const container = document.querySelector('.card-widget-container');
    container.classList.toggle('is-flipped');
}

// æ‰“å¼€è®¾ç½®å¼¹çª—
function openCardSettings(side) {
    $('modal-card-settings').style.display = 'flex';
    $('card-edit-side').value = side; // æ ‡è®°æ­£åœ¨ç¼–è¾‘å“ªä¸€é¢

    const data = DB.businessCard[side];
    $('card-settings-title').innerText = `ç¼–è¾‘åç‰‡ (${side === 'front' ? 'æ­£é¢' : 'èƒŒé¢'})`;
    $('card-set-name').value = data.name;
    $('card-set-bio').value = data.bio;
    // æ³¨æ„ï¼šURL å’Œæ–‡ä»¶è¾“å…¥æ¡†æ¯æ¬¡æ‰“å¼€éƒ½æ¸…ç©ºï¼Œé¿å…æ··æ·†
    $('card-set-avatar-url').value = '';
    $('card-set-avatar-file').value = '';
    $('card-set-font-url').value = data.fontUrl;
}

// ä¿å­˜è®¾ç½®
async function saveCardSettings() {
    const side = $('card-edit-side').value;
    const data = DB.businessCard[side];

    // æ›´æ–°æ–‡æœ¬ä¿¡æ¯
    data.name = $('card-set-name').value;
    data.bio = $('card-set-bio').value;
    data.fontUrl = $('card-set-font-url').value.trim();

    // æ›´æ–°å¤´åƒå›¾ç‰‡
    const urlInput = $('card-set-avatar-url').value.trim();
    const fileInput = $('card-set-avatar-file').files[0];
    const avatarKey = `cardAvatar_${side}`; // e.g., 'cardAvatar_front'

    if (fileInput) {
        const compressedBlob = await compressImage(fileInput, 200, 0.8); // å‹ç¼©å¤´åƒ
        await db.settings.put({ key: avatarKey, value: compressedBlob });
    } else if (urlInput) {
        await db.settings.put({ key: avatarKey, value: urlInput });
    }
    
    // ä¿å­˜å¹¶åˆ·æ–°
    localStorage.setItem('v34_card', JSON.stringify(DB.businessCard));
    $('modal-card-settings').style.display = 'none';
    
    await renderBusinessCard(); // é‡æ–°æ¸²æŸ“å¡ç‰‡
}

// æ¸²æŸ“å¡ç‰‡ (æ ¸å¿ƒå‡½æ•°)
async function renderBusinessCard() {
    for (const side of ['front', 'back']) {
        const data = DB.businessCard[side];
        const cardElem = $(`card-${side}`);
        
        // æ¸²æŸ“æ–‡å­—
        $(`card-name-${side}`).innerText = data.name;
        $(`card-bio-${side}`).innerText = data.bio;

        // æ¸²æŸ“å¤´åƒ
        const avatarKey = `cardAvatar_${side}`;
        const avatarSetting = await db.settings.get(avatarKey);
        let avatarSrc = '';
        if (avatarSetting) {
            if (avatarSetting.value instanceof Blob) {
                avatarSrc = URL.createObjectURL(avatarSetting.value);
            } else {
                avatarSrc = avatarSetting.value;
            }
        }
        $(`card-avatar-${side}`).style.backgroundImage = avatarSrc ? `url('${avatarSrc}')` : 'none';

        // åŠ è½½å¹¶åº”ç”¨å­—ä½“
        if (data.fontUrl) {
            const fontName = `custom-card-font-${side}`;
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½è¿‡
            if (!document.getElementById(`font-style-${fontName}`)) {
                const style = document.createElement('style');
                style.id = `font-style-${fontName}`;
                style.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${data.fontUrl}'); }`;
                document.head.appendChild(style);
            }
            cardElem.style.fontFamily = `'${fontName}', sans-serif`;
        } else {
            cardElem.style.fontFamily = ''; // æ¢å¤é»˜è®¤
        }
    }
}

// === ğŸ˜ˆ ä½œå¼ŠåŠŸèƒ½é€»è¾‘ ===
async function attemptCheat() {
    // 1. å¼¹çª—ç¡®è®¤
    if(!confirm("âš ï¸ è­¦å‘Šï¼šçœŸçš„è¦ä½œå¼Šå—ï¼Ÿ\n\næˆåŠŸç‡ï¼š75% (è·å¾—å¤§é‡åŠŸå¾·)\nå¤±è´¥ç‡ï¼š25% (åŠŸå¾·å€’æ‰£ + éšæœºè§’è‰²éª‚ä½ )")) {
        return;
    }

    const roll = Math.random(); // ç”Ÿæˆ 0~1 ä¹‹é—´çš„éšæœºæ•°
    
    // === æˆåŠŸåˆ†æ”¯ (75%) ===
    if (roll < 0.75) {
        const gain = 1000; // æš´å¯Œ
        DB.merit = (DB.merit || 0) + gain;
        localStorage.setItem('v30_merit', DB.merit);
        
        // æ›´æ–°ç•Œé¢
        $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
        
        // è§†è§‰åé¦ˆ
        showToast(`ğŸ˜ˆ ä½œå¼ŠæˆåŠŸï¼åŠŸå¾· +${gain} (è‰¯å¿ƒæœ‰ç‚¹ç—›...)`);
        if(navigator.vibrate) navigator.vibrate([50, 50, 200]); // éœ‡åŠ¨åé¦ˆ
        
    } 
    // === å¤±è´¥åˆ†æ”¯ (25%) ===
    else {
        const penalty = 500; // æƒ©ç½š
        // æ‰£é™¤åŠŸå¾· (æœ€å°‘æ‰£åˆ°0)
        DB.merit = Math.max(0, (DB.merit || 0) - penalty);
        localStorage.setItem('v30_merit', DB.merit);
        $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²
        if (DB.contacts.length === 0) {
            alert(`âš¡ ä½œå¼Šå¤±è´¥ï¼å¤©è°´ï¼åŠŸå¾· -${penalty} (å¿«å»é€šè®¯å½•æ·»åŠ è§’è‰²å§ï¼Œä¸ç„¶æ²¡äººéª‚ä½ )`);
            return;
        }

        // éšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²
        const role = DB.contacts[Math.floor(Math.random() * DB.contacts.length)];
        
        // ç•Œé¢æç¤ºæ­£åœ¨è¿æ¥
        const originalText = $('merit-count').innerText;
        $('merit-count').innerText = `${role.name} æ­£åœ¨èµ¶æ¥...`;

        try {
            // è°ƒç”¨ AI ç”Ÿæˆéª‚äºº/å¤±æœ›çš„è¯
            const prompt = `
            ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt}ã€‚
            æƒ…å¢ƒï¼šç”¨æˆ·åœ¨æ”’åŠŸå¾·çš„æ¸¸æˆé‡Œè¯•å›¾ä½œå¼Šï¼ˆèµ°æ·å¾„ï¼‰è¢«æŠ“äº†ã€‚
            ä»»åŠ¡ï¼šæ ¹æ®ä½ çš„äººè®¾ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œè®­æ–¥ã€å˜²è®½ã€æˆ–è€…è¡¨è¾¾å¤±æœ›ã€‚
            è¦æ±‚ï¼š
            1. å£è¯­åŒ–ï¼Œç®€çŸ­æœ‰åŠ›ï¼ˆ30å­—ä»¥å†…ï¼‰ã€‚
            2. å¦‚æœäººè®¾æ˜¯ä¸¥å‰çš„ï¼Œå°±ç‹ ç‹ éª‚ï¼›å¦‚æœæ˜¯æ¸©æŸ”çš„ï¼Œå°±è¡¨ç¤ºç—›å¿ƒã€‚
            3. ä¸è¦ç”¨ä¹¦é¢è¯­ã€‚
            `;

            const res = await callAI([
                { role: 'system', content: prompt },
                { role: 'user', content: "æˆ‘ä½œå¼Šè¢«æŠ“äº†ï¼Œéª‚æˆ‘ã€‚" }
            ]);

            // å¼¹å‡ºç»“æœ
            alert(`ğŸš« ä½œå¼Šå¤±è´¥ï¼è¢«æŠ“ç°è¡Œï¼\n\nğŸ˜  ${role.name} å¯¹ä½ è¯´ï¼š\nâ€œ${res}â€\n\n(æƒ©ç½šï¼šåŠŸå¾· -${penalty})`);

        } catch (e) {
            alert(`ğŸš« ä½œå¼Šå¤±è´¥ï¼(ç½‘ç»œä¸å¥½ï¼Œä½†åŠŸå¾·è¿˜æ˜¯è¦æ‰£çš„ -${penalty})`);
        } finally {
            // æ¢å¤æ–‡å­—æ˜¾ç¤º
            $('merit-count').innerText = `åŠŸå¾·: ${DB.merit}`;
        }
    }
}

// æŒ‚è½½åˆ° window ä»¥é˜²ä¸‡ä¸€
window.attemptCheat = attemptCheat;

// æŠŠæ–°å‡½æ•°æŒ‚è½½åˆ° windowï¼Œç¡®ä¿ onclick èƒ½æ‰¾åˆ°å®ƒä»¬
window.flipCard = flipCard;
window.openCardSettings = openCardSettings;
window.saveCardSettings = saveCardSettings;
</script>
</body>